<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤©åœ‹å¤§å¯Œç¿ï¼šæ‡‰è¨±ä¹‹åœ°</title>
    
    <!-- å‹•æ…‹ç”Ÿæˆå°ç¾Šå¯Œç¿åœ–ç¤º (Script) -->
    <script>
        (function() {
            var canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            var ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(256, 256, 256, 0, Math.PI * 2);
            ctx.fillStyle = '#FFD700'; 
            ctx.fill();
            ctx.beginPath();
            ctx.arc(256, 256, 230, 0, Math.PI * 2);
            ctx.strokeStyle = '#DAA520'; 
            ctx.lineWidth = 25;
            ctx.stroke();
            ctx.font = "320px serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("ğŸ‘", 256, 290);
            ctx.font = "160px serif";
            ctx.fillText("ğŸ‘‘", 256, 110);
            var iconUrl = canvas.toDataURL('image/png');
            var link = document.createElement('link');
            link.rel = 'icon';
            link.href = iconUrl;
            document.head.appendChild(link);
            var appleLink = document.createElement('link');
            appleLink.rel = 'apple-touch-icon';
            appleLink.href = iconUrl;
            document.head.appendChild(appleLink);
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'adventure-bg': '#E6D5B8', 'adventure-paper': '#F3E5AB', 'adventure-ink': '#3E2723',
              'adventure-gold': '#B8860B', 'adventure-red': '#8B0000', 'adventure-sea': '#87A8B3',
            },
            fontFamily: { 'rounded': ['"Zen Maru Gothic"', 'sans-serif'], 'serif': ['"Times New Roman"', 'serif'] },
            boxShadow: { 'paper': '2px 3px 5px rgba(62, 39, 35, 0.3)', 'deck': '2px 2px 0 #3E2723, 4px 4px 0 #3E2723, 6px 6px 10px rgba(0,0,0,0.3)' }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="importmap">
    { "imports": { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "lucide-react": "https://esm.sh/lucide-react@0.263.1" } }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #E6D5B8; color: #3E2723; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #E0C097; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #8B4513; border-radius: 4px; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .vintage-border { border: 2px solid #8B4513; outline: 2px dashed #BCAAA4; outline-offset: -6px; }
        .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dice-scene { width: 60px; height: 60px; perspective: 400px; }
        .dice { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s ease-out; }
        .dice.rolling { animation: roll 0.5s infinite linear; }
        .dice-face { position: absolute; width: 60px; height: 60px; background: #FFF; border: 2px solid #E0E0E0; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; }
        .dot { width: 10px; height: 10px; background: #333; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5); }
        .face-1 { transform: rotateY(0deg) translateZ(30px); } .face-2 { transform: rotateY(90deg) translateZ(30px); } .face-3 { transform: rotateY(180deg) translateZ(30px); }
        .face-4 { transform: rotateY(-90deg) translateZ(30px); } .face-5 { transform: rotateX(90deg) translateZ(30px); } .face-6 { transform: rotateX(-90deg) translateZ(30px); }
        .dots-1 { justify-content: center; } .dots-2 { justify-content: space-between; padding: 10px; } .dots-2 .dot:nth-child(2) { align-self: flex-end; }
        .dots-3 { justify-content: space-between; padding: 10px; } .dots-3 .dot:nth-child(2) { align-self: center; } .dots-3 .dot:nth-child(3) { align-self: flex-end; }
        .dots-4, .dots-5, .dots-6 { display: grid; grid-template-columns: 1fr 1fr; padding: 10px; gap: 8px; } .dots-5 .dot:nth-child(5) { grid-column: 1 / span 2; justify-self: center; align-self: center; }
        @keyframes roll { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(360deg) rotateY(360deg); } }
        
        .filter-p1 { filter: brightness(110%); } 
        .filter-p2 { filter: sepia(0.5) hue-rotate(-30deg) saturate(1.2); } 
        .filter-p3 { filter: sepia(0.8) hue-rotate(350deg) saturate(1.5); } 
        .filter-p4 { filter: sepia(0.6) hue-rotate(20deg) saturate(1.8); } 
        
        /* ä½¿ç”¨ invert(100%) åè½‰é¡è‰²ï¼Œgrayscale(100%) å»é™¤é›œè‰²ï¼Œç¢ºä¿é»‘å…¬ç¾Šæ˜¯é»‘è‰²çš„ */
        .filter-cpu { filter: grayscale(100%) invert(100%); } 
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, Heart, Star, MessageCircle, RefreshCw, Check, X, Dices, AlertCircle, PauseCircle, Home, MapPin, Sword, Cross, Scroll, Tent, Footprints, Loader, HelpCircle, AlertTriangle, Play, Info, Send, Hammer, Castle, Flag, WifiOff, Sun, CloudRain, Flame, ExternalLink, Pointer, Facebook, Instagram, AtSign, Mail, Lock, User, Users, Crown, Skull, LogOut, ArrowUpLeft, ArrowUpRight } from 'lucide-react';

        // ==========================================
        // 0. CONFIGURATION
        // ==========================================
        const MAP_IMAGE_URL = "https://images.unsplash.com/photo-1524661135-423995f22d0b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1974&q=80";

        // ==========================================
        // 1. DATA & CONSTANTS
        // ==========================================
        const BIBLE_DB = {
            "å‰µä¸–è¨˜ (æ‡‰è¨±)": [
                { verse: "12:7", text: "è€¶å’Œè¯å‘äºä¼¯è˜­é¡¯ç¾ï¼Œèªªï¼šã€Œæˆ‘è¦æŠŠé€™åœ°è³œçµ¦ä½ çš„å¾Œè£”ã€‚ã€" },
                { verse: "13:14-15", text: "è€¶å’Œè¯å°äºä¼¯è˜­èªªï¼šã€Œå¾ä½ æ‰€åœ¨çš„åœ°æ–¹ï¼Œä½ èˆ‰ç›®å‘æ±è¥¿å—åŒ—è§€çœ‹ï¼›å‡¡ä½ æ‰€çœ‹è¦‹çš„ä¸€åˆ‡åœ°ï¼Œæˆ‘éƒ½è¦è³œçµ¦ä½ å’Œä½ çš„å¾Œè£”ï¼Œç›´åˆ°æ°¸é ã€‚ã€" },
                { verse: "15:18", text: "ç•¶é‚£æ—¥ï¼Œè€¶å’Œè¯èˆ‡äºä¼¯è˜­ç«‹ç´„ï¼Œèªªï¼šã€Œæˆ‘å·²è³œçµ¦ä½ çš„å¾Œè£”ï¼Œå¾åŸƒåŠæ²³ç›´åˆ°å¹¼ç™¼æ‹‰åº•å¤§æ²³ä¹‹åœ°ã€‚ã€" },
                { verse: "17:8", text: "æˆ‘è¦å°‡ä½ ç¾åœ¨å¯„å±…çš„åœ°ï¼Œå°±æ˜¯è¿¦å—å…¨åœ°ï¼Œè³œçµ¦ä½ å’Œä½ çš„å¾Œè£”æ°¸é ç‚ºæ¥­ï¼Œæˆ‘ä¹Ÿå¿…ä½œä»–å€‘çš„ç¥ã€‚" }
            ],
            "æ°‘æ•¸è¨˜ (ä¿¡å¿ƒ)": [
                { verse: "13:30", text: "è¿¦å‹’åœ¨æ‘©è¥¿é¢å‰å®‰æ’«ç™¾å§“ï¼Œèªªï¼šã€Œæˆ‘å€‘ç«‹åˆ»ä¸Šå»å¾—é‚£åœ°å§ï¼æˆ‘å€‘è¶³èƒ½å¾—å‹ã€‚ã€" },
                { verse: "14:7-8", text: "æˆ‘å€‘æ‰€çªºæ¢ã€ç¶“éä¹‹åœ°æ˜¯æ¥µç¾ä¹‹åœ°ã€‚è€¶å’Œè¯è‹¥å–œæ‚…æˆ‘å€‘ï¼Œå°±å¿…é ˜æˆ‘å€‘é€²å…¥é‚£åœ°ï¼ŒæŠŠåœ°è³œçµ¦æˆ‘å€‘ã€‚" },
                { verse: "14:9", text: "ä½†ä½ å€‘ä¸å¯èƒŒå›è€¶å’Œè¯ï¼Œä¹Ÿä¸è¦æ€•é‚£åœ°çš„å±…æ°‘...æœ‰è€¶å’Œè¯èˆ‡æˆ‘å€‘åŒåœ¨ï¼Œä¸è¦æ€•ä»–å€‘ï¼" }
            ],
            "ç”³å‘½è¨˜ (é å‚™)": [
                { verse: "1:8", text: "å¦‚ä»Šæˆ‘å°‡é€™åœ°æ“ºåœ¨ä½ å€‘é¢å‰ï¼›ä½ å€‘è¦é€²å»å¾—é€™åœ°ï¼Œå°±æ˜¯è€¶å’Œè¯å‘ä½ å€‘åˆ—ç¥–...èµ·èª“æ‡‰è¨±è³œçµ¦ä»–å€‘å’Œä»–å€‘å¾Œè£”çš„åœ°ã€‚" },
                { verse: "1:21", text: "çœ‹å“ªï¼Œè€¶å’Œè¯â”€ä½ çš„ç¥å·²å°‡é‚£åœ°æ“ºåœ¨ä½ é¢å‰ï¼Œä½ è¦ç…§è€¶å’Œè¯...æ‰€èªªçš„ä¸Šå»å¾—é‚£åœ°ç‚ºæ¥­ï¼›ä¸è¦æ‡¼æ€•ï¼Œä¹Ÿä¸è¦é©šæƒ¶ã€‚" },
                { verse: "6:3", text: "ä»¥è‰²åˆ—å•Šï¼Œä½ è¦è½ï¼Œè¦è¬¹å®ˆéµè¡Œï¼Œä½¿ä½ å¯ä»¥åœ¨é‚£æµå¥¶èˆ‡èœœä¹‹åœ°å¾—ä»¥äº«ç¦ï¼Œæ­£å¦‚è€¶å’Œè¯â”€ä½ åˆ—ç¥–çš„ç¥æ‰€æ‡‰è¨±ä½ çš„ã€‚" },
                { verse: "11:11-12", text: "ä½ å€‘è¦éå»å¾—ç‚ºæ¥­çš„é‚£åœ°ï¼Œä¹ƒæ˜¯æœ‰å±±æœ‰è°·ã€é›¨æ°´æ»‹æ½¤ä¹‹åœ°ï¼Œæ˜¯è€¶å’Œè¯â”€ä½ ç¥æ‰€çœ·é¡§çš„ã€‚" },
                { verse: "11:24", text: "å‡¡ä½ å€‘è…³æŒæ‰€è¸ä¹‹åœ°éƒ½å¿…æ­¸ä½ å€‘...éƒ½è¦ä½œä½ å€‘çš„å¢ƒç•Œã€‚" },
                { verse: "31:8", text: "è€¶å’Œè¯å¿…åœ¨ä½ å‰é¢è¡Œï¼›ä»–å¿…èˆ‡ä½ åŒåœ¨ï¼Œå¿…ä¸æ’‡ä¸‹ä½ ï¼Œä¹Ÿä¸ä¸Ÿæ£„ä½ ã€‚" }
            ],
            "ç´„æ›¸äºè¨˜ (å¾—å‹)": [
                { verse: "1:2", text: "ç¾åœ¨ä½ è¦èµ·ä¾†ï¼Œå’Œçœ¾ç™¾å§“éé€™ç´„æ—¦æ²³ï¼Œå¾€æˆ‘æ‰€è¦è³œçµ¦ä»¥è‰²åˆ—äººçš„åœ°å»ã€‚" },
                { verse: "1:3", text: "å‡¡ä½ å€‘è…³æŒæ‰€è¸ä¹‹åœ°ï¼Œæˆ‘éƒ½ç…§è‘—æˆ‘æ‰€æ‡‰è¨±æ‘©è¥¿çš„è©±è³œçµ¦ä½ å€‘äº†ã€‚" },
                { verse: "1:6", text: "ä½ ç•¶å‰›å¼·å£¯è†½ï¼å› ç‚ºä½ å¿…ä½¿é€™ç™¾å§“æ‰¿å—é‚£åœ°ç‚ºæ¥­ï¼Œå°±æ˜¯æˆ‘å‘ä»–å€‘åˆ—ç¥–èµ·èª“æ‡‰è¨±è³œçµ¦ä»–å€‘çš„åœ°ã€‚" },
                { verse: "1:9", text: "æˆ‘è±ˆæ²’æœ‰å©å’ä½ å—ï¼Ÿä½ ç•¶å‰›å¼·å£¯è†½ï¼ä¸è¦æ‡¼æ€•ï¼Œä¹Ÿä¸è¦é©šæƒ¶ï¼›å› ç‚ºä½ ç„¡è«–å¾€å“ªè£¡å»ï¼Œè€¶å’Œè¯â”€ä½ çš„ç¥å¿…èˆ‡ä½ åŒåœ¨ã€‚" },
                { verse: "21:43", text: "é€™æ¨£ï¼Œè€¶å’Œè¯å°‡å¾å‰å‘ä»–å€‘åˆ—ç¥–èµ·èª“æ‰€æ‡‰è¨±çš„å…¨åœ°è³œçµ¦ä»¥è‰²åˆ—äººï¼Œä»–å€‘å°±å¾—äº†ç‚ºæ¥­ï¼Œä½åœ¨å…¶ä¸­ã€‚" },
                { verse: "21:45", text: "è€¶å’Œè¯æ‡‰è¨±è³œç¦çµ¦ä»¥è‰²åˆ—å®¶ä½³è©±ï¼Œä¸€å¥ä¹Ÿæ²’æœ‰è½ç©ºï¼Œéƒ½æ‡‰é©—äº†ã€‚" },
                { verse: "24:13", text: "æˆ‘è³œçµ¦ä½ å€‘åœ°åœŸï¼Œéä½ å€‘æ‰€ä¿®æ²»çš„ï¼›æˆ‘è³œçµ¦ä½ å€‘åŸé‚‘ï¼Œéä½ å€‘æ‰€å»ºé€ çš„ã€‚" }
            ]
        };
        const BIBLE_BOOKS = Object.keys(BIBLE_DB);

        const PLAYER_CONFIGS = [
            { id: 0, name: 'ç™½ç¶¿ç¾Š', icon: 'ğŸ‘', color: 'text-indigo-600', bg: 'bg-indigo-100', border: 'border-indigo-400', filter: 'filter-p1' },
            { id: 1, name: 'èŠ±æ–‘ç¾Š', icon: 'ğŸ', color: 'text-amber-600', bg: 'bg-amber-100', border: 'border-amber-400', filter: 'filter-p2' },
            { id: 2, name: 'å°é¹¿', icon: 'ğŸ¦Œ', color: 'text-emerald-600', bg: 'bg-emerald-100', border: 'border-emerald-400', filter: 'filter-p3' },
            { id: 3, name: 'é§±é§', icon: 'ğŸª', color: 'text-orange-600', bg: 'bg-orange-100', border: 'border-orange-400', filter: 'filter-p4' }
        ];

        const CPU_CONFIG = { id: 99, name: 'é»‘å…¬ç¾Š', icon: 'ğŸ', color: 'text-purple-600', bg: 'bg-purple-100', border: 'border-purple-400', filter: 'filter-cpu' };

        // Adjusted win conditions and starting values for longer gameplay
        const STARTING_FAITH = 3000; 
        const WIN_CONDITION_FAITH = 15000;
        const WIN_CONDITION_CITIES = 12;
        const WIN_CONDITION_ALTARS = 7;
        const PASS_GO_REWARD = 800;

        // --- Expanded Blessing Verses ---
        const BLESSING_VERSES = [
            { text: "ä½ ç•¶å‰›å¼·å£¯è†½ï¼ä¸è¦æ‡¼æ€•ï¼Œä¹Ÿä¸è¦é©šæƒ¶ã€‚", ref: "ç´„æ›¸äºè¨˜ 1:9" },
            { text: "æµæ·šæ’’ç¨®çš„ï¼Œå¿…æ­¡å‘¼æ”¶å‰²ã€‚", ref: "è©©ç¯‡ 126:5" },
            { text: "è€¶å’Œè¯æ˜¯æˆ‘çš„ç‰§è€…ï¼Œæˆ‘å¿…ä¸è‡´ç¼ºä¹ã€‚", ref: "è©©ç¯‡ 23:1" },
            { text: "å‡¡å‹è‹¦æ“”é‡æ“”çš„äººå¯ä»¥åˆ°æˆ‘é€™è£¡ä¾†ï¼Œæˆ‘å°±ä½¿ä½ å€‘å¾—å®‰æ¯ã€‚", ref: "é¦¬å¤ªç¦éŸ³ 11:28" },
            { text: "æˆ‘ç•™ä¸‹å¹³å®‰çµ¦ä½ å€‘ï¼›æˆ‘å°‡æˆ‘çš„å¹³å®‰è³œçµ¦ä½ å€‘ã€‚", ref: "ç´„ç¿°ç¦éŸ³ 14:27" },
            { text: "é è‘—é‚£åŠ çµ¦æˆ‘åŠ›é‡çš„ï¼Œå‡¡äº‹éƒ½èƒ½åšã€‚", ref: "è…“ç«‹æ¯”æ›¸ 4:13" },
            { text: "æ‡‰ç•¶ä¸€ç„¡æ›æ…®ï¼Œåªè¦å‡¡äº‹è—‰è‘—ç¦±å‘Šã€ç¥ˆæ±‚ï¼Œå’Œæ„Ÿè¬ï¼Œå°‡ä½ å€‘æ‰€è¦çš„å‘Šè¨´ç¥ã€‚", ref: "è…“ç«‹æ¯”æ›¸ 4:6" },
            { text: "ç¥è‹¥å¹«åŠ©æˆ‘å€‘ï¼Œèª°èƒ½æ•µæ“‹æˆ‘å€‘å‘¢ï¼Ÿ", ref: "ç¾…é¦¬æ›¸ 8:31" }
        ];

        const FATE_PROMPTS = [
            "å‘½é‹çš„é½’è¼ªæ­£åœ¨è½‰å‹•... âš™ï¸",
            "æ˜¯å—å“ªé‚„æ˜¯éµªé¶‰ï¼ŸğŸ•Šï¸",
            "é€™æ¢è·¯é€šå¾€æ› é‡é‚„æ˜¯è¿¦å—ï¼ŸğŸŒµ",
            "å¤©ä½¿æ­£åœ¨æŸ¥é–±ç”Ÿå‘½å†Š... ğŸ“–",
            "æ­¤åˆ»ï¼Œä½ çš„ä¿¡å¿ƒæœ‰å¤šå°‘ï¼Ÿâš–ï¸",
            "æ˜¯ç¦æ˜¯ç¦ï¼Œä¸»éƒ½çŸ¥é“ã€‚ğŸ™",
            "é€™æœƒæ˜¯ä¿¡å¿ƒçš„è©¦ç…‰å—ï¼ŸğŸ”¥"
        ];

        const CHANCE_PROMPTS = [
            "å¤©ä¸Šæ‰ä¸‹ä¾†çš„ç¦®ç‰©ï¼ŸğŸ",
            "æ©å…¸çš„é–€æ‰“é–‹äº†ï¼ğŸšª",
            "æˆ–è¨±æ˜¯äº”é¤…äºŒé­šçš„å¥‡è¹Ÿï¼ŸğŸŸ",
            "å¿«æŠŠä½ çš„å™¨çš¿æº–å‚™å¥½ï¼ğŸº",
            "é€™ä¸€æ­¥ï¼Œå°‡æ±ºå®šæœªä¾†ï¼âœ¨",
            "æŠ“ä½é€™å€‹ç¥è¹Ÿæ™‚åˆ»ï¼ğŸŒˆ",
            "ä½ çš„æ¯å­æº–å‚™å¥½æ¥ç¦äº†å—ï¼ŸğŸ·"
        ];

        const FATE_CARDS = [
          { type: 'bad', text: "ç™¾å§“åœ¨æ› é‡ç™¼æ€¨è¨€ï¼Œä¿¡å¿ƒå‹•æ–ã€‚", amount: -50, freeze: false, title: "æ€¨è¨€çš„ç¶²ç¾…" },
          { type: 'bad', text: "è£½é€ äº†é‡‘ç‰›çŠ¢ï¼Œå¾—ç½ªäº†ç¥ã€‚", amount: -80, freeze: true, title: "å¶åƒçš„è©¦æ¢" },
          { type: 'good', text: "å¤©é™å—å“ªï¼Œæ¯æ—¥ä¾›æ‡‰ã€‚", amount: 50, freeze: false, title: "ç¥çš„ä¾›æ‡‰" },
          { type: 'good', text: "é›²æŸ±ç«æŸ±æ—¥å¤œå¼•é ˜ã€‚", amount: 80, freeze: false, title: "ç¥çš„åŒåœ¨" },
        ];
        const CHANCE_CARDS = [
          { type: 'quiz', q: "ä»¥è‰²åˆ—äººç¹è€¶åˆ©å“¥å¹¾å¤©ï¼Ÿ", options: ["3å¤©", "7å¤©"], ans: 1, reward: 80 },
          { type: 'quiz', q: "èª°åœ¨ç´„æ—¦æ²³æ–½æ´—ï¼Ÿ", options: ["å½¼å¾—", "ç´„ç¿°"], ans: 1, reward: 80 },
          { type: 'event_bad', title: "é‡åˆ°å·¨äºº", text: "çœ‹è¦‹äºç´æ—äººé«˜å¤§ï¼Œå¿ƒè£¡å®³æ€•ã€‚", amount: -40 },
          { type: 'event_bad', title: "ç‘ªæ‹‰è‹¦æ°´", text: "æ°´æ˜¯è‹¦çš„ï¼Œç„¡æ³•é£²ç”¨ã€‚", amount: -30 },
        ];
        const INITIAL_BOARD_MAP = [
          { id: 0, type: 'start', label: 'éç´„æ—¦æ²³', name: 'é€²è¿¦å—', color: 'from-yellow-100 to-yellow-200', icon: <Footprints size={20} />, ref: "ç´„æ›¸äºè¨˜ 3:17ï¼šç™¾å§“åœ¨ä¹¾åœ°ä¸Šèµ°éç´„æ—¦æ²³ï¼Œç‚ºäº†é€²å…¥ç¥æ‰€æ‡‰è¨±ä¹‹åœ°ã€‚" },
          { id: 1, type: 'city', label: 'åŸæ± ', name: 'å‰ç”²', price: 100, rent: 20, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 4:19ï¼šéç´„æ—¦æ²³å¾Œçš„ç¬¬ä¸€å€‹ç‡Ÿåœ°ï¼Œåœ¨æ­¤ç«‹åäºŒå¡ŠçŸ³é ­ç‚ºè¨˜ï¼Œæ»¾å»åŸƒåŠçš„ç¾è¾±ã€‚" },
          { id: 2, type: 'fate', label: 'å‘½é‹', name: 'æ› é‡', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 3, type: 'city', label: 'åŸæ± ', name: 'è€¶åˆ©å“¥', price: 120, rent: 25, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 6:20ï¼šç™¾å§“å‘¼å–Šï¼ŒåŸç‰†å€’å¡Œï¼Œä»¥è‰²åˆ—äººå°‡åŸå¥ªå–ã€‚é€™æ˜¯è¿¦å—åœ°çš„ç¬¬ä¸€å ´å‹åˆ©ã€‚" },
          { id: 4, type: 'bible', label: 'è®€ç¶“', name: 'æœƒå¹•', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 5, type: 'city', label: 'åŸæ± ', name: 'è‰¾åŸ', price: 140, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 8:28ï¼šåœ¨äºå‰²è°·è™•ç†ç½ªçš„å•é¡Œå¾Œï¼Œç´„æ›¸äºè¨­ä¼å…µé‡æ–°æ”»ä½”æ­¤åŸï¼Œå°‡å…¶ç„šç‡’ã€‚" },
          { id: 6, type: 'event_jesus', label: 'æ©å…¸', name: 'åŠ åˆ©åˆ©æµ·', color: 'from-cyan-50 to-cyan-100', icon: <Cross size={18} /> },
          { id: 7, type: 'city', label: 'åŸæ± ', name: 'åŸºé', price: 160, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 9:3ï¼šåŸºéäººæ‡¼æ€•ä»¥è‰²åˆ—äººï¼Œç”¨è¨ˆæ±‚å’Œï¼Œæœ€çµ‚æˆç‚ºç‚ºæœƒå¹•åŠˆæŸ´æŒ‘æ°´çš„äººã€‚" },
          { id: 8, type: 'chance', label: 'æ©Ÿæœƒ', name: 'æ™ºæ…§é–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 9, type: 'city', label: 'åŸæ± ', name: 'äºé›…å´™', price: 150, rent: 30, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 10:12ï¼šç´„æ›¸äºç¦±å‘Šç¥ï¼Œæ—¥é ­åœ¨åŸºéåœç•™ï¼Œæœˆäº®åœ¨äºé›…å´™è°·æ­¢ä½ï¼Œç›´åˆ°å‹äº†ä»‡æ•µã€‚" },
          { id: 10, type: 'prayer', label: 'ç¦±å‘Š', name: 'å®¢è¥¿é¦¬å°¼', color: 'from-orange-50 to-orange-100', icon: <MessageCircle size={18} /> },
          { id: 11, type: 'city', label: 'é‡é®', name: 'å¸Œä¼¯å´™', price: 300, rent: 60, owner: null, level: 0, color: 'from-rose-50 to-rose-100', icon: <Home size={18} />, ref: "ç´„æ›¸äºè¨˜ 14:13ï¼šè¿¦å‹’å°ˆå¿ƒè·Ÿå¾ç¥ï¼Œé›–å…«åäº”æ­²ä»å¼·å£¯ï¼Œå¾—æ­¤å±±åœ°ç‚ºæ¥­ã€‚äºä¼¯æ‹‰ç½•ä¹Ÿæ›¾åœ¨æ­¤ç¯‰å£‡ã€‚" },
          { id: 12, type: 'event_paul', label: 'äº‹ä»¶', name: 'å¤§é¦¬è‰²è·¯', color: 'from-indigo-50 to-indigo-100', icon: <MapPin size={18} /> },
          { id: 13, type: 'city', label: 'åŸæ± ', name: 'åº•ç’§', price: 200, rent: 40, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 15:15ï¼šåŸååŸºåˆ—è¥¿å¼—ï¼Œè¿¦å‹’çš„å¥³å©¿ä¿„é™€è¶æ”»ä¸‹æ­¤åŸï¼Œä¸¦å¨¶äº†è¿¦å‹’çš„å¥³å…’æŠ¼æ’’ã€‚" },
          { id: 14, type: 'bible', label: 'è®€ç¶“', name: 'åº‡å“©äº', color: 'from-blue-50 to-blue-100', icon: <Scroll size={18} /> },
          { id: 15, type: 'city', label: 'åŸæ± ', name: 'å¤ç‘£', price: 180, rent: 35, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 11:10ï¼šå¤ç‘£ç´ ä¾†æ˜¯è«¸åœ‹ä¹‹é¦–ã€‚ç´„æ›¸äºåœ¨ç±³å€«æ°´é‚Šæ“Šæ•—åŒ—æ–¹è«¸ç‹è¯è»ï¼Œç„šç‡’äº†å¤ç‘£ã€‚" },
          { id: 16, type: 'fate', label: 'å‘½é‹', name: 'é¢¨æµª', color: 'from-purple-100 to-purple-200', icon: <AlertTriangle size={18} /> },
          { id: 17, type: 'city', label: 'åŸæ± ', name: 'ç¤ºåŠ', price: 220, rent: 45, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 24:1ï¼šç´„æ›¸äºæ™šå¹´åœ¨æ­¤èšé›†ç™¾å§“ï¼Œåœ¨ç¥é¢å‰ç«‹ç´„ï¼Œå®£å‘Šã€Œè‡³æ–¼æˆ‘å’Œæˆ‘å®¶ï¼Œæˆ‘å€‘å¿…å®šäº‹å¥‰è€¶å’Œè¯ã€ã€‚" },
          { id: 18, type: 'chance', label: 'æ©Ÿæœƒ', name: 'ä¿¡å¿ƒé–€', color: 'from-yellow-50 to-yellow-100', icon: <HelpCircle size={18} /> },
          { id: 19, type: 'city', label: 'åŸæ± ', name: 'ç¤ºç¾…', price: 250, rent: 50, owner: null, level: 0, color: 'from-amber-50 to-amber-100', icon: <Tent size={18} />, ref: "ç´„æ›¸äºè¨˜ 18:1ï¼šä»¥è‰²åˆ—å…¨æœƒçœ¾èšé›†åœ¨æ­¤è¨­ç«‹æœƒå¹•ã€‚åœŸåœ°åˆ†é…å°šæœªçµæŸçš„æ”¯æ´¾ä¹Ÿåœ¨æ­¤æ‹ˆé¬®åˆ†åœ°ã€‚" },
        ];
        
        const getGridPosition = (index) => { if (index <= 3) return { x: index, y: 0 }; if (index <= 9) return { x: 3, y: index - 3 }; if (index <= 13) return { x: 3 - (index - 10), y: 7 }; if (index <= 19) return { x: 0, y: 7 - (index - 13) }; return { x: 0, y: 0 }; };

        // --- Helper Components ---
        const Dice3D = ({ value, rolling }) => {
            const getTransform = (val) => { const map = ['rotateX(0) rotateY(0)', 'rotateX(0) rotateY(0)', 'rotateY(-90deg)', 'rotateY(180deg)', 'rotateY(90deg)', 'rotateX(-90deg)', 'rotateX(90deg)']; return map[val] || map[1]; };
            return (<div className="dice-scene"><div className={`dice ${rolling ? 'rolling' : ''}`} style={{ transform: rolling ? '' : getTransform(value) }}><div className="dice-face face-1 dots-1"><div className="dot" style={{width:16, height:16, background:'#D32F2F'}}></div></div><div className="dice-face face-2 dots-2"><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-3 dots-3"><div className="dot"></div><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-4 dots-4"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-5 dots-5"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div><div className="dice-face face-6 dots-6"><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div><div className="dot"></div></div></div></div>);
        };
        const Deck = ({ type, active, onClick, prompt }) => {
            const isFate = type === 'fate';
            return (<div onClick={active ? onClick : undefined} className={`w-20 h-28 rounded-lg border-2 flex flex-col items-center justify-center cursor-pointer transition-all duration-300 relative ${isFate ? "bg-[#8E44AD] border-[#6C3483]" : "bg-[#F39C12] border-[#D35400]"} ${active ? 'z-50' : 'opacity-80 shadow-deck z-10'}`}><div className="absolute inset-1 border border-white/30 border-dashed rounded pointer-events-none"></div><div className="mb-1">{isFate ? <AlertTriangle size={20} className="text-white"/> : <HelpCircle size={20} className="text-white"/>}</div><div className="text-white font-black text-sm tracking-widest writing-vertical-rl">{isFate?"å‘½é‹":"æ©Ÿæœƒ"}</div><div className={`absolute -bottom-1 -right-1 w-full h-full rounded-lg -z-10 ${isFate ? "bg-[#4A235A]" : "bg-[#A04000]"}`}></div>{active && <div className="absolute -top-14 left-1/2 -translate-x-1/2 bg-[#FFF8E1] border-2 border-[#8B4513] text-[#8B4513] text-[10px] px-3 py-2 rounded-xl whitespace-nowrap shadow-lg flex items-center gap-1 font-bold z-30"><Pointer size={12} /> {prompt || "è«‹é»æ“Šç‰Œå †"}</div>}</div>);
        };
        
        const BackgroundMap = () => (
            <div className="fixed inset-0 w-full h-full z-[-1] overflow-hidden pointer-events-none bg-[#E6D5B8]">
                {/* User Map Image Layer */}
                <img 
                    src={MAP_IMAGE_URL} 
                    className="w-full h-full object-cover opacity-80 mix-blend-multiply"
                    alt="Game Map"
                    style={{ filter: 'sepia(0.3) contrast(1.1)' }}
                />
                {/* Vintage Texture Overlay */}
                <div className="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-[#3E2723]/20 pointer-events-none"></div>
                <svg width="100%" height="100%" className="absolute inset-0 opacity-20 pointer-events-none">
                    <filter id="paper-texture">
                        <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5"/>
                        <feDiffuseLighting lightingColor="#E6D5B8" surfaceScale="2">
                            <feDistantLight azimuth="45" elevation="60"/>
                        </feDiffuseLighting>
                    </filter>
                    <rect width="100%" height="100%" filter="url(#paper-texture)"/>
                </svg>
            </div>
        );
        
        const GameButton = ({ onClick, disabled, color = "blue", icon: Icon, children, className }) => {
            const colors = { blue: "bg-blue-500", amber: "bg-amber-500", indigo: "bg-indigo-500", red: "bg-red-500", purple: "bg-purple-500", gray: "bg-gray-500", orange: "bg-orange-500", cyan: "bg-cyan-500", green: "bg-green-500" };
            return <button type="button" onClick={onClick} disabled={disabled} className={`w-full py-3.5 rounded-lg font-bold transition-all flex items-center justify-center gap-2 ${disabled ? "bg-gray-300 cursor-not-allowed" : `${colors[color]} text-white shadow-md active:scale-95`} ${className || ''}`}>{Icon && <Icon size={20}/>} {children}</button>;
        };

        const CardFlip = ({ frontTitle, frontColor, backContent, icon, textColor="text-[#3E2723]" }) => {
            const [isFlipped, setIsFlipped] = useState(false);
            return (<div className="relative w-full h-[450px] perspective-1000 cursor-pointer group" onClick={() => !isFlipped && setIsFlipped(true)}><div className={`relative w-full h-full transition-all duration-700 transform-style-3d ${isFlipped ? 'rotate-y-180' : ''}`}><div className={`absolute w-full h-full bg-gradient-to-br ${frontColor} rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center backface-hidden border-8 border-[#3E2723]`}><div className="border-4 border-dashed border-[#3E2723]/30 w-[90%] h-[90%] absolute rounded-lg pointer-events-none"></div><div className="bg-[#3E2723] p-6 rounded-full text-[#F3E5AB] mb-6 shadow-md">{icon}</div><h3 className={`text-3xl font-black ${textColor} tracking-[0.2em] uppercase font-serif drop-shadow-sm`}>{frontTitle}</h3><div className={`absolute bottom-12 ${textColor} opacity-80 text-sm font-bold`}>é»æ“Šç¿»é–‹</div></div><div className="absolute w-full h-full bg-[#F3E5AB] rounded-xl shadow-[0_10px_20px_rgba(0,0,0,0.3)] flex flex-col items-center justify-center p-8 backface-hidden rotate-y-180 border-8 border-[#8B4513] overflow-y-auto bg-[url('https://www.transparenttextures.com/patterns/paper.png')]">{backContent}</div></div></div>);
        };

        // --- Event Views ---
        const BibleReader = ({ onComplete }) => {
            const [selection] = useState(() => {
                const books = Object.keys(BIBLE_DB);
                const randomBookName = books[Math.floor(Math.random() * books.length)];
                const allVerses = BIBLE_DB[randomBookName];
                const shuffled = [...allVerses].sort(() => 0.5 - Math.random());
                const selectedVerses = shuffled.slice(0, 7).sort((a, b) => {
                   const [c1, v1] = a.verse.split(':').map(Number);
                   const [c2, v2] = b.verse.split(':').map(Number);
                   if (c1 !== c2) return c1 - c2;
                   return v1 - v2;
                });
                return { book: randomBookName, content: selectedVerses };
            });
            return (<div className="bg-[#FFF8E7] rounded-3xl shadow-2xl border-8 border-[#8B4513] flex flex-col h-[500px] overflow-hidden relative fade-in"><div className="bg-[#F3E5AB] p-4 border-b-2 border-[#D7CCC8] mt-4"><h3 className="text-xl font-black text-[#5D4037] text-center flex justify-center gap-2"><BookOpen/> æ¯æ—¥éˆç³§</h3><p className="text-center text-[#8B4513] font-bold text-sm">{selection.book}</p></div><div className="flex-1 overflow-y-auto p-6 custom-scrollbar"><div className="space-y-4">{selection.content.map((v,i)=>(<div key={i} className="flex gap-3 text-gray-700 leading-relaxed text-justify text-sm font-medium"><span className="text-xs font-black text-[#8B4513] mt-0.5 shrink-0 bg-[#F3E5AB] px-1.5 py-0.5 rounded-full flex items-center justify-center whitespace-nowrap">{v.verse}</span><span>{v.text}</span></div>))}</div><div className="h-8"></div></div><div className="p-4 bg-[#F3E5AB] space-y-2"><GameButton onClick={onComplete} color="amber" icon={Check}>æˆ‘è®€å®Œäº† (+80 ä¿¡å¿ƒ)</GameButton></div></div>);
        };

        const FateEventView = ({ onComplete }) => {
            const [card] = useState(() => FATE_CARDS[Math.floor(Math.random() * FATE_CARDS.length)]);
            const isGood = card.type === 'good';
            return <CardFlip frontTitle="å‘½é‹ç‰Œ" frontColor="from-purple-500 to-indigo-600" textColor="text-white" icon={<AlertTriangle size={64} />} backContent={<div className="w-full text-center h-full flex flex-col justify-center"><div className={`mb-6 p-4 rounded-full w-20 h-20 mx-auto flex items-center justify-center border-4 ${isGood?'bg-[#E8F5E9] border-green-600 text-green-600':'bg-[#FFEBEE] border-red-600 text-red-600'}`}>{isGood?<Sun size={40}/>:<CloudRain size={40}/>}</div><h3 className="text-2xl font-black mb-4 text-[#3E2723]">{card.title}</h3><p className="text-lg font-bold text-[#5D4037] mb-8">{card.text}</p><div className="mb-8"><span className={`text-xl font-black px-4 py-2 rounded ${isGood?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>ä¿¡å¿ƒ {card.amount>0?'+':''}{card.amount}</span>{card.freeze&&<div className="text-red-600 text-sm mt-2 font-bold flex justify-center items-center gap-1"><PauseCircle size={14}/> æš«åœä¸€å›åˆ</div>}</div><GameButton onClick={()=>onComplete(0,card.amount,card.freeze)} color={isGood?"green":"red"}>{isGood?"å“ˆåˆ©è·¯äº":"æ‚”æ”¹æ±‚ä¸»"}</GameButton></div>} />;
        };

        const ChanceEventView = ({ onComplete }) => {
            const [card] = useState(() => CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)]);
            const [quizStatus, setQuizStatus] = useState('ask');
            const handleAns = (idx) => { if (idx === card.ans) { setQuizStatus('correct'); setTimeout(() => onComplete(20, card.reward), 1500); } else { setQuizStatus('wrong'); setTimeout(() => onComplete(0, 0, true), 1500); } };
            const content = card.type === 'quiz' ? (<div className="w-full text-center"><h3 className="text-2xl font-black text-[#8B4513] mb-6">è–ç¶“å†·çŸ¥è­˜</h3>{quizStatus==='ask'&&(<><p className="text-[#3E2723] font-bold text-lg mb-6">{card.q}</p><div className="space-y-3">{card.options.map((opt,i)=><button key={i} onClick={()=>handleAns(i)} className="w-full bg-[#FFF3E0] text-[#5D4037] border-2 border-[#D7CCC8] py-3 rounded-lg font-bold hover:bg-[#FFE0B2]">{opt}</button>)}</div></>)}{quizStatus==='correct'&&<div className="py-10 text-green-700"><Check size={40} className="mx-auto"/><p className="text-2xl font-black">ç­”å°äº†ï¼</p><p className="font-bold text-green-600">+{card.reward} ä¿¡å¿ƒ</p></div>}{quizStatus==='wrong'&&<div className="py-10 text-red-700"><X size={40} className="mx-auto"/><p className="text-2xl font-black">ç­”éŒ¯äº†...</p><p className="font-bold text-red-500">æš«åœä¸€å›</p></div>}</div>) : (<div className="w-full text-center h-full flex flex-col justify-center"><CloudRain size={40} className="mx-auto text-gray-500 mb-4"/><h3 className="text-2xl font-black text-[#3E2723] mb-4">{card.title}</h3><p className="text-lg font-bold text-[#5D4037] mb-6">{card.text}</p><div className="inline-block bg-red-50 border border-red-200 px-4 py-2 rounded-lg mb-8"><p className="text-red-800 font-black">ä¿¡å¿ƒå€¼ {card.amount}</p></div><GameButton onClick={()=>onComplete(0,card.amount)} color="gray">æ¥å—æŒ‘æˆ°</GameButton></div>);
            return <CardFlip frontTitle="æ©Ÿæœƒç‰Œ" frontColor="bg-[#FFE082]" icon={<HelpCircle size={64} />} backContent={content} />;
        };

        const PrayerEventView = ({ tileData, onComplete }) => {
            const [val, setVal] = useState("");
            return (<div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#FFB74D] text-center relative"><h3 className="text-2xl font-black text-[#E65100]">ğŸ™ {tileData.name}</h3><p className="text-gray-500 mb-4 text-sm">åœ¨ä¸»é¢å‰å‚¾å¿ƒåæ„...</p><textarea className="w-full p-2 border-2 border-[#FFE0B2] rounded my-4 bg-white" rows="3" placeholder="è¼¸å…¥ä½ çš„ç¦±å‘Š..." onChange={e=>setVal(e.target.value)}/><GameButton onClick={()=>onComplete(20,50)} color="orange" disabled={!val.trim()} icon={Send}>ç™¼å‡ºç¦±å‘Š (+50 ä¿¡å¿ƒ)</GameButton></div>);
        };
        
        const CityEventView = ({ tileData, coins, isOwner, onBuy, onUpgrade, onDestroy, onComplete, processing }) => {
            if (processing) {
                return (
                    <div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#D7CCC8] text-center relative fade-in h-64 flex flex-col items-center justify-center">
                        <div className="animate-spin text-[#8B4513] mb-4"><RefreshCw size={40} /></div>
                        <h3 className="text-2xl font-black text-[#5D4037] mb-2">è™•ç†ä¸­...</h3>
                        <p className="text-gray-500 font-bold">è«‹ç¨å€™ç‰‡åˆ»</p>
                    </div>
                );
            }

            const PropertyAction = () => {
                // SCENARIO 1: PLAYER OWNS THE TILE
                if (isOwner) { 
                    const cost = Math.floor(tileData.price*0.6); 
                    const isFirst = tileData.level === 0; 
                    return (
                        <div className="mt-4 border-t-2 border-[#D7CCC8] pt-4 space-y-3">
                            <p className="text-sm font-bold text-center mb-2 text-[#5D4037]">å±¬åœ°ç­‰ç´š Lv.{tileData.level}</p>
                            <GameButton onClick={()=>onUpgrade(cost)} disabled={coins<cost} color="amber" icon={isFirst ? Home : Flame}>
                                {isFirst ? `å»ºç«‹ç¥­å£‡ (-${cost})` : `ç»ç¥­å‡ç´š (-${cost})`}
                            </GameButton>
                            <GameButton onClick={()=>onComplete(0,0)} color="gray" icon={LogOut}>
                                æš«ä¸å‡ç´š (é›¢é–‹)
                            </GameButton>
                        </div>
                    ); 
                }
                
                // SCENARIO 2: EMPTY TILE (NO OWNER)
                if (!tileData.owner) {
                    return (
                        <div className="mt-4 border-t-2 border-[#D7CCC8] pt-4 space-y-3">
                            <GameButton onClick={()=>onBuy(tileData.price)} disabled={coins<tileData.price} color="indigo" icon={Sword}>
                                æ”»ä½”æ­¤åœ° (-{tileData.price})
                            </GameButton>
                            <GameButton onClick={()=>onComplete(0,0)} color="gray" icon={Footprints}>
                                è·¯é (ä¸è³¼è²·)
                            </GameButton>
                        </div>
                    );
                }
                
                // SCENARIO 3: ENEMY TILE
                if (tileData.owner) { 
                    const rent = tileData.rent * (tileData.level + 1); 
                    const destroy = tileData.price; 
                    
                    return (
                        <div className="mt-4 bg-[#FFEBEE] p-3 rounded border border-red-200 space-y-2">
                            <p className="text-center text-red-600 font-bold mb-2">æ•µæ–¹ç‡Ÿå£˜</p>
                            <GameButton onClick={()=>onComplete(0,-rent)} color="red" icon={Heart}>
                                ä»˜éè·¯è²» (ç¥ç¦ -{rent})
                            </GameButton>
                            
                            <div className="relative flex py-1 items-center">
                                <div className="flex-grow border-t border-red-300"></div>
                                <span className="flex-shrink-0 mx-2 text-red-300 text-xs">æˆ–</span>
                                <div className="flex-grow border-t border-red-300"></div>
                            </div>

                            <GameButton onClick={()=>onDestroy(destroy,false)} disabled={coins<destroy} color="purple" icon={Hammer}>
                                {tileData.level > 0 ? `æ‹†æ¯€ç¥­å£‡ (é™ç´š) (-${destroy})` : `æ‹†æ¯€ç‡Ÿå£˜ (æ­¸é›¶) (-${destroy})`}
                            </GameButton>
                        </div>
                    ); 
                }
                return null;
            };

            const title = tileData.level === 0 ? "åŸæ± " : `ç¥­å£‡ Lv.${tileData.level}`;

            return (
                <div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#D7CCC8] text-center relative fade-in">
                    <h3 className="text-2xl font-black text-[#5D4037] mb-2">ğŸ° {tileData.name} ({title})</h3>
                    {tileData.ref && <p className="text-xs text-[#8B4513] mb-4 bg-[#F3E5AB]/50 px-2 py-1 rounded inline-block text-left w-full border border-[#8B4513]/20 leading-relaxed">{tileData.ref}</p>}
                    <PropertyAction />
                </div>
            );
        };
        
        const JesusEventView = ({ onComplete }) => {
             const [blessingVerse] = useState(() => BLESSING_VERSES[Math.floor(Math.random() * BLESSING_VERSES.length)]);
             return (
                <div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#87CEEB] text-center relative fade-in">
                    <h3 className="text-2xl font-black text-[#0097A7] mb-4">âœï¸ é‡è¦‹è€¶ç©Œ</h3>
                    <div className="bg-white/60 p-4 rounded-xl mb-6 border border-[#87CEEB]/30">
                        <p className="text-lg font-bold text-[#006064] mb-2">"{blessingVerse.text}"</p>
                        <p className="text-sm text-[#00838F] text-right">- {blessingVerse.ref}</p>
                    </div>
                    <p className="my-2 text-sm text-gray-600">é ˜å—å±¬å¤©çš„ç¥ç¦...</p>
                    <GameButton onClick={()=>onComplete(20,100)} color="cyan">é ˜å— (+100)</GameButton>
                </div>
            );
        }

        // ==========================================
        // 4. MODALS & SCREENS
        // ==========================================
        const EventModal = ({ type, tileData, onClose, onComplete, coins, isOwner, onBuy, onUpgrade, onDestroy, processing }) => {
            const CloseButton = () => <button onClick={onClose} className="absolute top-4 right-4 bg-white/50 hover:bg-white text-gray-600 p-2 rounded-full shadow-sm transition-all z-50 border border-white/60"><X size={20} /></button>;
            
            if (processing && type === 'city') {
                 return <CityEventView tileData={tileData} processing={true} />;
            }
            
            if (type==='event_jesus') return (<><CloseButton/><JesusEventView onComplete={onComplete} /></>);
            if (type==='event_paul') return (<><CloseButton/><div className="bg-[#FFF8E7] p-8 rounded-3xl border-4 border-[#5C6BC0] text-center relative fade-in"><h3 className="text-2xl font-black text-[#3949AB]">âš¡ å¤§é¦¬è‰²è·¯</h3><p className="my-4">æš«æ™‚çœ‹ä¸è¦‹ï¼Œä½†ç”Ÿå‘½ç¿»è½‰ã€‚</p><GameButton onClick={()=>onComplete(50,50,true)} color="indigo">é †æœå‘¼å¬ (+50, æš«åœ)</GameButton></div></>);
            if (type==='bible') return <><CloseButton/><BibleReader onComplete={()=>onComplete(30,80)} /></>;
            if (type==='fate') return <><CloseButton/><FateEventView onComplete={onComplete} /></>;
            if (type==='chance') return <><CloseButton/><ChanceEventView onComplete={onComplete} /></>;
            if (type==='prayer') return <><CloseButton/><PrayerEventView tileData={tileData} onComplete={onComplete} /></>;
            if (type==='city') return <><CloseButton/><CityEventView tileData={tileData} coins={coins} isOwner={isOwner} onBuy={onBuy} onUpgrade={onUpgrade} onDestroy={onDestroy} onComplete={onComplete} processing={false} /></>;
            return null;
        };

        const GameOverScreen = ({ winner, reason, onRestart }) => {
            const isBlackRam = winner.id === 99; // Check for Black Ram

            if (isBlackRam) {
                return (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 p-6 text-center">
                        <div className="bg-[#212121] p-8 rounded-[3rem] border-8 border-[#424242] shadow-[0_0_50px_#000000] max-w-sm w-full relative overflow-hidden z-10">
                            <div className="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/black-scales.png')]"></div>
                            <Skull size={64} className="mx-auto text-[#B71C1C] mb-4" />
                            <h2 className="text-4xl font-black text-[#E0E0E0] mb-2 font-serif">é»‘æš—ç± ç½©</h2>
                            <p className="text-xl font-bold text-[#EF5350] mb-2">ç²å‹è€…ï¼š<span className={winner.color}>{winner.name}</span></p>
                            {reason && <p className="text-md font-bold text-gray-400 mb-6 bg-black/50 py-1 px-2 rounded inline-block border border-gray-700">{reason}</p>}
                            <div className={`text-6xl mb-6 ${winner.filter} drop-shadow-[0_0_15px_rgba(255,0,0,0.5)]`}>{winner.icon}</div>
                            <p className="text-sm text-[#BDBDBD] mb-8 font-bold">"ä»‡æ•µå¦‚åŒå¼å«çš„ç…å­ï¼Œéåœ°éŠè¡Œï¼Œå°‹æ‰¾å¯ååƒçš„äººã€‚"</p>
                            <button onClick={onRestart} className="w-full bg-[#424242] hover:bg-[#616161] text-white text-xl font-black py-4 rounded-xl shadow-lg border-2 border-[#212121] transition-all relative z-50 pointer-events-auto">é‡æ–°æŒ‘æˆ°</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 p-6 text-center">
                    <div className="bg-[#FFF8E7] p-8 rounded-[3rem] border-8 border-[#B8860B] shadow-[0_0_50px_#B8860B] max-w-sm w-full z-10 relative">
                        <Crown size={64} className="mx-auto text-[#B8860B] mb-4" />
                        <h2 className="text-4xl font-black text-[#3E2723] mb-2">æ¦®è€€æ™‚åˆ»</h2>
                        <p className="text-xl font-bold text-[#8B4513] mb-2">ç²å‹è€…ï¼š<span className={winner.color}>{winner.name}</span></p>
                        {reason && <p className="text-md font-bold text-gray-600 mb-6 bg-white/50 py-1 px-2 rounded inline-block">{reason}</p>}
                        <div className={`text-6xl mb-6 ${winner.filter}`}>{winner.icon}</div>
                        <p className="text-sm text-[#5D4037] mb-8 font-bold">"é‚£ç¾å¥½çš„ä»—æˆ‘å·²ç¶“æ‰“éäº†ï¼Œç•¶è·‘çš„è·¯æˆ‘å·²ç¶“è·‘ç›¡äº†ï¼Œæ‰€ä¿¡çš„é“æˆ‘å·²ç¶“å®ˆä½äº†ã€‚"</p>
                        <button onClick={onRestart} className="w-full bg-[#B8860B] hover:bg-[#9A7D0A] text-white text-xl font-black py-4 rounded-xl shadow-lg border-2 border-[#3E2723] relative z-50 pointer-events-auto">å†ä¾†ä¸€å±€</button>
                    </div>
                </div>
            );
        };

        const StartScreen = ({ onStart }) => {
            const [playerCount, setPlayerCount] = useState(1); 
            return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center relative overflow-hidden"><BackgroundMap /><div className="z-10 max-w-md w-full bg-[#F3E5AB] p-8 rounded-xl shadow-[0_10px_30px_rgba(62,39,35,0.4)] border-4 border-[#8B4513] relative vintage-border"><div className="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#8B4513] text-[#F3E5AB] px-4 py-1 text-sm font-bold rounded shadow-md tracking-widest">BIBLE ADVENTURE</div><h1 className="text-4xl font-black text-[#3E2723] mb-2 font-serif">å¤©åœ‹å¤§å¯Œç¿</h1><h2 className="text-lg font-bold text-[#5D4037] mb-8">- æ‡‰è¨±ä¹‹åœ°ç¯‡ -</h2>
            <div className="flex justify-center items-center gap-8 mb-8"><div className="text-6xl">ğŸ‘</div><div className="text-2xl font-black">VS</div><div className="text-6xl" style={{filter: 'grayscale(100%) invert(100%)'}}>ğŸ</div></div>
            <div className="flex flex-col gap-3 mb-6">
                <button onClick={()=>setPlayerCount(1)} className={`w-full py-3 rounded-lg font-bold border-2 transition-all flex items-center justify-center gap-2 ${playerCount===1 ? 'bg-[#8B4513] text-[#F3E5AB] border-[#8B4513] shadow-md' : 'bg-transparent text-[#8B4513] border-[#8B4513]/50 hover:bg-[#8B4513]/10'}`}>
                    <User size={20} className="inline"/> å–®äººæŒ‘æˆ° (VS é›»è…¦)
                </button>
                <button onClick={()=>setPlayerCount(2)} className={`w-full py-3 rounded-lg font-bold border-2 transition-all flex items-center justify-center gap-2 ${playerCount>1 ? 'bg-[#8B4513] text-[#F3E5AB] border-[#8B4513] shadow-md' : 'bg-transparent text-[#8B4513] border-[#8B4513]/50 hover:bg-[#8B4513]/10'}`}>
                    <Users size={20} className="inline"/> å¤šäººåŒæ¨‚ (æœ¬æ©Ÿè¼ªæµ)
                </button>
            </div>
            {playerCount > 1 && (
                <div className="bg-[#E6D5B8] p-4 rounded-lg border border-[#8B4513]/30 shadow-inner mb-6 animate-in slide-in-from-top-4 duration-300">
                    <p className="text-xs text-[#8B4513] mb-3 font-bold text-center bg-white/50 py-1 rounded-full flex items-center justify-center gap-1"><Pointer size={12}/> è«‹è¼ªæµå‚³éè£ç½®é€²è¡ŒéŠæˆ² (Hotseat)</p>
                    <div className="flex flex-col items-center gap-2">
                        <span className="font-bold text-[#3E2723] text-sm">é¸æ“‡éŠç©äººæ•¸:</span>
                        <div className="flex justify-center items-center gap-4">
                            {[2, 3, 4].map(num => (
                                <button key={num} onClick={()=>setPlayerCount(num)} className={`w-12 h-12 rounded-full border-2 flex items-center justify-center font-black text-lg transition-all ${playerCount===num?'bg-[#8B4513] text-white scale-110 shadow-lg border-[#3E2723]':'bg-white text-[#8B4513] border-[#8B4513]/30 hover:border-[#8B4513]'}`}>
                                    {num}
                                </button>
                            ))}
                        </div>
                        <div className="mt-2 text-xs font-bold text-[#5D4037] flex gap-2">
                             {Array.from({length: playerCount}).map((_, i) => (
                                 <span key={i} className={`px-2 py-1 rounded bg-white/50 border border-[#8B4513]/20`}>{PLAYER_CONFIGS[i].icon}</span>
                             ))}
                        </div>
                    </div>
                </div>
            )}
            <div className="text-left mb-6 space-y-3 bg-[#E6D5B8] p-4 rounded border border-[#8B4513]/30 shadow-inner"><h3 className="font-bold text-[#8B4513] mb-3 flex items-center gap-2 border-b border-[#8B4513]/20 pb-2"><Info size={18} /> éŠæˆ²è¦å‰‡</h3><div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">1</div><p className="text-sm font-bold text-[#3E2723]">æ“²éª°å­ï¼Œç´¯ç©ä¿¡å¿ƒ ({WIN_CONDITION_FAITH})ã€‚</p></div><div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">2</div><p className="text-sm font-bold text-[#3E2723]">æ”»ä½” {WIN_CONDITION_CITIES} åº§åŸæ± ï¼Œæˆ–å»ºç«‹ {WIN_CONDITION_ALTARS} åº§ç¥­å£‡ã€‚</p></div><div className="flex items-start gap-3"><div className="bg-[#8B4513] text-[#F3E5AB] w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold shrink-0">3</div><p className="text-sm font-bold text-[#3E2723]">å°å¿ƒç ´ç”¢ (ä¿¡å¿ƒ &lt; 0)ã€‚</p></div></div><button onClick={()=>onStart(playerCount)} className="w-full bg-[#8B4513] hover:bg-[#5D4037] text-[#F3E5AB] text-xl font-black py-4 rounded shadow-md border-2 border-[#3E2723]"><Sword size={24} className="inline mr-2"/> {playerCount===1?'é–‹å§‹æŒ‘æˆ°':'é–‹å§‹éŠæˆ²'}</button><div className="mt-8 pt-6 border-t border-[#8B4513]/30"><p className="text-[#3E2723] font-bold mb-4">è€¶ç©ŒåŠ æ²¹ç«™ x å¾®å…‰æ–°äº‹</p><div className="flex justify-center gap-4"><a href="https://www.facebook.com/profile.php?id=100068500932557" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><Facebook size={24} /></a><a href="https://www.instagram.com/forever.believe.in.jesus/" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><Instagram size={24} /></a><a href="https://www.threads.net/@forever.believe.in.jesus" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><AtSign size={24} /></a><a href="https://line.me/R/ti/p/@469cjlho" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><MessageCircle size={24} /></a><a href="mailto:newthingsinthelittlelight@gmail.com" target="_blank" className="text-[#3E2723] hover:text-[#8B4513] transition-colors"><Mail size={24} /></a></div></div></div></div>);
        };

        // ==========================================
        // 5. MAIN APP
        // ==========================================
        const App = () => {
          const [gameState, setGameState] = useState('start');
          const [board, setBoard] = useState(INITIAL_BOARD_MAP);
          const [players, setPlayers] = useState([]);
          const [currentTurn, setCurrentTurn] = useState(0);
          const [turnCount, setTurnCount] = useState(0); 
          const [isMoving, setIsMoving] = useState(false);
          const [diceValue, setDiceValue] = useState(1);
          const [activeModal, setActiveModal] = useState(null);
          const [notification, setNotification] = useState(null);
          const [waitingForDraw, setWaitingForDraw] = useState(null);
          const [drawPrompt, setDrawPrompt] = useState(""); 
          const [winnerData, setWinnerData] = useState(null);
          const [inputDisabled, setInputDisabled] = useState(false); // To prevent accidental double taps
          const [processingAction, setProcessingAction] = useState(false); // New state for action feedback
          
          // Safety ref for interval
          const moveIntervalRef = useRef(null);

          // --- REFS for safe state access ---
          const playersRef = useRef(players);
          const currentTurnRef = useRef(currentTurn);
          const boardRef = useRef(board);
          
          useEffect(() => { playersRef.current = players; }, [players]);
          useEffect(() => { currentTurnRef.current = currentTurn; }, [currentTurn]);
          useEffect(() => { boardRef.current = board; }, [board]);

          const notify = (text, color="bg-amber-500") => { setNotification({ text, color }); setTimeout(() => setNotification(null), 3000); };

          const startGame = (count) => {
            const numPlayers = parseInt(count);
            const newPlayers = [];
            
            for (let i = 0; i < numPlayers; i++) {
                newPlayers.push({
                    ...PLAYER_CONFIGS[i],
                    pos: 0,
                    faith: STARTING_FAITH,
                    isFrozen: false,
                    isCPU: false 
                });
            }

            if (numPlayers === 1) {
                newPlayers.push({ 
                    ...CPU_CONFIG, 
                    pos: 0, 
                    faith: STARTING_FAITH, 
                    isFrozen: false, 
                    isCPU: true 
                });
            }

            if (moveIntervalRef.current) clearInterval(moveIntervalRef.current);

            setWinnerData(null);
            setPlayers(newPlayers);
            setBoard(INITIAL_BOARD_MAP);
            setGameState('playing');
            setCurrentTurn(0);
            setTurnCount(0); 
            setIsMoving(false);
            setActiveModal(null);
            setWaitingForDraw(null);
            setDrawPrompt("");
            setProcessingAction(false);
          };

          const handleRestart = () => {
              setWinnerData(null);
              setGameState('start');
              setPlayers([]); 
              setTurnCount(0);
          };

          const checkForWinner = (currentPlayers, currentBoard) => {
             if(!currentPlayers || currentPlayers.length < 2) return null;

             if (turnCount < 4) return null;

             const activePlayers = currentPlayers.filter(p => !isNaN(p.faith) && p.faith >= 0);
             
             const actuallyAlive = currentPlayers.filter(p => p.faith > 0);

             if (activePlayers.length <= 1 && actuallyAlive.length <= 1) {
                 const survivor = activePlayers[0] || currentPlayers.sort((a,b)=>b.faith-a.faith)[0];
                 const loser = currentPlayers.find(p => p.faith < 0);
                 const reason = loser ? `å°æ‰‹ä¿¡å¿ƒè€—ç›¡ (${Math.floor(loser.faith)})` : "å°æ‰‹ä¿¡å¿ƒè€—ç›¡ (ç ´ç”¢)";
                 return { winner: survivor, reason: reason };
             }
             
             for (let p of currentPlayers) {
                 if (isNaN(p.faith)) continue;

                 if (p.faith >= WIN_CONDITION_FAITH) {
                     return { winner: p, reason: `ä¿¡å¿ƒå€¼é”æˆ ${WIN_CONDITION_FAITH}` };
                 }
                 const owned = currentBoard.filter(t => t.owner === p.id && t.level > 0).length;
                 if (owned >= WIN_CONDITION_ALTARS) {
                     return { winner: p, reason: `å»ºç«‹ ${WIN_CONDITION_ALTARS} åº§ç¥­å£‡` };
                 }
                 const cities = currentBoard.filter(t => t.owner === p.id).length;
                 if (cities >= WIN_CONDITION_CITIES) {
                     return { winner: p, reason: `æ”»ä½” ${WIN_CONDITION_CITIES} åº§åŸæ± ` };
                 }
             }
             return null;
          };

          const nextTurn = () => {
              const currentP = playersRef.current;
              
              const winData = checkForWinner(currentP, boardRef.current);
              if (winData) { setWinnerData(winData); return; }
              
              // FORCE RESET STATE (Fix for stuck button)
              setWaitingForDraw(null);
              setActiveModal(null);
              setIsMoving(false);
              setProcessingAction(false);
              
              setTurnCount(prev => prev + 1); 
              const nextIdx = (currentTurnRef.current + 1) % currentP.length;
              setCurrentTurn(nextIdx);
              
              // IMPERATIVE TRIGGER: Check if NEXT player is CPU and trigger roll
              if (currentP[nextIdx].isCPU) {
                  setTimeout(() => rollDice(), 1000);
              }
          };

          const rollDice = () => {
              if (isMoving) return;

              const currentPlayer = playersRef.current[currentTurnRef.current];
              const currentPos = currentPlayer.pos; 
              
              if (currentPlayer.isFrozen) {
                  notify(`${currentPlayer.name} æ› é‡çœæ€ä¸­...`, "bg-gray-500");
                  setIsMoving(true);
                  setTimeout(() => {
                      setPlayers(prev => prev.map((p, i) => i === currentTurnRef.current ? { ...p, isFrozen: false } : p));
                      setIsMoving(false);
                      nextTurn();
                  }, 1500);
                  return;
              }

              setIsMoving(true);
              const val = Math.floor(Math.random() * 6) + 1;
              setDiceValue(val);

              const targetPos = (currentPos + val) % boardRef.current.length;

              let steps = 0;
              
              if (moveIntervalRef.current) clearInterval(moveIntervalRef.current);
              
              moveIntervalRef.current = setInterval(() => {
                  steps++;
                  
                  setPlayers(prev => {
                      return prev.map((p, i) => {
                          if (i !== currentTurnRef.current) return p;
                          const nextStepPos = (p.pos + 1) % boardRef.current.length; 
                          let newFaith = Math.floor(p.faith);
                          if (nextStepPos === 0) { 
                              newFaith += PASS_GO_REWARD;
                              notify(`${p.name} ç¶“éç´…æµ· +${PASS_GO_REWARD}`, "bg-yellow-500");
                          }
                          return { ...p, pos: nextStepPos, faith: newFaith };
                      });
                  });

                  if (steps === val) {
                      clearInterval(moveIntervalRef.current);
                      setIsMoving(false);
                      
                      handleLandEvent(targetPos);
                  }
              }, 200); 
          };

          const handleLandEvent = (finalPos) => {
              const currentIdx = currentTurnRef.current;
              const player = playersRef.current[currentIdx];
              const tile = boardRef.current[finalPos];

              if (player.isCPU) { handleCpuLogic(player, tile); return; }

              if (tile.type === 'fate' || tile.type === 'chance') {
                  const prompts = tile.type === 'fate' ? FATE_PROMPTS : CHANCE_PROMPTS;
                  setDrawPrompt(prompts[Math.floor(Math.random() * prompts.length)]);
                  setWaitingForDraw(tile.type);
              } else if (tile.type !== 'start') {
                  setTimeout(() => {
                      setActiveModal(tile.type);
                      setInputDisabled(true);
                      setTimeout(() => setInputDisabled(false), 500);
                  }, 1200);
              } else {
                  nextTurn();
              }
          };

          const handleCpuLogic = (player, tile) => {
              const delayNext = () => setTimeout(nextTurn, 1500);
              const pId = player.id;
              
              if (tile.type === 'city') {
                  if (tile.owner === null) {
                      if (player.faith >= (tile.price + 800) && Math.random() > 0.25) {
                          updateBoardAndFaith(pId, -tile.price, 'buy', null, tile.id); 
                          notify(`${player.name} æ”»ä½”äº† ${tile.name}`, "bg-purple-500");
                      } else delayNext();
                  } else if (tile.owner === pId) {
                        if (player.faith >= (tile.price * 0.6 + 800) && Math.random() > 0.3) {
                           updateBoardAndFaith(pId, -Math.floor(tile.price*0.6), 'upgrade', null, tile.id);
                           notify(`${player.name} ç»ç¥­äº† ${tile.name}`, "bg-purple-600");
                        } else delayNext();
                  } else {
                        const rent = tile.rent * (tile.level + 1);
                        const destroy = tile.price;
                        // CPU Logic: Destroy logic updated for tiered destruction
                        if (player.faith >= (destroy + 800) && Math.random() < 0.4) {
                           updateBoardAndFaith(pId, -destroy, 'destroy', null, tile.id);
                           // Notify text based on level before destruction (approx)
                           notify(`${player.name} é€²è¡Œäº†ç ´å£ï¼`, "bg-red-600");
                        } else {
                           updateBoardAndFaith(pId, -rent, 'rent', tile.owner, tile.id);
                           notify(`${player.name} æ”¯ä»˜äº†å¥‰ç»é‡‘`, "bg-green-600");
                        }
                  }
              } else if (tile.type === 'fate' || tile.type === 'chance') {
                  const effect = Math.random() > 0.5 ? 50 : -30;
                  updatePlayerFaith(pId, effect);
                  notify(`${player.name} é‡åˆ°äº†${tile.type==='fate'?'å‘½é‹':'æ©Ÿæœƒ'}`, "bg-blue-500");
                  delayNext();
              } else {
                  updatePlayerFaith(pId, 50);
                  notify(`${player.name} ç²å¾—äº†ç¥ç¦`, "bg-blue-400");
                  delayNext();
              }
          };

          const updatePlayerFaith = (pid, amount) => {
              setPlayers(prev => prev.map(p => {
                  if (p.id === pid) return { ...p, faith: Math.floor(p.faith + Number(amount)) };
                  return p;
              }));
          };

          const updateBoardAndFaith = (pid, amount, action, targetPid=null, tileIdx=null) => {
              setProcessingAction(true);
              
              setPlayers(prev => prev.map(p => {
                  if (p.id === pid) return { ...p, faith: Math.floor(p.faith + Number(amount)) };
                  if (p.id === targetPid && action === 'rent') return { ...p, faith: Math.floor(p.faith - Number(amount)) }; 
                  return p;
              }));
              
              setBoard(prev => {
                  const newBoard = [...prev];
                  let targetIndex = tileIdx;
                  if (targetIndex === null || targetIndex === undefined) {
                      const p = playersRef.current.find(pl => pl.id === pid);
                      targetIndex = p.pos;
                  }
                  
                  const tile = { ...newBoard[targetIndex] };
                  
                  if (action === 'buy' || action === 'buy_destroy') { 
                      tile.owner = pid; 
                      tile.level = 0; 
                  } else if (action === 'upgrade') { 
                      tile.level += 1; 
                  } else if (action === 'destroy') { 
                      // Tiered destruction logic
                      if (tile.level > 0) {
                          tile.level -= 1;
                          notify("ç¥­å£‡å—æï¼ç­‰ç´šä¸‹é™", "bg-red-600");
                      } else {
                          tile.owner = null; 
                          tile.level = 0; 
                          notify("ç‡Ÿå£˜å·²è¢«æ‹†æ¯€ï¼", "bg-red-600");
                      }
                  } else if (action === 'upgrade') {
                      notify("ç»ç¥­å®Œæˆï¼ç¥­å£‡å‡ç´š", "bg-amber-500");
                  } else if (action === 'buy') {
                        notify("æˆåŠŸæ”»ä½”æ­¤åœ°ï¼", "bg-indigo-500");
                  }
                  
                  newBoard[targetIndex] = tile;
                  return newBoard;
              });

              setTimeout(() => {
                  const currentP = playersRef.current[currentTurnRef.current];
                  if (!currentP.isCPU) { 
                      setActiveModal(null); 
                      nextTurn(); 
                  } else { 
                      // Fixed: CPU also needs to trigger nextTurn after action
                      nextTurn();
                  }
              }, 1500);
          };
          
          const onModalComplete = (xpG, faithChange, freeze = false) => {
             setProcessingAction(true);
             
             setPlayers(prev => prev.map((p, i) => {
                 if (i !== currentTurn) return p;
                 return { ...p, faith: Math.max(0, Math.floor(p.faith + Number(faithChange || 0))), isFrozen: freeze };
             }));
             if (faithChange > 0) notify(`ä¿¡å¿ƒå¢åŠ  +${faithChange}`);
             else if (faithChange < 0) notify(`ä¿¡å¿ƒæ¸›å°‘ ${Math.abs(faithChange)}`, "bg-red-500");
             
             setWaitingForDraw(null);
             setDrawPrompt("");

             setTimeout(() => {
                 setActiveModal(null); 
                 nextTurn();
             }, 1000);
          };
          const onCardDraw = (type) => { 
             setWaitingForDraw(null); 
             setActiveModal(type); 
          };

          if (gameState === 'start') return <StartScreen onStart={startGame} />;
          if (winnerData) return <GameOverScreen winner={winnerData.winner} reason={winnerData.reason} onRestart={handleRestart} />;

          const currentPlayer = players[currentTurn];

          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-2 relative overflow-hidden">
               <BackgroundMap />
               
               <div className="w-full max-w-md fixed top-4 z-30 px-2">
                   <div className="glass-panel rounded-xl p-2 shadow-floating border border-[#8B4513]/40 bg-[#FFF8E7]/90 backdrop-blur-md flex justify-between items-center relative h-auto min-h-[100px] py-2">
                       <div className="flex-1 flex justify-start pl-1">
                           {players[0] && (() => {
                               const p = players[0];
                               const cities = board.filter(t => t.owner === p.id && t.level === 0).length;
                               const altars = board.filter(t => t.owner === p.id && t.level > 0).length;
                               return (
                                   <div className={`flex flex-col items-center p-2 rounded-xl border-2 transition-all ${0 === currentTurn ? `${p.bg} ${p.border} scale-105 shadow-md` : 'border-transparent opacity-80 scale-95'} min-w-[80px]`}>
                                           <div className={`text-3xl mb-1 ${p.filter || ''}`}>{p.icon}</div>
                                           <span className={`text-sm font-black ${p.color} mb-1`}>{p.faith}</span>
                                           <div className="flex gap-2 text-[10px] font-bold text-[#5D4037]">
                                               <div className="flex items-center"><Castle size={10} className="mr-0.5"/>{cities}</div>
                                               <div className="flex items-center"><Flame size={10} className="mr-0.5 text-orange-500"/>{altars}</div>
                                           </div>
                                   </div>
                               );
                           })()}
                       </div>

                       <span className="font-black text-[#5D4037] text-xl font-serif absolute left-1/2 -translate-x-1/2 -mt-4">CANAAN</span>

                       <div className="flex-1 flex justify-end pr-1 gap-1">
                           {players.slice(1).map((p, i) => {
                               const realIdx = i + 1;
                               const cities = board.filter(t => t.owner === p.id && t.level === 0).length;
                               const altars = board.filter(t => t.owner === p.id && t.level > 0).length;
                               return (
                                   <div key={p.id} className={`flex flex-col items-center p-2 rounded-xl border-2 transition-all ${realIdx === currentTurn ? `${p.bg} ${p.border} scale-105 shadow-md` : 'border-transparent opacity-80 scale-95'} min-w-[80px]`}>
                                           <div className={`text-3xl mb-1 ${p.filter || ''}`}>{p.icon}</div>
                                           <span className={`text-sm font-black ${p.color} mb-1`}>{p.faith}</span>
                                           <div className="flex gap-2 text-[10px] font-bold text-[#5D4037]">
                                               <div className="flex items-center"><Castle size={10} className="mr-0.5"/>{cities}</div>
                                               <div className="flex items-center"><Flame size={10} className="mr-0.5 text-orange-500"/>{altars}</div>
                                           </div>
                                   </div>
                               );
                           })}
                       </div>
                   </div>
               </div>

               {notification && <div className={`fixed top-36 z-50 px-6 py-3 rounded-lg text-[#F3E5AB] font-bold shadow-[0_4px_0_#3E2723] text-center backdrop-blur-md border-2 border-[#5D4037] ${notification.color === 'bg-red-500' ? 'bg-[#C62828]' : 'bg-[#EF6C00]'}`}>{notification.text}</div>}
               
               <div className="relative w-full max-w-md aspect-[9/16] mt-32 mb-4 p-2 scale-95">
                  <div className="w-full h-full bg-[#E6D5B8]/80 rounded-[1.5rem] shadow-[inset_0_0_60px_rgba(62,39,35,0.2)] relative border-8 border-[#8D6E63] outline outline-4 outline-[#5D4037] backdrop-blur-sm overflow-hidden">
                      
                      <div className="absolute top-[12.5%] left-[25%] w-[50%] h-[75%] flex flex-col items-center justify-between py-6 z-20 pointer-events-none">
                         <div className="flex justify-between w-full px-2 pointer-events-auto">
                             <Deck type="fate" active={waitingForDraw === 'fate'} onClick={() => onCardDraw('fate')} prompt={waitingForDraw === 'fate' ? drawPrompt : null} />
                             <Deck type="chance" active={waitingForDraw === 'chance'} onClick={() => onCardDraw('chance')} prompt={waitingForDraw === 'chance' ? drawPrompt : null} />
                         </div>

                         {!waitingForDraw ? (
                             <div className="flex flex-col items-center pointer-events-auto">
                                 <div className="w-24 h-24 rounded-full bg-[#FFF8E1] shadow-[inset_0_4px_10px_rgba(0,0,0,0.05)] border-4 border-[#D7CCC8] flex flex-col items-center justify-center mb-4 relative overflow-hidden">
                                     <div className="scale-75"><Dice3D value={diceValue} rolling={isMoving}/></div>
                                 </div>
                                 <button onClick={rollDice} disabled={inputDisabled || currentPlayer?.isCPU || isMoving || activeModal} className={`w-36 py-3 rounded-xl font-black text-[#F3E5AB] shadow-[0_4px_0_#3E2723] text-sm flex items-center justify-center gap-2 transition-all active:translate-y-1 active:shadow-none border-2 border-[#3E2723] ${currentPlayer?.isCPU ? 'bg-gray-400' : currentPlayer?.isFrozen ? 'bg-red-600' : 'bg-[#8B4513] hover:bg-[#6D4C41]'}`}>
                                     {currentPlayer?.isCPU ? "é›»è…¦æ€è€ƒä¸­..." : currentPlayer?.isFrozen ? <><Lock size={16}/> è·³é</> : `è¼ªåˆ°${currentPlayer?.name}`}
                                 </button>
                                 <div className={`mt-2 px-3 py-1 rounded-full text-xs font-bold ${currentPlayer?.bg} ${currentPlayer?.color} border border-current shadow-sm`}>
                                     {currentPlayer?.name} {currentPlayer?.isCPU ? '(é›»è…¦)' : '(ä½ )'} çš„å›åˆ
                                 </div>
                             </div>
                         ) : (
                             <div className="flex flex-col items-center justify-center h-full pb-10 pointer-events-auto">
                                 <div className="animate-bounce mb-2 filter drop-shadow-lg">
                                     {waitingForDraw === 'fate' ? 
                                        <ArrowUpLeft size={60} className="text-[#6A1B9A] stroke-[3]" /> : 
                                        <ArrowUpRight size={60} className="text-[#E65100] stroke-[3]" />
                                     }
                                 </div>
                                 <div className={`px-6 py-4 rounded-2xl font-black text-xl shadow-[0_6px_0_rgba(0,0,0,0.2)] border-4 text-center transform transition-all duration-300 ${waitingForDraw === 'fate' ? 'bg-[#8E44AD] border-[#4A235A] text-white' : 'bg-[#F39C12] border-[#A04000] text-white'}`}>
                                     <p className="text-2xl mb-1">{waitingForDraw === 'fate' ? 'å‘½é‹' : 'æ©Ÿæœƒ'}</p>
                                     <p className="text-xs font-normal opacity-90">{drawPrompt || "è«‹é»æ“Šä¸Šæ–¹ç‰Œå †"}</p>
                                 </div>
                             </div>
                         )}
                      </div>

                      {board.map((tile, i) => {
                          const pos = getGridPosition(i);
                          const style = { left: `${pos.x * 25}%`, top: `${pos.y * 12.5}%`, width: '25%', height: '12.5%' };
                          let BuildingIcon = null;
                          if(tile.owner !== null && tile.type === 'city') {
                              const owner = players.find(p => p.id === tile.owner);
                              const colors = ['text-indigo-600', 'text-purple-600', 'text-pink-600', 'text-amber-600'];
                              const colorClass = owner ? colors[owner.id % 4] : 'text-gray-500';
                              BuildingIcon = (<div className={`absolute -top-3 right-0 flex items-end ${colorClass} z-20 drop-shadow-md`}><Castle size={16} fill="currentColor"/>{tile.level>=1 && <div className="flex -ml-1"><Flame size={12} className="text-orange-500" fill="currentColor"/></div>}</div>);
                          }
                          
                          const playersHere = players.filter(p => p.pos === i);
                          
                          return (
                             <div key={tile.id} className="absolute p-1 transition-all" style={style}>
                                 <div className={`w-full h-full rounded shadow-sm flex flex-col items-center justify-center relative overflow-visible border-white/60 bg-gradient-to-br ${tile.color} border-2`}>
                                     {BuildingIcon}
                                     <div className="text-[#5D4037] transform scale-90 mb-0.5 opacity-80">{tile.icon}</div>
                                     <div className="text-[9px] font-bold text-[#3E2723] leading-none text-center px-0.5 truncate w-full tracking-tight">{tile.name || tile.label}</div>
                                     <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-30 flex-wrap content-center gap-1">
                                         {playersHere.map((p, idx) => (
                                             <div key={p.id} className="transition-all duration-500" style={{transform: `translate(${idx*2}px, ${idx*-2}px)`}}>
                                                 <div className="drop-shadow-md text-xl">
                                                     <span className={p.filter}>{p.icon}</span>
                                                 </div>
                                             </div>
                                         ))}
                                     </div>
                                 </div>
                             </div>
                          )
                      })}
                  </div>
               </div>
               
               {activeModal && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-[#3E2723]/60 backdrop-blur-sm"><div className="w-full max-w-sm"><EventModal type={activeModal} tileData={board[currentPlayer.pos]} coins={currentPlayer.faith} isOwner={board[currentPlayer.pos].owner === currentPlayer.id} isFrozen={currentPlayer.isFrozen} onClose={() => { setActiveModal(null); nextTurn(); }} onComplete={onModalComplete} onBuy={(c)=>updateBoardAndFaith(currentPlayer.id, -c, 'buy')} onUpgrade={(c)=>updateBoardAndFaith(currentPlayer.id, -c, 'upgrade')} onDestroy={(c, claim)=>updateBoardAndFaith(currentPlayer.id, -c, claim?'buy_destroy':'destroy')} player={currentPlayer} processing={processingAction} /></div></div>)}
            </div>
           );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>