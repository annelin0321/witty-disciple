<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | æ ¡ç‰§å®¤</title>
    <link rel="icon" href="../assets/images/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../assets/images/favicon.svg">
    <meta name="apple-mobile-web-app-title" content="æ©Ÿæ™ºé–€å¾’">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/common.js"></script>
    
    <style>
        /* è† å›ŠæŒ‰éˆ•æ¨£å¼ */
        .chaplain-tab-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            border: 1px solid rgba(107, 142, 35, 0.2);
            background-color: rgba(255, 255, 255, 0.5);
            color: #757575;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .chaplain-tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.8);
            color: #6B8E23;
        }
        .chaplain-tab-btn.active {
            background-color: #6B8E23;
            color: white;
            border-color: #6B8E23;
            box-shadow: 0 4px 6px rgba(107, 142, 35, 0.2);
        }

        /* ç­†è¨˜æœ¬å®¹å™¨ */
        .notebook-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            max-width: 42rem;
            margin: 0 auto;
        }
        
        /* ç¢ºä¿è¼¸å…¥æ¡†æ¨£å¼ä¸€è‡´ */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="pb-20">
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 hover:scale-110 transition-transform">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="#FDFBF7" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="50" cy="35" r="18" fill="#6B8E23" opacity="0.9"/>
                            <circle cx="35" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <circle cx="65" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <path d="M50 35 L 50 75" stroke="#8D7B68" stroke-width="4" stroke-linecap="round"/>
                            <path d="M35 45 L 65 45" stroke="#8D7B68" stroke-width="3" stroke-linecap="round"/>
                            <path d="M25 72 Q 50 82 75 72" stroke="#8D7B68" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                            <path d="M50 82 L 50 72" stroke="#8D7B68" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´»</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]">
                        <i data-lucide="home" class="w-4 h-4"></i> å›é¦–é 
                    </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="../daily/index.html" class="nav-item">é€šè­˜ä¸­å¿ƒ</a>
                    <a href="../library/index.html" class="nav-item">åœ–æ›¸é¤¨</a>
                    <a href="index.html" class="nav-item active">æ ¡ç‰§å®¤</a>
                    <a href="../school/index.html" class="nav-item">å­¸éœ¸é¤Šæˆç­</a>
                    <a href="../games/index.html" class="nav-item">èª²å¤–æ´»å‹•</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <section id="section-prayers" class="page-section fade-in">
            <div id="chaplain-content"></div>
        </section>
    </div>

    <script>
        const PRAYERS_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/prayers.json';
        let prayersData = [];
        let currentPrayerFilter = 'all';

        // æƒ…ç·’åˆ†é¡è³‡æ–™
        const emotionCategories = {
            "æ„‰æ‚…èˆ‡é€£çµ": ["å¹¸ç¦", "æ»¿è¶³", "èˆˆå¥®", "æ„Ÿæ¿€", "è‡ªè±ª", "æ¨‚è§€", "è¢«æ„›", "æ•¬ç•", "ç†±æƒ…", "å¹³éœ"],
            "æ†¤æ€’èˆ‡æ•µæ„": ["æ†¤æ€’", "ç…©èº", "æŒ«æŠ˜", "æ•µæ„", "æ†¤æ…¨", "æ¿€å‹•", "æš´æ€’", "ä¸å¹³"],
            "æ‚²å‚·èˆ‡å¤±è½": ["æ‚²å‚·", "æ†‚é¬±", "å¤±æœ›", "çµ•æœ›", "å“€æ…Ÿ", "å­¤ç¨", "ç„¡åŠ©", "å—å‚·"],
            "ææ‡¼èˆ‡ç„¦æ…®": ["ç„¦æ…®", "æ“”æ†‚", "ææ…Œ", "ç·Šå¼µ", "ææ‡¼", "ä¸å®‰", "è„†å¼±", "é©šåš‡"],
            "è‡ªè¦ºèˆ‡èªçŸ¥": ["ç¾æ„§", "å…§ç–š", "å°·å°¬", "å›°æƒ‘", "çŸ›ç›¾", "èŒ«ç„¶", "ç–²æ†Š", "å«‰å¦’"]
        };

        async function init() {
            try {
                const res = await fetch(PRAYERS_DATA_URL);
                prayersData = await res.json();
            } catch (e) { console.warn("Using default prayers"); }
            renderChaplainOffice();
            if(window.lucide) lucide.createIcons();
        }

        function renderChaplainOffice() {
            // éš¨æ©Ÿç¦±å‘Š
            const randomPrayer = prayersData.length > 0 ? prayersData[Math.floor(Math.random() * prayersData.length)] : { title: "å¯§éœç¦±æ–‡", content: "ç¥å•Šï¼Œè«‹è³œçµ¦æˆ‘å¯§éœï¼Œå»æ¥å—æˆ‘ç„¡æ³•æ”¹è®Šçš„äº‹..." };
            
            // ç”¢ç”Ÿæƒ…ç·’æ¨™ç±¤ HTML
            let emotionHtml = '';
            for (const [category, emotions] of Object.entries(emotionCategories)) {
                let typeClass = 'neutral';
                if(category.includes('æ„‰æ‚…')) typeClass = 'positive';
                else if(category.includes('æ†¤æ€’') || category.includes('æ‚²å‚·') || category.includes('ææ‡¼')) typeClass = 'negative';
                
                emotionHtml += `
                    <div class="mb-3">
                        <div class="emotion-group-title">${category}</div>
                        <div class="flex flex-wrap gap-1">
                            ${emotions.map(e => `<span class="emotion-chip ${typeClass}" onclick="toggleEmotion(this)">${e}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-serif text-[#3E3B39]">æ ¡ç‰§å®¤</h2>
                    <p class="eng-script text-[#8D7B68]">Chaplain's Office</p>
                </div>
                
                <!-- ä»Šæ—¥ç¦±å‘Šå¡ -->
                <div class="stationery-card mb-12">
                    <div class="flex flex-col items-center text-center mb-6">
                        <h3 class="text-xl font-bold text-[#6B8E23] mb-2">${randomPrayer.title || randomPrayer.Title}</h3>
                    </div>
                    <p class="text-[#585858] leading-relaxed whitespace-pre-wrap mb-6 font-light text-center">${randomPrayer.fullText || randomPrayer.content}</p>
                    <div class="text-center"><button onclick="renderChaplainOffice()" class="text-xs text-[#8D7B68] hover:text-[#6B8E23] transition-colors flex items-center justify-center gap-1 mx-auto"><i data-lucide="refresh-cw" class="w-3 h-3"></i> æ›ä¸€å‰‡ç¦±å‘Š</button></div>
                </div>

                <!-- å·¥å…· Tabs -->
                <div class="flex justify-center mb-8">
                    <div class="flex flex-wrap justify-center gap-2 w-full max-w-3xl">
                        <button class="chaplain-tab-btn active" onclick="switchTab('tab-devotion', this)">éˆä¿®ç­†è¨˜</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-prayer', this)">ç¦±å‘Šæ—¥è¨˜</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-gratitude', this)">æ„Ÿæ©æ—¥è¨˜</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-emotion', this)">æƒ…ç·’æ—¥è¨˜</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-letter', this)">æ™‚ç©ºè† å›Š</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-blank', this)">éˆæ„Ÿç­†è¨˜</button>
                    </div>
                </div>

                <!-- 1. éˆä¿®ç­†è¨˜ -->
                <div id="tab-devotion" class="chaplain-tab-content fade-in">
                    <div class="notebook-card text-left">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">è†è½ç¥è²éŸ³ï¼Œå›æ‡‰ç¥‚çš„æ„›ã€‚</p>
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">ä»Šæ—¥ç¶“æ–‡ / é€²åº¦</label>
                                <input type="text" class="form-input bg-white/50" placeholder="ä¾‹å¦‚ï¼šè©©ç¯‡ 23" id="dev-ref">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¶“æ–‡å¤§æ„ (Summary)</label>
                                <textarea id="dev-summary" class="form-input" rows="3" placeholder="é€™æ®µç¶“æ–‡åœ¨èªªä»€éº¼..."></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœ€æœ‰æ„Ÿå‹•çš„ä¸€å¥ (Rhema)</label>
                                <input id="dev-verse" type="text" class="form-input" placeholder="å“ªä¸€å¥è©±æŠ“ä½äº†ä½ çš„å¿ƒï¼Ÿ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç”Ÿæ´»æ‡‰ç”¨ (Application)</label>
                                <textarea id="dev-app" class="form-input" rows="2" placeholder="å¦‚ä½•æ‡‰ç”¨åœ¨ç”Ÿæ´»ä¸­ï¼Ÿ"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å¤©çˆ¶çš„å¿ƒæ„ (Father's Heart)</label>
                                <textarea id="dev-heart" class="form-input" rows="2" placeholder="å¤©çˆ¶æƒ³å°ä½ èªªä»€éº¼ï¼Ÿ"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å›æ‡‰ç¦±å‘Š (Response)</label>
                                <textarea id="dev-prayer" class="form-input" rows="3" placeholder="è¦ªæ„›çš„å¤©çˆ¶..."></textarea>
                            </div>
                            <div class="text-center pt-2">
                                <button onclick="saveDevotion()" class="nature-btn">å„²å­˜ç­†è¨˜</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. ç¦±å‘Šæ—¥è¨˜ -->
                <div id="tab-prayer" class="chaplain-tab-content hidden fade-in">
                    <div class="notebook-card text-left">
                        <div class="mb-6 space-y-4">
                            <div class="form-group">
                                <label class="form-label">ç¦±å‘Šä¸»é¡Œ</label>
                                <input id="pray-topic" type="text" class="form-input" placeholder="ä¾‹å¦‚ï¼šå®¶äººå¥åº·...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">å…·é«”å…§å®¹</label>
                                <textarea id="pray-content" class="form-input" rows="3" placeholder="å‘ç¥è¨´èªª..."></textarea>
                            </div>
                            <div class="flex gap-2">
                                <select id="pray-status" class="form-input w-auto"><option value="praying">ç¦±å‘Šä¸­</option><option value="answered">å·²æˆå°±</option></select>
                                <button onclick="savePrayer()" class="nature-btn flex-1 justify-center">ç´€éŒ„</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-4 pt-4 border-t border-gray-200/50">
                            <h4 class="font-bold text-[#6B8E23]">æˆ‘çš„æ¸…å–®</h4>
                            <div class="flex gap-1 text-sm">
                                <button onclick="filterPrayers('all')" class="filter-btn active" id="f-all">å…¨éƒ¨</button>
                                <button onclick="filterPrayers('praying')" class="filter-btn" id="f-praying">ç¦±å‘Šä¸­</button>
                            </div>
                        </div>
                        <div id="prayer-list-display" class="space-y-2"></div>
                    </div>
                </div>

                <!-- 3. æ„Ÿæ©æ—¥è¨˜ -->
                <div id="tab-gratitude" class="chaplain-tab-content hidden fade-in">
                    <div class="notebook-card text-left">
                        <p class="text-center text-sm text-[#8D7B68] mb-4">æ•¸ç®—æ©å…¸ï¼Œçœ‹è¦‹ç¥çš„æ‰‹ã€‚</p>
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">æ„Ÿæ©äº‹é …</label>
                                <textarea id="grat-content" class="form-input" rows="4" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å€¼å¾—æ„Ÿè¬çš„äº‹ï¼Ÿ"></textarea>
                            </div>
                            <div class="text-center">
                                <button onclick="saveGratitude()" class="nature-btn">å­˜å…¥æ©å…¸ç½</button>
                            </div>
                            <div id="gratitude-list" class="mt-4 pt-4 border-t border-gray-200/50 text-left space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- 4. æƒ…ç·’æ—¥è¨˜ -->
                <div id="tab-emotion" class="chaplain-tab-content hidden fade-in">
                    <div class="notebook-card text-left">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">èª å¯¦é¢å°æƒ…ç·’ï¼Œå¸¶åˆ°ç¥é¢å‰ã€‚</p>
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">äº‹ä»¶ (Event)</label>
                                <input id="emo-event" type="text" class="form-input" placeholder="ç™¼ç”Ÿäº†ä»€éº¼å¼•ç™¼æƒ…ç·’çš„äº‹ï¼Ÿ">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æƒ…ç·’æ¨™è¨»</label>
                                <div class="bg-white/50 p-4 rounded-lg border border-gray-200" id="emotion-tags">
                                    ${emotionHtml}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">æˆ‘ä»¥ç‚º / æˆ‘ç›¸ä¿¡ (Belief)</label>
                                <textarea id="emo-belief" class="form-input" rows="2" placeholder="ç•¶ä¸‹æˆ‘å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿ"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç¥å¦‚ä½•çœ‹ (God's View)</label>
                                <textarea id="emo-god" class="form-input" rows="2" placeholder="ç¥çš„è©±èªæˆ–çœŸç†æ˜¯æ€éº¼èªªçš„ï¼Ÿ"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">å›æ‡‰ç¦±å‘Š (Prayer)</label>
                                <textarea id="emo-prayer" class="form-input" rows="3" placeholder="æ ¹æ“šæ–°çš„çœ‹è¦‹ï¼Œå‘ç¥ç¦±å‘Š..."></textarea>
                            </div>
                            <div class="text-center">
                                <button onclick="saveEmotion()" class="nature-btn">å®Œæˆæ—¥è¨˜</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. æ™‚ç©ºè† å›Š (Letter) - æ–°å¢å¯¶ç›’é¡¯ç¤º -->
                <div id="tab-letter" class="chaplain-tab-content hidden fade-in">
                    <div class="notebook-card text-left">
                        <p class="text-center text-sm text-[#8D7B68] mb-4">å¯«çµ¦æœªä¾†çš„è‡ªå·±ï¼Œä¿¡å¿ƒçš„å®£å‘Šã€‚</p>
                        
                        <!-- å¯«ä¿¡å€ -->
                        <div class="space-y-4">
                            <div class="form-group">
                                <label class="form-label">é–‹å•Ÿæ—¥æœŸ</label>
                                <input type="date" id="letter-date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">çµ¦æœªä¾†çš„ä¿¡</label>
                                <textarea id="letter-content" class="form-input" rows="6" placeholder="è¦ªæ„›çš„è‡ªå·±..."></textarea>
                            </div>
                            <div class="text-center">
                                <button onclick="saveLetter()" class="nature-btn">æŠ•éä¿¡ä»¶</button>
                                <p class="text-xs text-gray-400 mt-2">ä¿¡ä»¶å°‡åœ¨æŒ‡å®šæ—¥æœŸå¾Œé–‹å•Ÿã€‚</p>
                            </div>
                        </div>

                        <!-- å¯¶ç›’å€ -->
                        <div class="mt-8 pt-6 border-t border-gray-200/50">
                            <div class="bg-white/40 rounded-xl p-4 text-center border border-[#8D7B68]/20">
                                <div onclick="toggleCapsuleList()" class="cursor-pointer inline-block relative group">
                                    <div class="p-3 bg-[#FDFBF7] rounded-full border-2 border-[#8D7B68] shadow-sm group-hover:shadow-md transition-all">
                                        <!-- å¯¶ç›’ Icon -->
                                        <i data-lucide="package" class="w-8 h-8 text-[#8D7B68]"></i>
                                    </div>
                                    <!-- ç´…é»é€šçŸ¥ -->
                                    <span id="capsule-badge" class="hidden absolute -top-1 -right-1 bg-[#D85C42] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm animate-bounce">!</span>
                                </div>
                                <h4 class="font-bold text-[#3E3B39] mt-2">æ™‚ç©ºå¯¶ç›’</h4>
                                <p id="capsule-status" class="text-xs text-gray-500 mt-1">ç›®å‰æ²’æœ‰ä¿¡ä»¶</p>
                                
                                <!-- ä¿¡ä»¶åˆ—è¡¨ (é»æ“Šå¾Œå±•é–‹) -->
                                <div id="capsule-list" class="hidden mt-4 text-left space-y-3 max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. éˆæ„Ÿç­†è¨˜ (Blank Note) -->
                <div id="tab-blank" class="chaplain-tab-content hidden fade-in">
                    <div class="notebook-card text-left">
                        <p class="text-center text-sm text-[#8D7B68] mb-4">éš¨æ‰‹è¨˜ä¸‹è–éˆçš„æ„Ÿå‹•æˆ–ç”Ÿæ´»çš„éˆæ„Ÿã€‚</p>
                        <div class="space-y-4">
                            <div class="form-group">
                                <textarea id="blank-content" class="form-input" rows="5" placeholder="åœ¨æ­¤è¼¸å…¥å…§å®¹..."></textarea>
                            </div>
                            <div class="text-center">
                                <button onclick="saveBlankNote()" class="nature-btn">å„²å­˜ç­†è¨˜</button>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200/50">
                                <h4 class="font-bold text-[#6B8E23] mb-2 text-sm">ç­†è¨˜åˆ—è¡¨</h4>
                                <div id="blank-note-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('chaplain-content').innerHTML = html;
            renderPrayerList();
            renderGratitudeList();
            renderBlankNoteList();
            renderTimeCapsule(); // åˆå§‹åŒ–è¼‰å…¥å¯¶ç›’ç‹€æ…‹
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.chaplain-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.chaplain-tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- éˆä¿®åŠŸèƒ½ ---
        function saveDevotion() {
            const ref = document.getElementById('dev-ref').value;
            const summary = document.getElementById('dev-summary').value;
            const verse = document.getElementById('dev-verse').value;
            const app = document.getElementById('dev-app').value;
            const heart = document.getElementById('dev-heart').value;
            const prayer = document.getElementById('dev-prayer').value;
            if(!ref && !verse) return alert('è«‹è‡³å°‘å¡«å¯«ç¶“æ–‡æˆ–æ„Ÿå‹•ç¶“å¥');
            const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            list.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), ref, summary, verse, app, heart, prayer });
            localStorage.setItem('witty_devotions', JSON.stringify(list));
            document.getElementById('dev-summary').value = '';
            document.getElementById('dev-verse').value = '';
            document.getElementById('dev-app').value = '';
            document.getElementById('dev-heart').value = '';
            document.getElementById('dev-prayer').value = '';
            alert('éˆä¿®ç­†è¨˜å·²å„²å­˜ï¼');
        }

        // --- ç¦±å‘ŠåŠŸèƒ½ ---
        function savePrayer() {
            const topic = document.getElementById('pray-topic').value;
            const content = document.getElementById('pray-content').value;
            const status = document.getElementById('pray-status').value;
            if(!topic) return alert('è«‹å¡«å¯«ä¸»é¡Œ');
            const prayers = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            prayers.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), topic, content, status });
            localStorage.setItem('witty_prayers', JSON.stringify(prayers));
            document.getElementById('pray-topic').value = '';
            document.getElementById('pray-content').value = '';
            renderPrayerList();
        }

        function renderPrayerList() {
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const filtered = currentPrayerFilter === 'all' ? list : list.filter(p => p.status === currentPrayerFilter);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">æš«ç„¡ç´€éŒ„</p>';
            filtered.forEach(p => {
                const isDone = p.status === 'answered';
                html += `<div class="prayer-item-card ${isDone ? 'answered' : ''}"><div class="flex justify-between items-start"><h4 class="font-bold text-[#3E3B39]">${p.topic}</h4><span class="text-xs ${isDone ? 'text-green-600' : 'text-yellow-600'} border px-1 rounded">${isDone ? 'å·²æˆå°±' : 'ç¦±å‘Šä¸­'}</span></div><p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${p.content}</p><div class="mt-2 text-right"><button onclick="deletePrayer(${p.id})" class="text-xs text-red-400 hover:text-red-600 flex items-center justify-end gap-1 ml-auto"><i data-lucide="trash-2" class="w-3 h-3"></i> åˆªé™¤</button></div></div>`;
            });
            document.getElementById('prayer-list-display').innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        function deletePrayer(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            localStorage.setItem('witty_prayers', JSON.stringify(list.filter(p => p.id !== id)));
            renderPrayerList();
        }

        function filterPrayers(type) {
            currentPrayerFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`f-${type}`).classList.add('active');
            renderPrayerList();
        }

        // --- æ„Ÿæ©æ—¥è¨˜ ---
        function saveGratitude() {
            const content = document.getElementById('grat-content').value;
            if(!content) return;
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            list.unshift({ date: new Date().toLocaleDateString(), content });
            localStorage.setItem('witty_gratitude', JSON.stringify(list));
            document.getElementById('grat-content').value = '';
            renderGratitudeList();
        }

        function renderGratitudeList() {
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            let html = '';
            list.forEach(g => { html += `<div class="p-3 bg-white/50 rounded border border-gray-100 text-sm mb-2"><span class="text-xs text-gray-400 block mb-1">${g.date}</span>${g.content}</div>`; });
            document.getElementById('gratitude-list').innerHTML = html;
        }

        // --- æƒ…ç·’æ—¥è¨˜ ---
        function toggleEmotion(el) { el.classList.toggle('selected'); }

        function saveEmotion() {
            const event = document.getElementById('emo-event').value;
            if(!event) return alert('è«‹å¡«å¯«äº‹ä»¶');
            const emotions = Array.from(document.querySelectorAll('.emotion-chip.selected')).map(el => el.innerText);
            const belief = document.getElementById('emo-belief').value;
            const god = document.getElementById('emo-god').value;
            const prayer = document.getElementById('emo-prayer').value;
            const list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
            list.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), event, emotions, belief, god, prayer });
            localStorage.setItem('witty_emotions', JSON.stringify(list));
            document.getElementById('emo-event').value = '';
            document.getElementById('emo-belief').value = '';
            document.getElementById('emo-god').value = '';
            document.getElementById('emo-prayer').value = '';
            document.querySelectorAll('.emotion-chip').forEach(c => c.classList.remove('selected'));
            alert('æƒ…ç·’æ—¥è¨˜å·²å®Œæˆï¼');
        }

        // --- æ™‚ç©ºè† å›Š (å«å¯¶ç›’é‚è¼¯) ---
        function saveLetter() {
            const date = document.getElementById('letter-date').value;
            const content = document.getElementById('letter-content').value;
            if(!date || !content) return alert('è«‹å¡«å¯«å®Œæ•´');
            
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            // åŠ å…¥ ID ä»¥ä¾¿åˆªé™¤
            list.push({ id: Date.now(), date, content, read: false });
            localStorage.setItem('witty_letters', JSON.stringify(list));
            
            alert('ä¿¡ä»¶å·²æŠ•éï¼');
            document.getElementById('letter-content').value = '';
            renderTimeCapsule(); // æ›´æ–°å¯¶ç›’ç‹€æ…‹
        }

        function renderTimeCapsule() {
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            
            // å€åˆ†å¯é–‹å•Ÿèˆ‡æœªé–‹å•Ÿ
            const unlocked = list.filter(l => l.date <= today);
            const lockedCount = list.length - unlocked.length;
            
            const statusEl = document.getElementById('capsule-status');
            const badgeEl = document.getElementById('capsule-badge');
            const listEl = document.getElementById('capsule-list');
            
            if (unlocked.length > 0) {
                statusEl.innerHTML = `æœ‰ <span class="text-[#D85C42] font-bold">${unlocked.length}</span> å°ä¿¡å·²é€é”<br>${lockedCount > 0 ? `<span class="text-xs opacity-70">(${lockedCount} å°æ—…è¡Œä¸­)</span>` : ''}`;
                badgeEl.innerText = unlocked.length;
                badgeEl.classList.remove('hidden');
            } else if (lockedCount > 0) {
                statusEl.innerText = `${lockedCount} å°ä¿¡æ­£åœ¨æ™‚ç©ºæ—…è¡Œä¸­...`;
                badgeEl.classList.add('hidden');
            } else {
                statusEl.innerText = "å¯¶ç›’æ˜¯ç©ºçš„ï¼Œå¯«å°ä¿¡çµ¦æœªä¾†çš„è‡ªå·±å§ï¼";
                badgeEl.classList.add('hidden');
            }

            // æ¸²æŸ“å·²é–‹å•Ÿçš„ä¿¡ä»¶åˆ—è¡¨
            let html = '';
            // æ’åºï¼šæ–°æ—¥æœŸåœ¨å‰
            unlocked.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => {
                // ç›¸å®¹èˆŠè³‡æ–™æ²’æœ‰ ID çš„æƒ…æ³
                const id = l.id || l.date; 
                html += `
                    <div class="bg-white p-3 rounded-lg border border-[#8D7B68]/30 shadow-sm relative">
                        <div class="text-xs text-[#8D7B68] font-bold mb-1 flex justify-between items-center">
                            <span>ğŸ“… ä¾†è‡ª ${l.date} çš„ä¿¡</span>
                            <button onclick="deleteLetter(${id})" class="text-gray-300 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                        <div class="text-sm text-[#3E3B39] whitespace-pre-wrap leading-relaxed">${l.content}</div>
                    </div>
                `;
            });
            
            if (unlocked.length === 0 && lockedCount > 0) {
                 html = '<p class="text-xs text-gray-400 py-2">é‚„æ²’æœ‰ä¿¡ä»¶åˆ°é”é–‹å•Ÿæ—¥æœŸ</p>';
            }
            
            listEl.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        function toggleCapsuleList() {
            const listEl = document.getElementById('capsule-list');
            listEl.classList.toggle('hidden');
        }

        function deleteLetter(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤é€™å°ä¿¡å—ï¼Ÿ')) return;
            let list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            
            // ç›¸å®¹æ€§è™•ç†ï¼šå¦‚æœ id æ˜¯æ•¸å­—(timestamp)å°±ç”¨ id åˆªï¼Œå¦å‰‡ç”¨ date åˆª
            if (typeof id === 'number') {
                list = list.filter(l => l.id !== id);
            } else {
                // èˆŠè³‡æ–™åˆªé™¤é‚è¼¯
                // æ³¨æ„ï¼šé€™å¯èƒ½æœƒèª¤åˆªåŒä¸€å¤©æ—¥æœŸçš„å¤šå°ä¿¡ï¼Œä½†ç‚ºèˆŠè³‡æ–™ç›¸å®¹
                list = list.filter(l => l.date !== String(id) && (!l.id || l.id !== id));
            }
            
            localStorage.setItem('witty_letters', JSON.stringify(list));
            renderTimeCapsule();
        }

        // --- éˆæ„Ÿç­†è¨˜ ---
        function saveBlankNote() {
            const content = document.getElementById('blank-content').value;
            if(!content) return;
            const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            list.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), content });
            localStorage.setItem('witty_blank_notes', JSON.stringify(list));
            document.getElementById('blank-content').value = '';
            renderBlankNoteList();
        }

        function renderBlankNoteList() {
            const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            let html = list.length ? '' : '<p class="text-center text-gray-400 text-sm">æš«ç„¡ç­†è¨˜</p>';
            list.forEach(n => {
                html += `<div class="p-3 bg-white/50 rounded border border-gray-100 relative group mb-2"><div class="text-xs text-gray-400 mb-1">${n.date}</div><div class="text-sm text-[#3E3B39] whitespace-pre-wrap">${n.content}</div><button onclick="deleteBlankNote(${n.id})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            const el = document.getElementById('blank-note-list');
            if(el) { el.innerHTML = html; if(window.lucide) lucide.createIcons(); }
        }

        function deleteBlankNote(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            localStorage.setItem('witty_blank_notes', JSON.stringify(list.filter(n => n.id !== id)));
            renderBlankNoteList();
        }

        init();
    </script>
</body>
</html>
