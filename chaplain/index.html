<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | æ ¡ç‰§å®¤</title>
    <link rel="icon" href="../assets/images/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../assets/images/favicon.svg">
    <meta name="apple-mobile-web-app-title" content="æ©Ÿæ™ºé–€å¾’">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/common.js"></script>
    
    <style>
        .chaplain-tab-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            border: 1px solid rgba(107, 142, 35, 0.2);
            background-color: rgba(255, 255, 255, 0.5);
            color: #757575;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 1px solid rgba(107, 142, 35, 0.2); 
        }
        .chaplain-tab-btn:hover { background-color: rgba(255, 255, 255, 0.8); color: #6B8E23; }
        .chaplain-tab-btn.active {
            background-color: #6B8E23; color: white; border-color: #6B8E23;
            box-shadow: 0 4px 6px rgba(107, 142, 35, 0.2);
        }
        .notebook-card {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px);
            padding: 2rem; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); max-width: 42rem; margin: 0 auto;
        }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        @media screen and (max-width: 768px) {
            .form-input, input, textarea, select { font-size: 16px !important; }
        }
        .journal-item {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            border-radius: 12px; 
            padding: 1rem; 
            padding-right: 5.5rem; 
            margin-bottom: 0.75rem; 
            position: relative;
        }
        .journal-item:last-child { margin-bottom: 0; }
        
        /* æ“ä½œæŒ‰éˆ•æ¨£å¼ */
        .action-btns {
            position: absolute; 
            top: 0.75rem; 
            right: 0.75rem; 
            display: flex; 
            gap: 0.5rem;
            z-index: 50;
            padding: 2px;
            border-radius: 6px;
        }
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            color: #555; 
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer !important;
            transition: all 0.2s;
        }
        .action-btn:hover { 
            background-color: #ecfccb; 
            color: #6B8E23; 
            border-color: #6B8E23;
        }
        .action-btn.delete:hover { 
            background-color: #fee2e2; 
            color: #ef4444; 
            border-color: #ef4444;
        }
        .action-btn svg { width: 16px; height: 16px; stroke-width: 2; pointer-events: none; }
    </style>
</head>
<body class="pb-20" role="application">
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 hover:scale-110 transition-transform">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="#FDFBF7" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="50" cy="35" r="18" fill="#6B8E23" opacity="0.9"/>
                            <circle cx="35" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <circle cx="65" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <path d="M50 35 L 50 75" stroke="#8D7B68" stroke-width="4" stroke-linecap="round"/>
                            <path d="M35 45 L 65 45" stroke="#8D7B68" stroke-width="3" stroke-linecap="round"/>
                            <path d="M25 72 Q 50 82 75 72" stroke="#8D7B68" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                            <path d="M50 82 L 50 72" stroke="#8D7B68" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´»</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]"><i data-lucide="home" class="w-4 h-4"></i> å›é¦–é </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="../daily/index.html" class="nav-item">é€šè­˜ä¸­å¿ƒ</a>
                    <a href="../library/index.html" class="nav-item">åœ–æ›¸é¤¨</a>
                    <a href="index.html" class="nav-item active">æ ¡ç‰§å®¤</a>
                    <a href="../school/index.html" class="nav-item">å­¸éœ¸é¤Šæˆç­</a>
                    <a href="../games/index.html" class="nav-item">èª²å¤–æ´»å‹•</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <!-- é›²ç«¯åŒæ­¥ç‹€æ…‹åˆ— -->
        <div class="flex flex-col items-end mb-4 gap-2">
            <div id="auth-container" class="inline-flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-gray-200 shadow-sm text-sm">
                <span id="user-status" class="text-gray-500">æœªç™»å…¥ (åƒ…å­˜æœ¬æ©Ÿ)</span>
                <button id="btn-login" class="text-[#6B8E23] font-bold hover:underline" onclick="login()">Google ç™»å…¥åŒæ­¥</button>
                <button id="btn-logout" class="text-red-400 hover:underline hidden" onclick="logout()">ç™»å‡º</button>
            </div>
            <!-- éŒ¯èª¤è¨Šæ¯å€ -->
            <div id="error-message-box" class="hidden mt-2 p-3 bg-red-100 border border-red-200 text-red-700 text-xs rounded-lg max-w-sm text-left break-all"></div>
        </div>

        <section id="section-prayers" class="page-section fade-in">
            <div id="chaplain-content"></div>
        </section>
    </div>

    <!-- Firebase SDK (ä½¿ç”¨ç©©å®šçš„ 10.7.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCHn_OgHIg553J-h6EOByNYKwwWfRX2i2k",
            authDomain: "witty-disciple.firebaseapp.com",
            projectId: "witty-disciple",
            storageBucket: "witty-disciple.firebasestorage.app",
            messagingSenderId: "714502326120",
            appId: "1:714502326120:web:946e7e50282b6945d7b8dd",
            measurementId: "G-16G920FLE2"
        };

        let app, auth, db, user = null;
        let unsubscribeListeners = [];

        try {
            // æª¢æŸ¥æ˜¯å¦ç‚º file:// å”å®š
            if (window.location.protocol === 'file:') {
                console.warn("Firebase Auth ä¸æ”¯æ´ file:// å”å®šï¼Œè«‹ä½¿ç”¨ localhost æˆ–éƒ¨ç½²å¾Œæ¸¬è©¦ã€‚");
                showError("ç„¡æ³•åœ¨æœ¬åœ°æª”æ¡ˆ (file://) åŸ·è¡Œç™»å…¥ï¼Œè«‹éƒ¨ç½²åˆ°ç¶²ç«™å¾Œå†è©¦ã€‚");
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, (currentUser) => {
                    user = currentUser;
                    updateAuthUI();
                    if (user) {
                        setupRealtimeListeners();
                    } else {
                        unsubscribeListeners.forEach(unsub => unsub());
                        unsubscribeListeners = [];
                    }
                });
            }
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }

        // é¡¯ç¤ºéŒ¯èª¤å‡½å¼
        function showError(msg) {
            const box = document.getElementById('error-message-box');
            box.innerHTML = `<strong>âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š</strong><br>${msg}`;
            box.classList.remove('hidden');
        }

        window.login = async () => {
            if(!auth) return alert("Firebase æœªåˆå§‹åŒ– (å¯èƒ½æ˜¯æœ¬æ©Ÿæª”æ¡ˆåŸ·è¡Œ)");
            document.getElementById('error-message-box').classList.add('hidden');
            
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                let errorMsg = error.message;
                
                if (error.code === 'auth/unauthorized-domain') {
                    errorMsg = `ç¶²åŸŸæœªæˆæ¬Šã€‚\nè«‹è‡³ Firebase Console -> Authentication -> Settings -> Authorized domains\næ–°å¢æ‚¨çš„ç¶²åŸŸï¼š${window.location.hostname}`;
                } else if (error.message.includes('requests-from-referer') || error.message.includes('The requested action is invalid')) {
                    errorMsg = `<strong>API è¨­å®šå•é¡Œ (Google Cloud)</strong><br>
                                1. è«‹è‡³ Google Cloud Console æª¢æŸ¥ "Identity Toolkit API" æ˜¯å¦å·²å•Ÿç”¨ã€‚<br>
                                2. æª¢æŸ¥ API Key æ˜¯å¦é™åˆ¶äº†ç¶²åŸŸ (Referer)ã€‚<br>
                                3. ç¢ºèªæ‚¨ä¸æ˜¯åœ¨é è¦½è¦–çª—ä¸­æ¸¬è©¦ã€‚`;
                } else if (error.code === 'auth/popup-blocked') {
                    errorMsg = `ç€è¦½å™¨å°é–äº†ç™»å…¥è¦–çª—ï¼Œè«‹å…è¨±å½ˆå‡ºå¼è¦–çª—ã€‚`;
                }

                showError(errorMsg);
            }
        };

        window.logout = async () => {
            if(!auth) return;
            await signOut(auth);
            alert("å·²ç™»å‡º");
            location.reload(); 
        };

        function updateAuthUI() {
            const statusEl = document.getElementById('user-status');
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            
            if (user) {
                statusEl.innerHTML = `<span class="text-green-600">â—</span> ${user.displayName}`;
                btnLogin.classList.add('hidden');
                btnLogout.classList.remove('hidden');
            } else {
                statusEl.innerHTML = `<span class="text-gray-400">â—</span> æœªç™»å…¥ (åƒ…å­˜æœ¬æ©Ÿ)`;
                btnLogin.classList.remove('hidden');
                btnLogout.classList.add('hidden');
            }
        }

        window.syncToCloud = async (key, data) => {
            if (!user || !db) return;
            try {
                const docRef = doc(db, "users", user.uid, "notes", key);
                await setDoc(docRef, { data: data }, { merge: true });
                console.log(`å·²åŒæ­¥ ${key}`);
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—:", e);
                if (e.code === 'permission-denied') {
                    showError('æ¬Šé™ä¸è¶³ï¼šç„¡æ³•å¯«å…¥è³‡æ–™åº«ã€‚è«‹æª¢æŸ¥ Firestore Rulesã€‚');
                }
            }
        };

        function setupRealtimeListeners() {
            const keys = ['witty_devotions', 'witty_prayers', 'witty_gratitude', 'witty_emotions', 'witty_letters', 'witty_blank_notes'];
            keys.forEach(key => {
                const docRef = doc(db, "users", user.uid, "notes", key);
                const unsub = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data().data;
                        if (cloudData && Array.isArray(cloudData)) {
                            localStorage.setItem(key, JSON.stringify(cloudData));
                            if (window.refreshAllLists) window.refreshAllLists();
                        }
                    }
                }, (error) => {
                     if (error.code === 'permission-denied') {
                        console.warn('æ¬Šé™ä¸è¶³ï¼šç„¡æ³•è®€å–é›²ç«¯è³‡æ–™ã€‚');
                    }
                });
                unsubscribeListeners.push(unsub);
            });
        }
    </script>

    <!-- æ¥­å‹™é‚è¼¯ -->
    <script>
        const PRAYERS_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/prayers.json';
        let prayersData = [];
        let currentTabId = 'tab-devotion'; 
        let editingId = null;
        let editingKey = null;

        // SVG Icons
        const ICON_EDIT = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const ICON_TRASH = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;

        const emotionCategories = {
            "æ„‰æ‚…èˆ‡é€£çµ": ["å¹¸ç¦", "æ»¿è¶³", "èˆˆå¥®", "æ„Ÿæ¿€", "è‡ªè±ª", "æ¨‚è§€", "è¢«æ„›", "æ•¬ç•", "ç†±æƒ…", "å¹³éœ"],
            "æ†¤æ€’èˆ‡æ•µæ„": ["æ†¤æ€’", "ç…©èº", "æŒ«æŠ˜", "æ•µæ„", "æ†¤æ…¨", "æ¿€å‹•", "æš´æ€’", "ä¸å¹³"],
            "æ‚²å‚·èˆ‡å¤±è½": ["æ‚²å‚·", "æ†‚é¬±", "å¤±æœ›", "çµ•æœ›", "å“€æ…Ÿ", "å­¤ç¨", "ç„¡åŠ©", "å—å‚·"],
            "ææ‡¼èˆ‡ç„¦æ…®": ["ç„¦æ…®", "æ“”æ†‚", "ææ…Œ", "ç·Šå¼µ", "ææ‡¼", "ä¸å®‰", "è„†å¼±", "é©šåš‡"],
            "è‡ªè¦ºèˆ‡èªçŸ¥": ["ç¾æ„§", "å…§ç–š", "å°·å°¬", "å›°æƒ‘", "çŸ›ç›¾", "èŒ«ç„¶", "ç–²æ†Š", "å«‰å¦’"]
        };

        // Wake Lock
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('è¢å¹•å–šé†’é–å®šå·²å•Ÿç”¨');
                }
            } catch (err) { console.log(`ç„¡æ³•å•Ÿç”¨å–šé†’é–å®š: ${err.name}, ${err.message}`); }
        }
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); }
        });

        async function init() {
            try {
                const res = await fetch(PRAYERS_DATA_URL);
                prayersData = await res.json();
            } catch (e) { console.warn("Using default prayers"); }
            renderChaplainOffice();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journal-date').value = today;
            await requestWakeLock();
            refreshAllLists();
            if(window.lucide) lucide.createIcons();
        }

        function saveData(key, newData) {
            localStorage.setItem(key, JSON.stringify(newData));
            if (window.syncToCloud) {
                window.syncToCloud(key, newData);
            }
        }

        function getBackupUI(storageKey, title) {
            return `
                <div class="mt-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                    <div class="flex items-start gap-3">
                        <div class="p-2 bg-yellow-100 rounded-full text-yellow-600 mt-1">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <h5 class="text-sm font-bold text-yellow-800 mb-1">è¨˜å¾—å‚™ä»½æ‚¨çš„${title}</h5>
                            <p class="text-xs text-yellow-700 mb-3 leading-relaxed">
                                è³‡æ–™åƒ…å„²å­˜åœ¨æ­¤è£ç½®ã€‚å»ºè­°ä½¿ç”¨ä¸Šæ–¹ Google ç™»å…¥é–‹å•Ÿé›²ç«¯åŒæ­¥ã€‚
                            </p>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="exportNotebook('${storageKey}', '${title}')" class="px-3 py-1.5 bg-white border border-yellow-300 rounded-lg hover:bg-yellow-100 text-yellow-900 text-xs transition-colors flex items-center gap-1 shadow-sm">
                                    <i data-lucide="download" class="w-3 h-3"></i> åŒ¯å‡ºå‚™ä»½
                                </button>
                                <button onclick="document.getElementById('import-${storageKey}').click()" class="px-3 py-1.5 bg-white border border-yellow-300 rounded-lg hover:bg-yellow-100 text-yellow-900 text-xs transition-colors flex items-center gap-1 shadow-sm">
                                    <i data-lucide="upload" class="w-3 h-3"></i> åŒ¯å…¥é‚„åŸ
                                </button>
                                <input type="file" id="import-${storageKey}" class="hidden" accept=".json" onchange="importNotebook(this, '${storageKey}')">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChaplainOffice() {
            const randomPrayer = prayersData.length > 0 ? prayersData[Math.floor(Math.random() * prayersData.length)] : { title: "å¯§éœç¦±æ–‡", content: "ç¥å•Šï¼Œè«‹è³œçµ¦æˆ‘å¯§éœ..." };
            const textContent = randomPrayer.fullText || randomPrayer.content || "";
            const formattedText = textContent.split('\n').map(line => `<div class="min-h-[1.5em]">${line}</div>`).join('');

            let emotionHtml = '';
            for (const [category, emotions] of Object.entries(emotionCategories)) {
                let typeClass = 'neutral';
                if(category.includes('æ„‰æ‚…')) typeClass = 'positive';
                else if(category.includes('æ†¤æ€’') || category.includes('æ‚²å‚·') || category.includes('ææ‡¼')) typeClass = 'negative';
                
                emotionHtml += `<div class="mb-3"><div class="emotion-group-title">${category}</div><div class="flex flex-wrap gap-1">${emotions.map(e => `<span class="emotion-chip ${typeClass}" onclick="toggleEmotion(this)">${e}</span>`).join('')}</div></div>`;
            }

            const html = `
                <div class="text-center mb-8"><h2 class="text-2xl font-serif text-[#3E3B39]">æ ¡ç‰§å®¤</h2><p class="eng-script text-[#8D7B68]">Chaplain's Office</p></div>
                <div class="stationery-card mb-12"><div class="flex flex-col items-center text-center mb-6"><h3 class="text-xl font-bold text-[#6B8E23] mb-2">${randomPrayer.title || randomPrayer.Title}</h3></div><div class="text-[#585858] font-light text-center grid gap-0.5 leading-relaxed mb-6">${formattedText}</div><div class="text-center"><button onclick="renderChaplainOffice()" class="text-xs text-[#8D7B68] hover:text-[#6B8E23] transition-colors flex items-center justify-center gap-1 mx-auto"><i data-lucide="refresh-cw" class="w-3 h-3"></i> æ›ä¸€å‰‡ç¦±å‘Š</button></div></div>
                <div class="flex justify-center mb-8"><div class="flex flex-wrap justify-center gap-2 w-full max-w-3xl"><button class="chaplain-tab-btn active" onclick="switchTab('tab-devotion', this)">éˆä¿®ç­†è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-prayer', this)">ç¦±å‘Šæ—¥è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-gratitude', this)">æ„Ÿæ©æ—¥è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-emotion', this)">æƒ…ç·’æ—¥è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-letter', this)">æ™‚ç©ºè† å›Š</button><button class="chaplain-tab-btn" onclick="switchTab('tab-blank', this)">éˆæ„Ÿç­†è¨˜</button></div></div>
                <div class="flex justify-center mb-8 items-center gap-2 bg-white/40 p-2 rounded-lg inline-flex mx-auto border border-[#8D7B68]/20"><i data-lucide="calendar" class="w-4 h-4 text-[#8D7B68]"></i><label for="journal-date" class="text-sm font-bold text-[#3E3B39]">é¸æ“‡æ—¥æœŸï¼š</label><input type="date" id="journal-date" class="bg-white/80 border border-gray-300 rounded px-2 py-1 text-sm text-gray-600 focus:outline-none focus:border-[#6B8E23]" onchange="refreshAllLists()"></div>

                <div id="tab-devotion" class="chaplain-tab-content fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-6">è†è½ç¥è²éŸ³ï¼Œå›æ‡‰ç¥‚çš„æ„›ã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">ä»Šæ—¥ç¶“æ–‡</label><input type="text" class="form-input bg-white/50" placeholder="ä¾‹å¦‚ï¼šè©©ç¯‡ 23" id="dev-ref"></div><div class="form-group"><label class="form-label">ç¶“æ–‡å¤§æ„</label><textarea id="dev-summary" class="form-input" rows="3" placeholder="é€™æ®µç¶“æ–‡åœ¨èªªä»€éº¼..."></textarea></div><div class="form-group"><label class="form-label">æ„Ÿå‹•ç¶“æ–‡</label><input id="dev-verse" type="text" class="form-input" placeholder="å“ªä¸€å¥è©±æŠ“ä½äº†ä½ çš„å¿ƒï¼Ÿ"></div><div class="form-group"><label class="form-label">ç”Ÿæ´»æ‡‰ç”¨</label><textarea id="dev-app" class="form-input" rows="2" placeholder="å¦‚ä½•æ‡‰ç”¨åœ¨ç”Ÿæ´»ä¸­ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">å¤©çˆ¶å¿ƒæ„</label><textarea id="dev-heart" class="form-input" rows="2" placeholder="å¤©çˆ¶æƒ³å°ä½ èªªä»€éº¼ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">å›æ‡‰ç¦±å‘Š</label><textarea id="dev-prayer" class="form-input" rows="3" placeholder="è¦ªæ„›çš„å¤©çˆ¶..."></textarea></div><div class="text-center pt-2 flex gap-2 justify-center"><button id="btn-save-devotion" onclick="saveDevotion()" class="nature-btn">å„²å­˜ç­†è¨˜</button><button id="btn-cancel-devotion" onclick="cancelEdit('devotion')" class="nature-btn hidden bg-gray-200 border-gray-300 text-gray-600">å–æ¶ˆ</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥éˆä¿®ç´€éŒ„</h4><div id="devotion-list" class="space-y-3"></div></div>${getBackupUI('witty_devotions', 'éˆä¿®ç­†è¨˜')}</div></div>
                <div id="tab-prayer" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><div class="mb-6 space-y-4"><div class="form-group"><label class="form-label">ç¦±å‘Šä¸»é¡Œ</label><input id="pray-topic" type="text" class="form-input" placeholder="ä¾‹å¦‚ï¼šå®¶äººå¥åº·..."></div><div class="form-group"><label class="form-label">å…·é«”å…§å®¹</label><textarea id="pray-content" class="form-input" rows="3" placeholder="å‘ç¥è¨´èªª..."></textarea></div><div class="flex gap-2"><select id="pray-status" class="form-input w-auto"><option value="praying">ç¦±å‘Šä¸­</option><option value="answered">å·²æˆå°±</option></select><button id="btn-save-prayer" onclick="savePrayer()" class="nature-btn flex-1 justify-center">ç´€éŒ„</button><button id="btn-cancel-prayer" onclick="cancelEdit('prayer')" class="nature-btn hidden bg-gray-200 border-gray-300 text-gray-600">å–æ¶ˆ</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥ç¦±å‘Šç´€éŒ„</h4><div id="prayer-list-display" class="space-y-2"></div></div>${getBackupUI('witty_prayers', 'ç¦±å‘Šæ—¥è¨˜')}</div></div>
                <div id="tab-gratitude" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-4">æ•¸ç®—æ©å…¸ï¼Œçœ‹è¦‹ç¥çš„æ‰‹ã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">æ„Ÿæ©äº‹é …</label><textarea id="grat-content" class="form-input" rows="4" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å€¼å¾—æ„Ÿè¬çš„äº‹ï¼Ÿ"></textarea></div><div class="text-center flex gap-2 justify-center"><button id="btn-save-gratitude" onclick="saveGratitude()" class="nature-btn">å­˜å…¥æ©å…¸ç½</button><button id="btn-cancel-gratitude" onclick="cancelEdit('gratitude')" class="nature-btn hidden bg-gray-200 border-gray-300 text-gray-600">å–æ¶ˆ</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥æ„Ÿæ©ç´€éŒ„</h4><div id="gratitude-list" class="space-y-2 max-h-60 overflow-y-auto"></div></div>${getBackupUI('witty_gratitude', 'æ„Ÿæ©æ—¥è¨˜')}</div></div>
                <div id="tab-emotion" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-6">èª å¯¦é¢å°æƒ…ç·’ï¼Œå¸¶åˆ°ç¥é¢å‰ã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">äº‹ä»¶</label><input id="emo-event" type="text" class="form-input" placeholder="ç™¼ç”Ÿäº†ä»€éº¼å¼•ç™¼æƒ…ç·’çš„äº‹ï¼Ÿ"></div><div class="form-group"><label class="form-label">æƒ…ç·’æ¨™è¨»</label><div class="bg-white/50 p-4 rounded-lg border border-gray-200" id="emotion-tags">${emotionHtml}</div></div><div class="form-group"><label class="form-label">ä¿¡å¿µ</label><textarea id="emo-belief" class="form-input" rows="2" placeholder="ç•¶ä¸‹æˆ‘å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">ç¥å¦‚ä½•çœ‹</label><textarea id="emo-god" class="form-input" rows="2" placeholder="ç¥çš„è©±èªæˆ–çœŸç†æ˜¯æ€éº¼èªªçš„ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">å›æ‡‰ç¦±å‘Š</label><textarea id="emo-prayer" class="form-input" rows="3" placeholder="æ ¹æ“šæ–°çš„çœ‹è¦‹ï¼Œå‘ç¥ç¦±å‘Š..."></textarea></div><div class="text-center flex gap-2 justify-center"><button id="btn-save-emotion" onclick="saveEmotion()" class="nature-btn">å®Œæˆæ—¥è¨˜</button><button id="btn-cancel-emotion" onclick="cancelEdit('emotion')" class="nature-btn hidden bg-gray-200 border-gray-300 text-gray-600">å–æ¶ˆ</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥æƒ…ç·’ç´€éŒ„</h4><div id="emotion-list" class="space-y-3"></div></div>${getBackupUI('witty_emotions', 'æƒ…ç·’æ—¥è¨˜')}</div></div>
                <div id="tab-letter" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-4">å¯«çµ¦æœªä¾†çš„è‡ªå·±ï¼Œä¿¡å¿ƒçš„å®£å‘Šã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">é–‹å•Ÿæ—¥æœŸ</label><input type="date" id="letter-date" class="form-input"></div><div class="form-group"><label class="form-label">çµ¦æœªä¾†çš„ä¿¡</label><textarea id="letter-content" class="form-input" rows="6" placeholder="è¦ªæ„›çš„è‡ªå·±..."></textarea></div><div class="text-center flex gap-2 justify-center"><button id="btn-save-letter" onclick="saveLetter()" class="nature-btn">æŠ•éä¿¡ä»¶</button><button id="btn-cancel-letter" onclick="cancelEdit('letter')" class="nature-btn hidden bg-gray-200 border-gray-300 text-gray-600">å–æ¶ˆ</button></div></div><div class="mt-8 pt-6 border-t border-gray-200/50"><div class="bg-white/40 rounded-xl p-4 text-center border border-[#8D7B68]/20"><div onclick="toggleCapsuleList()" class="cursor-pointer inline-block relative group"><div class="p-3 bg-[#FDFBF7] rounded-full border-2 border-[#8D7B68] shadow-sm group-hover:shadow-md transition-all"><i data-lucide="package" class="w-8 h-8 text-[#8D7B68]"></i></div><span id="capsule-badge" class="hidden absolute -top-1 -right-1 bg-[#D85C42] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm animate-bounce">!</span></div><h4 class="font-bold text-[#3E3B39] mt-2">æ™‚ç©ºå¯¶ç›’</h4><p id="capsule-status" class="text-xs text-gray-500 mt-1">ç›®å‰æ²’æœ‰ä¿¡ä»¶</p><div id="capsule-list" class="hidden mt-4 text-left space-y-3 max-h-60 overflow-y-auto"></div></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥å¯«ä¿¡ç´€éŒ„</h4><div id="letter-list-daily" class="space-y-2"></div></div>${getBackupUI('witty_letters', 'æ™‚ç©ºè† å›Š')}</div></div>
                <div id="tab-blank" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-4">éš¨æ‰‹è¨˜ä¸‹è–éˆçš„æ„Ÿå‹•æˆ–ç”Ÿæ´»çš„éˆæ„Ÿã€‚</p><div class="space-y-4"><div class="form-group"><textarea id="blank-content" class="form-input" rows="5" placeholder="åœ¨æ­¤è¼¸å…¥å…§å®¹..."></textarea></div><div class="text-center flex gap-2 justify-center"><button id="btn-save-blank" onclick="saveBlankNote()" class="nature-btn">å„²å­˜ç­†è¨˜</button><button id="btn-cancel-blank" onclick="cancelEdit('blank')" class="nature-btn hidden bg-gray-200 border-gray-300 text-gray-600">å–æ¶ˆ</button></div><div class="mt-4 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-2 text-sm">ğŸ“… ç•¶æ—¥éˆæ„Ÿç´€éŒ„</h4><div id="blank-note-list" class="space-y-2 max-h-60 overflow-y-auto"></div></div></div>${getBackupUI('witty_blank_notes', 'éˆæ„Ÿç­†è¨˜')}</div></div>
            `;
            document.getElementById('chaplain-content').innerHTML = html;
        }

        function switchTab(id, btn) {
            cancelEdit();
            document.querySelectorAll('.chaplain-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.chaplain-tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            refreshAllLists();
        }

        function getSelectedDate() {
            const dateInput = document.getElementById('journal-date');
            return dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        }

        function refreshAllLists() {
            window.refreshAllLists = refreshAllLists; 
            renderDevotionList(); renderPrayerList(); renderGratitudeList(); renderEmotionList(); renderLetterListDaily(); renderBlankNoteList(); renderTimeCapsule();
            if(window.lucide) lucide.createIcons();
        }

        // --- ç·¨è¼¯åŠŸèƒ½å¯¦ä½œ ---
        function startEditing(type, id) {
            editingKey = type; 
            editingId = id;
            document.querySelector('.notebook-card').scrollIntoView({ behavior: 'smooth' });

            if (type === 'witty_devotions') {
                const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
                const item = list.find(i => i.id === id);
                if(item) {
                    document.getElementById('dev-ref').value = item.ref || '';
                    document.getElementById('dev-summary').value = item.summary || '';
                    document.getElementById('dev-verse').value = item.verse || '';
                    document.getElementById('dev-app').value = item.app || '';
                    document.getElementById('dev-heart').value = item.heart || '';
                    document.getElementById('dev-prayer').value = item.prayer || '';
                    document.getElementById('btn-save-devotion').innerText = 'æ›´æ–°ç­†è¨˜';
                    document.getElementById('btn-cancel-devotion').classList.remove('hidden');
                }
            } else if (type === 'witty_prayers') {
                const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
                const item = list.find(i => i.id === id);
                if(item) {
                    document.getElementById('pray-topic').value = item.topic || '';
                    document.getElementById('pray-content').value = item.content || '';
                    document.getElementById('pray-status').value = item.status || 'praying';
                    document.getElementById('btn-save-prayer').innerText = 'æ›´æ–°ç´€éŒ„';
                    document.getElementById('btn-cancel-prayer').classList.remove('hidden');
                }
            } else if (type === 'witty_gratitude') {
                const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
                const item = list.find(i => i.id === id);
                if(item) {
                    document.getElementById('grat-content').value = item.content || '';
                    document.getElementById('btn-save-gratitude').innerText = 'æ›´æ–°ç´€éŒ„';
                    document.getElementById('btn-cancel-gratitude').classList.remove('hidden');
                }
            } else if (type === 'witty_emotions') {
                const list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
                const item = list.find(i => i.id === id);
                if(item) {
                    document.getElementById('emo-event').value = item.event || '';
                    document.getElementById('emo-belief').value = item.belief || '';
                    document.getElementById('emo-god').value = item.god || '';
                    document.getElementById('emo-prayer').value = item.prayer || '';
                    const tags = document.querySelectorAll('.emotion-chip');
                    tags.forEach(t => {
                        if (item.emotions && item.emotions.includes(t.innerText)) t.classList.add('selected');
                        else t.classList.remove('selected');
                    });
                    document.getElementById('btn-save-emotion').innerText = 'æ›´æ–°æ—¥è¨˜';
                    document.getElementById('btn-cancel-emotion').classList.remove('hidden');
                }
            } else if (type === 'witty_letters') { 
                const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
                const item = list.find(i => i.id === id);
                if(item) {
                    document.getElementById('letter-date').value = item.date || '';
                    document.getElementById('letter-content').value = item.content || '';
                    document.getElementById('btn-save-letter').innerText = 'æ›´æ–°ä¿¡ä»¶';
                    document.getElementById('btn-cancel-letter').classList.remove('hidden');
                }
            } else if (type === 'witty_blank_notes') {
                const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
                const item = list.find(i => i.id === id);
                if(item) {
                    document.getElementById('blank-content').value = item.content || '';
                    document.getElementById('btn-save-blank').innerText = 'æ›´æ–°ç­†è¨˜';
                    document.getElementById('btn-cancel-blank').classList.remove('hidden');
                }
            }
        }

        function cancelEdit(uiType) {
            editingId = null;
            editingKey = null;
            
            if (uiType === 'devotion' || !uiType) {
                ['dev-ref','dev-summary','dev-verse','dev-app','dev-heart','dev-prayer'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.value = '';
                });
                const btn = document.getElementById('btn-save-devotion');
                if(btn) btn.innerText = 'å„²å­˜ç­†è¨˜';
                const cBtn = document.getElementById('btn-cancel-devotion');
                if(cBtn) cBtn.classList.add('hidden');
            }
            if (uiType === 'prayer' || !uiType) {
                document.getElementById('pray-topic').value = '';
                document.getElementById('pray-content').value = '';
                const btn = document.getElementById('btn-save-prayer');
                if(btn) btn.innerText = 'ç´€éŒ„';
                const cBtn = document.getElementById('btn-cancel-prayer');
                if(cBtn) cBtn.classList.add('hidden');
            }
            if (uiType === 'gratitude' || !uiType) {
                document.getElementById('grat-content').value = '';
                const btn = document.getElementById('btn-save-gratitude');
                if(btn) btn.innerText = 'å­˜å…¥æ©å…¸ç½';
                const cBtn = document.getElementById('btn-cancel-gratitude');
                if(cBtn) cBtn.classList.add('hidden');
            }
            if (uiType === 'emotion' || !uiType) {
                ['emo-event','emo-belief','emo-god','emo-prayer'].forEach(id => document.getElementById(id).value = '');
                document.querySelectorAll('.emotion-chip').forEach(c => c.classList.remove('selected'));
                const btn = document.getElementById('btn-save-emotion');
                if(btn) btn.innerText = 'å®Œæˆæ—¥è¨˜';
                const cBtn = document.getElementById('btn-cancel-emotion');
                if(cBtn) cBtn.classList.add('hidden');
            }
            if (uiType === 'letter' || !uiType) {
                document.getElementById('letter-date').value = '';
                document.getElementById('letter-content').value = '';
                const btn = document.getElementById('btn-save-letter');
                if(btn) btn.innerText = 'æŠ•éä¿¡ä»¶';
                const cBtn = document.getElementById('btn-cancel-letter');
                if(cBtn) cBtn.classList.add('hidden');
            }
            if (uiType === 'blank' || !uiType) {
                document.getElementById('blank-content').value = '';
                const btn = document.getElementById('btn-save-blank');
                if(btn) btn.innerText = 'å„²å­˜ç­†è¨˜';
                const cBtn = document.getElementById('btn-cancel-blank');
                if(cBtn) cBtn.classList.add('hidden');
            }
        }

        // --- å„²å­˜é‚è¼¯ ---
        function saveDevotion() {
            const date = getSelectedDate();
            const ref = document.getElementById('dev-ref').value;
            const summary = document.getElementById('dev-summary').value;
            const verse = document.getElementById('dev-verse').value;
            const app = document.getElementById('dev-app').value;
            const heart = document.getElementById('dev-heart').value;
            const prayer = document.getElementById('dev-prayer').value;
            if(!ref && !verse) return alert('è«‹å¡«å¯«å…§å®¹');
            
            let list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            const newData = { id: editingId || Date.now(), date, ref, summary, verse, app, heart, prayer };

            if (editingId) {
                const index = list.findIndex(i => i.id === editingId);
                if(index !== -1) list[index] = newData;
            } else {
                list.unshift(newData);
            }
            saveData('witty_devotions', list);
            cancelEdit('devotion');
            renderDevotionList();
        }
        function renderDevotionList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            const filtered = list.filter(item => item.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(item => {
                // ä½¿ç”¨å…§åµŒ SVG
                html += `
                    <div class="journal-item">
                        <div class="font-bold text-[#6B8E23] mb-1">${item.ref || 'éˆä¿®ç­†è¨˜'}</div>
                        <div class="text-sm text-gray-600 whitespace-pre-wrap">${item.summary || item.verse || 'å…§å®¹...'}</div>
                        <div class="action-btns">
                            <button onclick="startEditing('witty_devotions', ${item.id})" class="action-btn" title="ç·¨è¼¯">${ICON_EDIT}</button>
                            <button onclick="deleteItem('witty_devotions', ${item.id})" class="action-btn delete" title="åˆªé™¤">${ICON_TRASH}</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('devotion-list').innerHTML = html;
        }

        function savePrayer() {
            const date = getSelectedDate();
            const topic = document.getElementById('pray-topic').value;
            const content = document.getElementById('pray-content').value;
            const status = document.getElementById('pray-status').value;
            if(!topic) return alert('è«‹å¡«å¯«ä¸»é¡Œ');
            let list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const newData = { id: editingId || Date.now(), date, topic, content, status };
            if (editingId) {
                const index = list.findIndex(i => i.id === editingId);
                if(index !== -1) list[index] = newData;
            } else { list.unshift(newData); }
            saveData('witty_prayers', list);
            cancelEdit('prayer');
            renderPrayerList();
        }
        function renderPrayerList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const filtered = list.filter(p => p.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(p => {
                const isDone = p.status === 'answered';
                html += `
                    <div class="journal-item border-l-4 ${isDone ? 'border-green-400' : 'border-yellow-400'}">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-[#3E3B39]">${p.topic}</h4>
                            <span class="text-xs ${isDone ? 'text-green-600' : 'text-yellow-600'} border px-1 rounded">${isDone ? 'å·²æˆå°±' : 'ç¦±å‘Šä¸­'}</span>
                        </div>
                        <p class="text-sm text-gray-600 whitespace-pre-wrap">${p.content}</p>
                        <div class="action-btns">
                            <button onclick="startEditing('witty_prayers', ${p.id})" class="action-btn" title="ç·¨è¼¯">${ICON_EDIT}</button>
                            <button onclick="deleteItem('witty_prayers', ${p.id})" class="action-btn delete" title="åˆªé™¤">${ICON_TRASH}</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('prayer-list-display').innerHTML = html;
        }

        function saveGratitude() {
            const date = getSelectedDate();
            const content = document.getElementById('grat-content').value;
            if(!content) return;
            let list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            const newData = { id: editingId || Date.now(), date, content };
            if (editingId) {
                const index = list.findIndex(i => i.id === editingId);
                if(index !== -1) list[index] = newData;
            } else { list.unshift(newData); }
            saveData('witty_gratitude', list);
            cancelEdit('gratitude');
            renderGratitudeList();
        }
        function renderGratitudeList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            const filtered = list.filter(g => g.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(g => { 
                html += `
                    <div class="journal-item">
                        <div class="text-sm text-[#3E3B39] whitespace-pre-wrap">${g.content}</div>
                        <div class="action-btns">
                            <button onclick="startEditing('witty_gratitude', ${g.id})" class="action-btn" title="ç·¨è¼¯">${ICON_EDIT}</button>
                            <button onclick="deleteItem('witty_gratitude', ${g.id})" class="action-btn delete" title="åˆªé™¤">${ICON_TRASH}</button>
                        </div>
                    </div>
                `; 
            });
            document.getElementById('gratitude-list').innerHTML = html;
        }

        function toggleEmotion(el) { el.classList.toggle('selected'); }
        function saveEmotion() {
            const date = getSelectedDate();
            const event = document.getElementById('emo-event').value;
            if(!event) return alert('è«‹å¡«å¯«äº‹ä»¶');
            const emotions = Array.from(document.querySelectorAll('.emotion-chip.selected')).map(el => el.innerText);
            const belief = document.getElementById('emo-belief').value;
            const god = document.getElementById('emo-god').value;
            const prayer = document.getElementById('emo-prayer').value;
            let list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
            const newData = { id: editingId || Date.now(), date, event, emotions, belief, god, prayer };
            if (editingId) {
                const index = list.findIndex(i => i.id === editingId);
                if(index !== -1) list[index] = newData;
            } else { list.unshift(newData); }
            saveData('witty_emotions', list);
            cancelEdit('emotion');
            renderEmotionList();
        }
        function renderEmotionList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
            const filtered = list.filter(e => e.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(item => {
                html += `
                    <div class="journal-item">
                        <div class="font-bold text-[#3E3B39] mb-1">${item.event}</div>
                        <div class="flex gap-1 mb-2 flex-wrap">${item.emotions.map(e => `<span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">${e}</span>`).join('')}</div>
                        <div class="text-xs text-gray-500">ä¿¡å¿µ: ${item.belief}</div>
                        <div class="action-btns">
                            <button onclick="startEditing('witty_emotions', ${item.id})" class="action-btn" title="ç·¨è¼¯">${ICON_EDIT}</button>
                            <button onclick="deleteItem('witty_emotions', ${item.id})" class="action-btn delete" title="åˆªé™¤">${ICON_TRASH}</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('emotion-list').innerHTML = html;
        }

        function saveLetter() {
            const createdDate = getSelectedDate();
            const date = document.getElementById('letter-date').value;
            const content = document.getElementById('letter-content').value;
            if(!date || !content) return alert('è«‹å¡«å¯«å®Œæ•´');
            let list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const newData = { id: editingId || Date.now(), createdDate, date, content, read: false };
            if (editingId) {
                const index = list.findIndex(i => i.id === editingId);
                if(index !== -1) {
                    list[index] = { ...list[index], ...newData }; 
                }
            } else {
                list.push(newData);
            }
            saveData('witty_letters', list);
            alert(editingId ? 'ä¿¡ä»¶å·²æ›´æ–°ï¼' : 'ä¿¡ä»¶å·²æŠ•éï¼');
            cancelEdit('letter');
            renderTimeCapsule(); renderLetterListDaily();
        }
        function renderLetterListDaily() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const filtered = list.filter(l => (l.createdDate === date) || (!l.createdDate && l.date === date)); 
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡å¯«ä¿¡ç´€éŒ„</p>';
            filtered.forEach(l => {
                html += `
                    <div class="journal-item">
                        <div class="text-xs text-gray-500 mb-1">é è¨ˆæ–¼ ${l.date} é–‹å•Ÿ</div>
                        <div class="text-sm text-[#3E3B39] line-clamp-2">${l.content}</div>
                        <div class="action-btns">
                            <button onclick="startEditing('witty_letters', ${l.id})" class="action-btn" title="ç·¨è¼¯">${ICON_EDIT}</button>
                            <button onclick="deleteItem('witty_letters', ${l.id})" class="action-btn delete" title="åˆªé™¤">${ICON_TRASH}</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('letter-list-daily').innerHTML = html;
        }
        function renderTimeCapsule() {
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const unlocked = list.filter(l => l.date <= today);
            const lockedCount = list.length - unlocked.length;
            const statusEl = document.getElementById('capsule-status');
            const badgeEl = document.getElementById('capsule-badge');
            const listEl = document.getElementById('capsule-list');
            if (unlocked.length > 0) {
                statusEl.innerHTML = `æœ‰ <span class="text-[#D85C42] font-bold">${unlocked.length}</span> å°ä¿¡å·²é€é”`;
                badgeEl.innerText = unlocked.length;
                badgeEl.classList.remove('hidden');
            } else if (lockedCount > 0) {
                statusEl.innerText = `${lockedCount} å°ä¿¡æ­£åœ¨æ—…è¡Œä¸­...`;
                badgeEl.classList.add('hidden');
            } else {
                statusEl.innerText = "å¯¶ç›’æ˜¯ç©ºçš„";
                badgeEl.classList.add('hidden');
            }
            let html = '';
            unlocked.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => {
                html += `
                    <div class="bg-white p-3 rounded-lg border border-[#8D7B68]/30 shadow-sm relative">
                        <div class="text-xs text-[#8D7B68] font-bold mb-1 flex justify-between items-center">
                            <span>ğŸ“… ä¾†è‡ª ${l.createdDate || 'éå»'} çš„ä¿¡</span>
                            <!-- å¯¶ç›’å…§çš„ä¿¡ä»¶ä¹ŸåŠ ä¸Šåˆªé™¤æŒ‰éˆ• -->
                            <button onclick="deleteItem('witty_letters', ${l.id})" class="text-gray-300 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                        <div class="text-sm text-[#3E3B39] whitespace-pre-wrap leading-relaxed">${l.content}</div>
                    </div>
                `;
            });
            listEl.innerHTML = html;
        }
        function toggleCapsuleList() { document.getElementById('capsule-list').classList.toggle('hidden'); }

        function saveBlankNote() {
            const date = getSelectedDate();
            const content = document.getElementById('blank-content').value;
            if(!content) return;
            let list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            const newData = { id: editingId || Date.now(), date, content };
            if (editingId) {
                const index = list.findIndex(i => i.id === editingId);
                if(index !== -1) list[index] = newData;
            } else { list.unshift(newData); }
            saveData('witty_blank_notes', list);
            cancelEdit('blank');
            renderBlankNoteList();
        }
        function renderBlankNoteList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            const filtered = list.filter(n => n.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(n => {
                html += `
                    <div class="journal-item">
                        <div class="text-sm text-[#3E3B39] whitespace-pre-wrap">${n.content}</div>
                        <div class="action-btns">
                            <button onclick="startEditing('witty_blank_notes', ${n.id})" class="action-btn" title="ç·¨è¼¯">${ICON_EDIT}</button>
                            <button onclick="deleteItem('witty_blank_notes', ${n.id})" class="action-btn delete" title="åˆªé™¤">${ICON_TRASH}</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('blank-note-list').innerHTML = html;
        }

        window.deleteItem = function(storageKey, id) {
            if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
            let list = JSON.parse(localStorage.getItem(storageKey) || '[]');
            list = list.filter(item => item.id !== id);
            saveData(storageKey, list);
            refreshAllLists();
            if (editingId === id) cancelEdit();
        };

        // åŒ¯å‡ºèˆ‡åŒ¯å…¥åŠŸèƒ½ (ä¿æŒåŸæ¨£ï¼Œç¢ºä¿èƒ½é‹ä½œ)
        function exportNotebook(key, title) {
            const data = localStorage.getItem(key);
            if (!data || data === '[]') return alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `witty_${title}_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importNotebook(input, key) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error("æ ¼å¼éŒ¯èª¤");
                    const oldData = JSON.parse(localStorage.getItem(key) || '[]');
                    const combined = [...importedData, ...oldData];
                    const unique = [];
                    const ids = new Set();
                    combined.forEach(item => {
                        if (item.id) { if (!ids.has(item.id)) { ids.add(item.id); unique.push(item); } } 
                        else { unique.push(item); }
                    });
                    localStorage.setItem(key, JSON.stringify(unique));
                    saveData(key, unique); 
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                    refreshAllLists();
                } catch (err) { alert('åŒ¯å…¥å¤±æ•—'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        init();
    </script>
</body>
</html>
