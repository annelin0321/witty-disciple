<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | æ ¡ç‰§å®¤</title>
    <link rel="icon" href="../assets/images/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../assets/images/favicon.svg">
    <meta name="apple-mobile-web-app-title" content="æ©Ÿæ™ºé–€å¾’">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/common.js"></script>
    
    <style>
        /* è† å›ŠæŒ‰éˆ•æ¨£å¼ */
        .chaplain-tab-btn {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            border: 1px solid rgba(107, 142, 35, 0.2);
            background-color: rgba(255, 255, 255, 0.5);
            color: #757575;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 1px solid rgba(107, 142, 35, 0.2); 
        }
        .chaplain-tab-btn:hover { background-color: rgba(255, 255, 255, 0.8); color: #6B8E23; }
        .chaplain-tab-btn.active {
            background-color: #6B8E23; color: white; border-color: #6B8E23;
            box-shadow: 0 4px 6px rgba(107, 142, 35, 0.2);
        }
        .notebook-card {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px);
            padding: 2rem; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); max-width: 42rem; margin: 0 auto;
        }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        @media screen and (max-width: 768px) {
            .form-input, input, textarea, select { font-size: 16px !important; }
        }
        .journal-item {
            background-color: rgba(255, 255, 255, 0.6); border: 1px solid #e5e7eb;
            border-radius: 12px; padding: 1rem; margin-bottom: 0.75rem; position: relative;
        }
        .journal-item:last-child { margin-bottom: 0; }
        .delete-btn {
            position: absolute; top: 0.75rem; right: 0.75rem; color: #d1d5db; transition: color 0.2s;
        }
        .delete-btn:hover { color: #ef4444; }
    </style>
</head>
<body class="pb-20" role="application">
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 hover:scale-110 transition-transform">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="#FDFBF7" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="50" cy="35" r="18" fill="#6B8E23" opacity="0.9"/>
                            <circle cx="35" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <circle cx="65" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <path d="M50 35 L 50 75" stroke="#8D7B68" stroke-width="4" stroke-linecap="round"/>
                            <path d="M35 45 L 65 45" stroke="#8D7B68" stroke-width="3" stroke-linecap="round"/>
                            <path d="M25 72 Q 50 82 75 72" stroke="#8D7B68" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                            <path d="M50 82 L 50 72" stroke="#8D7B68" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´»</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]"><i data-lucide="home" class="w-4 h-4"></i> å›é¦–é </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="../daily/index.html" class="nav-item">é€šè­˜ä¸­å¿ƒ</a>
                    <a href="../library/index.html" class="nav-item">åœ–æ›¸é¤¨</a>
                    <a href="index.html" class="nav-item active">æ ¡ç‰§å®¤</a>
                    <a href="../school/index.html" class="nav-item">å­¸éœ¸é¤Šæˆç­</a>
                    <a href="../games/index.html" class="nav-item">èª²å¤–æ´»å‹•</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <!-- é›²ç«¯åŒæ­¥ç‹€æ…‹åˆ— -->
        <div class="flex justify-end mb-4">
            <div id="auth-container" class="inline-flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-gray-200 shadow-sm text-sm">
                <span id="user-status" class="text-gray-500">æœªç™»å…¥ (åƒ…å­˜æœ¬æ©Ÿ)</span>
                <button id="btn-login" class="text-[#6B8E23] font-bold hover:underline" onclick="login()">Google ç™»å…¥åŒæ­¥</button>
                <button id="btn-logout" class="text-red-400 hover:underline hidden" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>
        <!-- ç‹€æ…‹æç¤º -->
        <div id="sync-status" class="text-right text-xs text-gray-400 mb-2 h-4"></div>

        <section id="section-prayers" class="page-section fade-in">
            <div id="chaplain-content"></div>
        </section>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // å¢åŠ  onSnapshot åŒ¯å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCHn_OgHIg553J-h6EOByNYKwwWfRX2i2k",
            authDomain: "witty-disciple.firebaseapp.com",
            projectId: "witty-disciple",
            storageBucket: "witty-disciple.firebasestorage.app",
            messagingSenderId: "714502326120",
            appId: "1:714502326120:web:946e7e50282b6945d7b8dd",
            measurementId: "G-16G920FLE2"
        };

        let app, auth, db, user = null;
        let unsubscribeListeners = []; // ç”¨ä¾†å­˜æ”¾ç›£è½å™¨ï¼Œç™»å‡ºæ™‚å–æ¶ˆ

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            onAuthStateChanged(auth, (currentUser) => {
                user = currentUser;
                updateAuthUI();
                if (user) {
                    setupRealtimeListeners(); // ç™»å…¥å¾Œå•Ÿå‹•å³æ™‚ç›£è½
                } else {
                    // ç™»å‡ºæ™‚å–æ¶ˆç›£è½
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];
                }
            });
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }

        window.login = async () => {
            if(!auth) return alert("Firebase æœªåˆå§‹åŒ–");
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error(error);
                if (error.code === 'auth/unauthorized-domain') {
                    alert(`ç¶²åŸŸæœªæˆæ¬Šã€‚\nè«‹è‡³ Firebase Console -> Authentication -> Settings -> Authorized domains æ–°å¢ï¼š\n${window.location.hostname}`);
                } else if (error.code !== 'auth/popup-closed-by-user') {
                    alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                }
            }
        };

        window.logout = async () => {
            if(!auth) return;
            await signOut(auth);
            alert("å·²ç™»å‡º");
            location.reload(); 
        };

        function updateAuthUI() {
            const statusEl = document.getElementById('user-status');
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            
            if (user) {
                statusEl.innerHTML = `<span class="text-green-600">â—</span> ${user.displayName}`;
                btnLogin.classList.add('hidden');
                btnLogout.classList.remove('hidden');
            } else {
                statusEl.innerHTML = `<span class="text-gray-400">â—</span> æœªç™»å…¥ (åƒ…å­˜æœ¬æ©Ÿ)`;
                btnLogin.classList.remove('hidden');
                btnLogout.classList.add('hidden');
            }
        }

        // --- æ ¸å¿ƒåŒæ­¥é‚è¼¯ (é›™å‘å³æ™‚) ---

        // 1. ä¸Šå‚³ (å¯«å…¥æ™‚å‘¼å«)
        window.syncToCloud = async (key, data) => {
            if (!user || !db) return;
            // é¡¯ç¤ºåŒæ­¥ä¸­...
            const statusEl = document.getElementById('sync-status');
            if(statusEl) statusEl.innerText = "æ­£åœ¨å„²å­˜è‡³é›²ç«¯...";
            
            try {
                const docRef = doc(db, "users", user.uid, "notes", key);
                await setDoc(docRef, { data: data }, { merge: true });
                if(statusEl) statusEl.innerText = "æ‰€æœ‰è®Šæ›´å·²å„²å­˜";
                setTimeout(() => { if(statusEl) statusEl.innerText = ""; }, 2000);
            } catch (e) {
                console.error("åŒæ­¥å¤±æ•—:", e);
                if(statusEl) statusEl.innerText = "é›²ç«¯å„²å­˜å¤±æ•— (è«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™)";
                
                if (e.code === 'permission-denied') {
                    alert('æ¬Šé™ä¸è¶³ï¼šç„¡æ³•å¯«å…¥è³‡æ–™åº«ã€‚\nè«‹ç¢ºèª Firebase Firestore Rules å·²è¨­å®šç‚ºå…è¨±ç™»å…¥ç”¨æˆ¶å¯«å…¥ã€‚');
                }
            }
        };

        // 2. å»ºç«‹å³æ™‚ç›£è½ (ç™»å…¥å¾Œè‡ªå‹•åŸ·è¡Œ)
        function setupRealtimeListeners() {
            const keys = ['witty_devotions', 'witty_prayers', 'witty_gratitude', 'witty_emotions', 'witty_letters', 'witty_blank_notes'];
            
            keys.forEach(key => {
                const docRef = doc(db, "users", user.uid, "notes", key);
                
                // å»ºç«‹ç›£è½å™¨
                const unsub = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data().data;
                        if (cloudData && Array.isArray(cloudData)) {
                            // æ”¶åˆ°é›²ç«¯æ›´æ–° -> å¯«å…¥ LocalStorage -> é‡æ–°æ¸²æŸ“ UI
                            // ç‚ºäº†é¿å…æœ¬åœ°å¯«å…¥è§¸ç™¼ç„¡é™è¿´åœˆï¼Œé€™è£¡æˆ‘å€‘ç›´æ¥æ›´æ–° storage ä¸¦æ¸²æŸ“
                            // æ³¨æ„ï¼šé€™æœƒè¦†è“‹æ‰æœ¬åœ°å‰›å¯«å…¥ä½†é‚„æ²’ä¸Šå‚³çš„è³‡æ–™ (è‹¥ç¶²è·¯æ¥µæ…¢)ï¼Œä½†åœ¨æ­£å¸¸ç‹€æ³ä¸‹é€™æ˜¯æ­£ç¢ºçš„åŒæ­¥è¡Œç‚º
                            localStorage.setItem(key, JSON.stringify(cloudData));
                            if (window.refreshAllLists) window.refreshAllLists();
                        }
                    }
                }, (error) => {
                    console.error("ç›£è½å¤±æ•—:", error);
                });
                
                unsubscribeListeners.push(unsub);
            });
            console.log("å·²å•Ÿå‹•é›²ç«¯å³æ™‚åŒæ­¥");
        }
    </script>

    <!-- æ¥­å‹™é‚è¼¯ -->
    <script>
        const PRAYERS_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/prayers.json';
        let prayersData = [];
        let currentTabId = 'tab-devotion'; 

        const emotionCategories = {
            "æ„‰æ‚…èˆ‡é€£çµ": ["å¹¸ç¦", "æ»¿è¶³", "èˆˆå¥®", "æ„Ÿæ¿€", "è‡ªè±ª", "æ¨‚è§€", "è¢«æ„›", "æ•¬ç•", "ç†±æƒ…", "å¹³éœ"],
            "æ†¤æ€’èˆ‡æ•µæ„": ["æ†¤æ€’", "ç…©èº", "æŒ«æŠ˜", "æ•µæ„", "æ†¤æ…¨", "æ¿€å‹•", "æš´æ€’", "ä¸å¹³"],
            "æ‚²å‚·èˆ‡å¤±è½": ["æ‚²å‚·", "æ†‚é¬±", "å¤±æœ›", "çµ•æœ›", "å“€æ…Ÿ", "å­¤ç¨", "ç„¡åŠ©", "å—å‚·"],
            "ææ‡¼èˆ‡ç„¦æ…®": ["ç„¦æ…®", "æ“”æ†‚", "ææ…Œ", "ç·Šå¼µ", "ææ‡¼", "ä¸å®‰", "è„†å¼±", "é©šåš‡"],
            "è‡ªè¦ºèˆ‡èªçŸ¥": ["ç¾æ„§", "å…§ç–š", "å°·å°¬", "å›°æƒ‘", "çŸ›ç›¾", "èŒ«ç„¶", "ç–²æ†Š", "å«‰å¦’"]
        };

        async function init() {
            try {
                const res = await fetch(PRAYERS_DATA_URL);
                prayersData = await res.json();
            } catch (e) { console.warn("Using default prayers"); }
            renderChaplainOffice();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('journal-date').value = today;
            refreshAllLists();
            if(window.lucide) lucide.createIcons();
        }

        // ä¿®æ”¹ï¼šå…ˆå­˜ Localï¼Œç„¶å¾ŒéåŒæ­¥è§¸ç™¼é›²ç«¯ä¸Šå‚³
        function saveData(key, newData) {
            localStorage.setItem(key, JSON.stringify(newData));
            if (window.syncToCloud) {
                window.syncToCloud(key, newData);
            }
        }

        function getBackupUI(storageKey, title) {
            return `
                <div class="mt-8 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                    <div class="flex items-start gap-3">
                        <div class="p-2 bg-yellow-100 rounded-full text-yellow-600 mt-1">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <h5 class="text-sm font-bold text-yellow-800 mb-1">è¨˜å¾—å‚™ä»½æ‚¨çš„${title}</h5>
                            <p class="text-xs text-yellow-700 mb-3 leading-relaxed">
                                è³‡æ–™åƒ…å„²å­˜åœ¨æ­¤è£ç½®ã€‚å»ºè­°ä½¿ç”¨ä¸Šæ–¹ Google ç™»å…¥é–‹å•Ÿé›²ç«¯åŒæ­¥ã€‚
                            </p>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="exportNotebook('${storageKey}', '${title}')" class="px-3 py-1.5 bg-white border border-yellow-300 rounded-lg hover:bg-yellow-100 text-yellow-900 text-xs transition-colors flex items-center gap-1 shadow-sm">
                                    <i data-lucide="download" class="w-3 h-3"></i> åŒ¯å‡ºå‚™ä»½
                                </button>
                                <button onclick="document.getElementById('import-${storageKey}').click()" class="px-3 py-1.5 bg-white border border-yellow-300 rounded-lg hover:bg-yellow-100 text-yellow-900 text-xs transition-colors flex items-center gap-1 shadow-sm">
                                    <i data-lucide="upload" class="w-3 h-3"></i> åŒ¯å…¥é‚„åŸ
                                </button>
                                <input type="file" id="import-${storageKey}" class="hidden" accept=".json" onchange="importNotebook(this, '${storageKey}')">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChaplainOffice() {
            const randomPrayer = prayersData.length > 0 ? prayersData[Math.floor(Math.random() * prayersData.length)] : { title: "å¯§éœç¦±æ–‡", content: "ç¥å•Šï¼Œè«‹è³œçµ¦æˆ‘å¯§éœ..." };
            const textContent = randomPrayer.fullText || randomPrayer.content || "";
            const formattedText = textContent.split('\n').map(line => `<div class="min-h-[1.5em]">${line}</div>`).join('');

            let emotionHtml = '';
            for (const [category, emotions] of Object.entries(emotionCategories)) {
                let typeClass = 'neutral';
                if(category.includes('æ„‰æ‚…')) typeClass = 'positive';
                else if(category.includes('æ†¤æ€’') || category.includes('æ‚²å‚·') || category.includes('ææ‡¼')) typeClass = 'negative';
                
                emotionHtml += `<div class="mb-3"><div class="emotion-group-title">${category}</div><div class="flex flex-wrap gap-1">${emotions.map(e => `<span class="emotion-chip ${typeClass}" onclick="toggleEmotion(this)">${e}</span>`).join('')}</div></div>`;
            }

            const html = `
                <div class="text-center mb-8"><h2 class="text-2xl font-serif text-[#3E3B39]">æ ¡ç‰§å®¤</h2><p class="eng-script text-[#8D7B68]">Chaplain's Office</p></div>
                <div class="stationery-card mb-12"><div class="flex flex-col items-center text-center mb-6"><h3 class="text-xl font-bold text-[#6B8E23] mb-2">${randomPrayer.title || randomPrayer.Title}</h3></div><div class="text-[#585858] font-light text-center grid gap-0.5 leading-relaxed mb-6">${formattedText}</div><div class="text-center"><button onclick="renderChaplainOffice()" class="text-xs text-[#8D7B68] hover:text-[#6B8E23] transition-colors flex items-center justify-center gap-1 mx-auto"><i data-lucide="refresh-cw" class="w-3 h-3"></i> æ›ä¸€å‰‡ç¦±å‘Š</button></div></div>
                <div class="flex justify-center mb-8"><div class="flex flex-wrap justify-center gap-2 w-full max-w-3xl"><button class="chaplain-tab-btn active" onclick="switchTab('tab-devotion', this)">éˆä¿®ç­†è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-prayer', this)">ç¦±å‘Šæ—¥è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-gratitude', this)">æ„Ÿæ©æ—¥è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-emotion', this)">æƒ…ç·’æ—¥è¨˜</button><button class="chaplain-tab-btn" onclick="switchTab('tab-letter', this)">æ™‚ç©ºè† å›Š</button><button class="chaplain-tab-btn" onclick="switchTab('tab-blank', this)">éˆæ„Ÿç­†è¨˜</button></div></div>
                <div class="flex justify-center mb-8 items-center gap-2 bg-white/40 p-2 rounded-lg inline-flex mx-auto border border-[#8D7B68]/20"><i data-lucide="calendar" class="w-4 h-4 text-[#8D7B68]"></i><label for="journal-date" class="text-sm font-bold text-[#3E3B39]">é¸æ“‡æ—¥æœŸï¼š</label><input type="date" id="journal-date" class="bg-white/80 border border-gray-300 rounded px-2 py-1 text-sm text-gray-600 focus:outline-none focus:border-[#6B8E23]" onchange="refreshAllLists()"></div>

                <div id="tab-devotion" class="chaplain-tab-content fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-6">è†è½ç¥è²éŸ³ï¼Œå›æ‡‰ç¥‚çš„æ„›ã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">ä»Šæ—¥ç¶“æ–‡</label><input type="text" class="form-input bg-white/50" placeholder="ä¾‹å¦‚ï¼šè©©ç¯‡ 23" id="dev-ref"></div><div class="form-group"><label class="form-label">ç¶“æ–‡å¤§æ„</label><textarea id="dev-summary" class="form-input" rows="3" placeholder="é€™æ®µç¶“æ–‡åœ¨èªªä»€éº¼..."></textarea></div><div class="form-group"><label class="form-label">æ„Ÿå‹•ç¶“æ–‡</label><input id="dev-verse" type="text" class="form-input" placeholder="å“ªä¸€å¥è©±æŠ“ä½äº†ä½ çš„å¿ƒï¼Ÿ"></div><div class="form-group"><label class="form-label">ç”Ÿæ´»æ‡‰ç”¨</label><textarea id="dev-app" class="form-input" rows="2" placeholder="å¦‚ä½•æ‡‰ç”¨åœ¨ç”Ÿæ´»ä¸­ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">å¤©çˆ¶å¿ƒæ„</label><textarea id="dev-heart" class="form-input" rows="2" placeholder="å¤©çˆ¶æƒ³å°ä½ èªªä»€éº¼ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">å›æ‡‰ç¦±å‘Š</label><textarea id="dev-prayer" class="form-input" rows="3" placeholder="è¦ªæ„›çš„å¤©çˆ¶..."></textarea></div><div class="text-center pt-2"><button onclick="saveDevotion()" class="nature-btn">å„²å­˜ç­†è¨˜</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥éˆä¿®ç´€éŒ„</h4><div id="devotion-list" class="space-y-3"></div></div>${getBackupUI('witty_devotions', 'éˆä¿®ç­†è¨˜')}</div></div>
                <div id="tab-prayer" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><div class="mb-6 space-y-4"><div class="form-group"><label class="form-label">ç¦±å‘Šä¸»é¡Œ</label><input id="pray-topic" type="text" class="form-input" placeholder="ä¾‹å¦‚ï¼šå®¶äººå¥åº·..."></div><div class="form-group"><label class="form-label">å…·é«”å…§å®¹</label><textarea id="pray-content" class="form-input" rows="3" placeholder="å‘ç¥è¨´èªª..."></textarea></div><div class="flex gap-2"><select id="pray-status" class="form-input w-auto"><option value="praying">ç¦±å‘Šä¸­</option><option value="answered">å·²æˆå°±</option></select><button onclick="savePrayer()" class="nature-btn flex-1 justify-center">ç´€éŒ„</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥ç¦±å‘Šç´€éŒ„</h4><div id="prayer-list-display" class="space-y-2"></div></div>${getBackupUI('witty_prayers', 'ç¦±å‘Šæ—¥è¨˜')}</div></div>
                <div id="tab-gratitude" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-4">æ•¸ç®—æ©å…¸ï¼Œçœ‹è¦‹ç¥çš„æ‰‹ã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">æ„Ÿæ©äº‹é …</label><textarea id="grat-content" class="form-input" rows="4" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å€¼å¾—æ„Ÿè¬çš„äº‹ï¼Ÿ"></textarea></div><div class="text-center"><button onclick="saveGratitude()" class="nature-btn">å­˜å…¥æ©å…¸ç½</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥æ„Ÿæ©ç´€éŒ„</h4><div id="gratitude-list" class="space-y-2 max-h-60 overflow-y-auto"></div></div>${getBackupUI('witty_gratitude', 'æ„Ÿæ©æ—¥è¨˜')}</div></div>
                <div id="tab-emotion" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-6">èª å¯¦é¢å°æƒ…ç·’ï¼Œå¸¶åˆ°ç¥é¢å‰ã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">äº‹ä»¶</label><input id="emo-event" type="text" class="form-input" placeholder="ç™¼ç”Ÿäº†ä»€éº¼å¼•ç™¼æƒ…ç·’çš„äº‹ï¼Ÿ"></div><div class="form-group"><label class="form-label">æƒ…ç·’æ¨™è¨»</label><div class="bg-white/50 p-4 rounded-lg border border-gray-200" id="emotion-tags">${emotionHtml}</div></div><div class="form-group"><label class="form-label">ä¿¡å¿µ</label><textarea id="emo-belief" class="form-input" rows="2" placeholder="ç•¶ä¸‹æˆ‘å¿ƒè£¡æ˜¯æ€éº¼æƒ³çš„ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">ç¥å¦‚ä½•çœ‹</label><textarea id="emo-god" class="form-input" rows="2" placeholder="ç¥çš„è©±èªæˆ–çœŸç†æ˜¯æ€éº¼èªªçš„ï¼Ÿ"></textarea></div><div class="form-group"><label class="form-label">å›æ‡‰ç¦±å‘Š</label><textarea id="emo-prayer" class="form-input" rows="3" placeholder="æ ¹æ“šæ–°çš„çœ‹è¦‹ï¼Œå‘ç¥ç¦±å‘Š..."></textarea></div><div class="text-center"><button onclick="saveEmotion()" class="nature-btn">å®Œæˆæ—¥è¨˜</button></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥æƒ…ç·’ç´€éŒ„</h4><div id="emotion-list" class="space-y-3"></div></div>${getBackupUI('witty_emotions', 'æƒ…ç·’æ—¥è¨˜')}</div></div>
                <div id="tab-letter" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-4">å¯«çµ¦æœªä¾†çš„è‡ªå·±ï¼Œä¿¡å¿ƒçš„å®£å‘Šã€‚</p><div class="space-y-4"><div class="form-group"><label class="form-label">é–‹å•Ÿæ—¥æœŸ</label><input type="date" id="letter-date" class="form-input"></div><div class="form-group"><label class="form-label">çµ¦æœªä¾†çš„ä¿¡</label><textarea id="letter-content" class="form-input" rows="6" placeholder="è¦ªæ„›çš„è‡ªå·±..."></textarea></div><div class="text-center"><button onclick="saveLetter()" class="nature-btn">æŠ•éä¿¡ä»¶</button><p class="text-xs text-gray-400 mt-2">ä¿¡ä»¶å°‡åœ¨æŒ‡å®šæ—¥æœŸå¾Œé–‹å•Ÿã€‚</p></div></div><div class="mt-8 pt-6 border-t border-gray-200/50"><div class="bg-white/40 rounded-xl p-4 text-center border border-[#8D7B68]/20"><div onclick="toggleCapsuleList()" class="cursor-pointer inline-block relative group"><div class="p-3 bg-[#FDFBF7] rounded-full border-2 border-[#8D7B68] shadow-sm group-hover:shadow-md transition-all"><i data-lucide="package" class="w-8 h-8 text-[#8D7B68]"></i></div><span id="capsule-badge" class="hidden absolute -top-1 -right-1 bg-[#D85C42] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm animate-bounce">!</span></div><h4 class="font-bold text-[#3E3B39] mt-2">æ™‚ç©ºå¯¶ç›’</h4><p id="capsule-status" class="text-xs text-gray-500 mt-1">ç›®å‰æ²’æœ‰ä¿¡ä»¶</p><div id="capsule-list" class="hidden mt-4 text-left space-y-3 max-h-60 overflow-y-auto"></div></div></div><div class="mt-8 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-3 text-sm">ğŸ“… ç•¶æ—¥å¯«ä¿¡ç´€éŒ„</h4><div id="letter-list-daily" class="space-y-2"></div></div>${getBackupUI('witty_letters', 'æ™‚ç©ºè† å›Š')}</div></div>
                <div id="tab-blank" class="chaplain-tab-content hidden fade-in"><div class="notebook-card text-left"><p class="text-center text-sm text-[#8D7B68] mb-4">éš¨æ‰‹è¨˜ä¸‹è–éˆçš„æ„Ÿå‹•æˆ–ç”Ÿæ´»çš„éˆæ„Ÿã€‚</p><div class="space-y-4"><div class="form-group"><textarea id="blank-content" class="form-input" rows="5" placeholder="åœ¨æ­¤è¼¸å…¥å…§å®¹..."></textarea></div><div class="text-center"><button onclick="saveBlankNote()" class="nature-btn">å„²å­˜ç­†è¨˜</button></div><div class="mt-4 pt-4 border-t border-gray-200/50"><h4 class="font-bold text-[#6B8E23] mb-2 text-sm">ğŸ“… ç•¶æ—¥éˆæ„Ÿç´€éŒ„</h4><div id="blank-note-list" class="space-y-2 max-h-60 overflow-y-auto"></div></div></div>${getBackupUI('witty_blank_notes', 'éˆæ„Ÿç­†è¨˜')}</div></div>
            `;
            document.getElementById('chaplain-content').innerHTML = html;
            renderPrayerList();
            renderGratitudeList();
            renderBlankNoteList();
            renderTimeCapsule();
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.chaplain-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.chaplain-tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            refreshAllLists();
        }

        function getSelectedDate() {
            const dateInput = document.getElementById('journal-date');
            return dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
        }

        function refreshAllLists() {
            window.refreshAllLists = refreshAllLists; 
            renderDevotionList(); renderPrayerList(); renderGratitudeList(); renderEmotionList(); renderLetterListDaily(); renderBlankNoteList(); renderTimeCapsule();
            if(window.lucide) lucide.createIcons();
        }

        function exportNotebook(key, title) {
            const data = localStorage.getItem(key);
            if (!data || data === '[]') return alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10);
            a.href = url;
            a.download = `witty_${title}_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importNotebook(input, key) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) throw new Error("æ ¼å¼éŒ¯èª¤");
                    const oldData = JSON.parse(localStorage.getItem(key) || '[]');
                    const combined = [...importedData, ...oldData];
                    const unique = [];
                    const ids = new Set();
                    combined.forEach(item => {
                        if (item.id) { if (!ids.has(item.id)) { ids.add(item.id); unique.push(item); } } 
                        else { unique.push(item); }
                    });
                    localStorage.setItem(key, JSON.stringify(unique));
                    saveData(key, unique); 
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                    refreshAllLists();
                } catch (err) { alert('åŒ¯å…¥å¤±æ•—'); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- 1. éˆä¿®ç­†è¨˜é‚è¼¯ ---
        function saveDevotion() {
            const date = getSelectedDate();
            const ref = document.getElementById('dev-ref').value;
            const summary = document.getElementById('dev-summary').value;
            const verse = document.getElementById('dev-verse').value;
            const app = document.getElementById('dev-app').value;
            const heart = document.getElementById('dev-heart').value;
            const prayer = document.getElementById('dev-prayer').value;
            if(!ref && !verse) return alert('è«‹å¡«å¯«å…§å®¹');
            const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            list.unshift({ id: Date.now(), date, ref, summary, verse, app, heart, prayer });
            saveData('witty_devotions', list);
            ['dev-ref','dev-summary','dev-verse','dev-app','dev-heart','dev-prayer'].forEach(id => document.getElementById(id).value = '');
            renderDevotionList();
        }
        function renderDevotionList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            const filtered = list.filter(item => item.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(item => {
                html += `<div class="journal-item"><div class="font-bold text-[#6B8E23] mb-1">${item.ref || 'éˆä¿®ç­†è¨˜'}</div><div class="text-sm text-gray-600 whitespace-pre-wrap">${item.summary || item.verse || 'å…§å®¹...'}</div><button onclick="deleteItem('witty_devotions', ${item.id})" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            document.getElementById('devotion-list').innerHTML = html;
        }

        // --- 2. ç¦±å‘Šæ—¥è¨˜é‚è¼¯ ---
        function savePrayer() {
            const date = getSelectedDate();
            const topic = document.getElementById('pray-topic').value;
            const content = document.getElementById('pray-content').value;
            const status = document.getElementById('pray-status').value;
            if(!topic) return alert('è«‹å¡«å¯«ä¸»é¡Œ');
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            list.unshift({ id: Date.now(), date, topic, content, status });
            saveData('witty_prayers', list);
            document.getElementById('pray-topic').value = '';
            document.getElementById('pray-content').value = '';
            renderPrayerList();
        }
        function renderPrayerList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const filtered = list.filter(p => p.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(p => {
                const isDone = p.status === 'answered';
                html += `<div class="journal-item border-l-4 ${isDone ? 'border-green-400' : 'border-yellow-400'}"><div class="flex justify-between items-start mb-1"><h4 class="font-bold text-[#3E3B39]">${p.topic}</h4><span class="text-xs ${isDone ? 'text-green-600' : 'text-yellow-600'} border px-1 rounded">${isDone ? 'å·²æˆå°±' : 'ç¦±å‘Šä¸­'}</span></div><p class="text-sm text-gray-600 whitespace-pre-wrap">${p.content}</p><button onclick="deleteItem('witty_prayers', ${p.id})" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            document.getElementById('prayer-list-display').innerHTML = html;
        }

        // --- 3. æ„Ÿæ©æ—¥è¨˜é‚è¼¯ ---
        function saveGratitude() {
            const date = getSelectedDate();
            const content = document.getElementById('grat-content').value;
            if(!content) return;
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            list.unshift({ id: Date.now(), date, content });
            saveData('witty_gratitude', list);
            document.getElementById('grat-content').value = '';
            renderGratitudeList();
        }
        function renderGratitudeList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            const filtered = list.filter(g => g.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(g => { 
                html += `<div class="journal-item"><div class="text-sm text-[#3E3B39] whitespace-pre-wrap">${g.content}</div><button onclick="deleteItem('witty_gratitude', ${g.id})" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`; 
            });
            document.getElementById('gratitude-list').innerHTML = html;
        }

        // --- 4. æƒ…ç·’æ—¥è¨˜é‚è¼¯ ---
        function toggleEmotion(el) { el.classList.toggle('selected'); }
        function saveEmotion() {
            const date = getSelectedDate();
            const event = document.getElementById('emo-event').value;
            if(!event) return alert('è«‹å¡«å¯«äº‹ä»¶');
            const emotions = Array.from(document.querySelectorAll('.emotion-chip.selected')).map(el => el.innerText);
            const belief = document.getElementById('emo-belief').value;
            const god = document.getElementById('emo-god').value;
            const prayer = document.getElementById('emo-prayer').value;
            const list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
            list.unshift({ id: Date.now(), date, event, emotions, belief, god, prayer });
            saveData('witty_emotions', list);
            document.getElementById('emo-event').value = '';
            document.getElementById('emo-belief').value = '';
            document.getElementById('emo-god').value = '';
            document.getElementById('emo-prayer').value = '';
            document.querySelectorAll('.emotion-chip').forEach(c => c.classList.remove('selected'));
            renderEmotionList();
        }
        function renderEmotionList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
            const filtered = list.filter(e => e.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(item => {
                html += `<div class="journal-item"><div class="font-bold text-[#3E3B39] mb-1">${item.event}</div><div class="flex gap-1 mb-2 flex-wrap">${item.emotions.map(e => `<span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">${e}</span>`).join('')}</div><div class="text-xs text-gray-500">ä¿¡å¿µ: ${item.belief}</div><button onclick="deleteItem('witty_emotions', ${item.id})" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            document.getElementById('emotion-list').innerHTML = html;
        }

        // --- 5. æ™‚ç©ºè† å›Š ---
        function saveLetter() {
            const createdDate = getSelectedDate();
            const date = document.getElementById('letter-date').value;
            const content = document.getElementById('letter-content').value;
            if(!date || !content) return alert('è«‹å¡«å¯«å®Œæ•´');
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            list.push({ id: Date.now(), createdDate, date, content, read: false });
            saveData('witty_letters', list);
            alert('ä¿¡ä»¶å·²æŠ•éï¼');
            document.getElementById('letter-content').value = '';
            renderTimeCapsule(); 
            renderLetterListDaily();
        }
        function renderLetterListDaily() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const filtered = list.filter(l => (l.createdDate === date) || (!l.createdDate && l.date === date)); 
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡å¯«ä¿¡ç´€éŒ„</p>';
            filtered.forEach(l => {
                html += `<div class="journal-item"><div class="text-xs text-gray-500 mb-1">é è¨ˆæ–¼ ${l.date} é–‹å•Ÿ</div><div class="text-sm text-[#3E3B39] line-clamp-2">${l.content}</div><button onclick="deleteItem('witty_letters', ${l.id})" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            document.getElementById('letter-list-daily').innerHTML = html;
        }
        function renderTimeCapsule() {
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const unlocked = list.filter(l => l.date <= today);
            const lockedCount = list.length - unlocked.length;
            const statusEl = document.getElementById('capsule-status');
            const badgeEl = document.getElementById('capsule-badge');
            const listEl = document.getElementById('capsule-list');
            if (unlocked.length > 0) {
                statusEl.innerHTML = `æœ‰ <span class="text-[#D85C42] font-bold">${unlocked.length}</span> å°ä¿¡å·²é€é”`;
                badgeEl.innerText = unlocked.length;
                badgeEl.classList.remove('hidden');
            } else if (lockedCount > 0) {
                statusEl.innerText = `${lockedCount} å°ä¿¡æ­£åœ¨æ—…è¡Œä¸­...`;
                badgeEl.classList.add('hidden');
            } else {
                statusEl.innerText = "å¯¶ç›’æ˜¯ç©ºçš„";
                badgeEl.classList.add('hidden');
            }
            let html = '';
            unlocked.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => {
                html += `<div class="bg-white p-3 rounded-lg border border-[#8D7B68]/30 shadow-sm relative"><div class="text-xs text-[#8D7B68] font-bold mb-1 flex justify-between items-center"><span>ğŸ“… ä¾†è‡ª ${l.createdDate || 'éå»'} çš„ä¿¡</span><button onclick="deleteItem('witty_letters', ${l.id})" class="text-gray-300 hover:text-red-400 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div><div class="text-sm text-[#3E3B39] whitespace-pre-wrap leading-relaxed">${l.content}</div></div>`;
            });
            listEl.innerHTML = html;
        }
        function toggleCapsuleList() { document.getElementById('capsule-list').classList.toggle('hidden'); }

        // --- 6. éˆæ„Ÿç­†è¨˜ ---
        function saveBlankNote() {
            const date = getSelectedDate();
            const content = document.getElementById('blank-content').value;
            if(!content) return;
            const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            list.unshift({ id: Date.now(), date, content });
            saveData('witty_blank_notes', list);
            document.getElementById('blank-content').value = '';
            renderBlankNoteList();
        }
        function renderBlankNoteList() {
            const date = getSelectedDate();
            const list = JSON.parse(localStorage.getItem('witty_blank_notes') || '[]');
            const filtered = list.filter(n => n.date === date);
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">ä»Šæ—¥ç„¡ç´€éŒ„</p>';
            filtered.forEach(n => {
                html += `<div class="journal-item"><div class="text-sm text-[#3E3B39] whitespace-pre-wrap">${n.content}</div><button onclick="deleteItem('witty_blank_notes', ${n.id})" class="delete-btn"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            document.getElementById('blank-note-list').innerHTML = html;
        }

        // --- å…±ç”¨åˆªé™¤å‡½å¼ ---
        window.deleteItem = function(storageKey, id) {
            if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) return;
            let list = JSON.parse(localStorage.getItem(storageKey) || '[]');
            list = list.filter(item => item.id !== id);
            saveData(storageKey, list);
            refreshAllLists();
        };

        init();
    </script>
</body>
</html>
