<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機智的門徒生活 | 校牧室</title>
    <link rel="icon" href="../assets/images/favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="../assets/js/common.js"></script>
</head>
<body class="pb-20">
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 bg-[#6B8E23] rounded-full flex items-center justify-center text-white shadow-md">
                        <i data-lucide="map" class="w-5 h-5"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">機智的門徒生活</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]">
                        <i data-lucide="home" class="w-4 h-4"></i> 回首頁
                    </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="../daily/index.html" class="nav-item">通識中心</a>
                    <a href="../library/index.html" class="nav-item">圖書館</a>
                    <a href="index.html" class="nav-item active">校牧室</a>
                    <a href="../school/index.html" class="nav-item">學霸養成班</a>
                    <a href="../games/index.html" class="nav-item">課外活動</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <section id="section-prayers" class="page-section fade-in">
            <div id="chaplain-content">
                <!-- JS 將在此處生成內容 -->
            </div>
        </section>
    </div>

    <script>
        const PRAYERS_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/prayers.json';
        let prayersData = [];
        let editingPrayerId = null;
        let currentPrayerFilter = 'all';

        // 情緒分類資料
        const emotionCategories = {
            "愉悅與連結": ["幸福", "滿足", "興奮", "感激", "自豪", "樂觀", "被愛", "敬畏", "熱情", "平靜"],
            "憤怒與敵意": ["憤怒", "煩躁", "挫折", "敵意", "憤慨", "激動", "暴怒", "不平"],
            "悲傷與失落": ["悲傷", "憂鬱", "失望", "絕望", "哀慟", "孤獨", "無助", "受傷"],
            "恐懼與焦慮": ["焦慮", "擔憂", "恐慌", "緊張", "恐懼", "不安", "脆弱", "驚嚇"],
            "自覺與認知": ["羞愧", "內疚", "尷尬", "困惑", "矛盾", "茫然", "疲憊", "嫉妒"]
        };

        async function init() {
            try {
                const res = await fetch(PRAYERS_DATA_URL);
                prayersData = await res.json();
            } catch (e) { console.warn("Using default prayers"); }
            renderChaplainOffice();
            if(window.lucide) lucide.createIcons();
        }

        function renderChaplainOffice() {
            // 隨機禱告
            const randomPrayer = prayersData.length > 0 ? prayersData[Math.floor(Math.random() * prayersData.length)] : { title: "寧靜禱文", content: "神啊，請賜給我寧靜，去接受我無法改變的事..." };
            
            // 產生情緒標籤 HTML
            let emotionHtml = '';
            for (const [category, emotions] of Object.entries(emotionCategories)) {
                let typeClass = 'neutral';
                if(category.includes('愉悅')) typeClass = 'positive';
                else if(category.includes('憤怒') || category.includes('悲傷') || category.includes('恐懼')) typeClass = 'negative';
                
                emotionHtml += `
                    <div class="emotion-group">
                        <div class="emotion-group-title">${category}</div>
                        <div class="flex flex-wrap gap-1">
                            ${emotions.map(e => `<span class="emotion-chip ${typeClass}" onclick="toggleEmotion(this)">${e}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            const html = `
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-serif text-[#3E3B39]">校牧室</h2>
                    <p class="eng-script text-[#8D7B68]">Chaplain's Office</p>
                </div>
                
                <!-- 今日禱告卡 -->
                <div class="stationery-card mb-12">
                    <div class="flex flex-col items-center text-center mb-6">
                        <h3 class="text-xl font-bold text-[#6B8E23] mb-2">${randomPrayer.title || randomPrayer.Title}</h3>
                    </div>
                    <p class="text-[#585858] leading-relaxed whitespace-pre-wrap mb-6 font-light text-center">${randomPrayer.fullText || randomPrayer.content}</p>
                    <div class="text-center"><button onclick="renderChaplainOffice()" class="text-xs text-[#8D7B68] hover:text-[#6B8E23] transition-colors">換一則禱告</button></div>
                </div>

                <!-- 工具 Tabs -->
                <div class="flex justify-center border-b border-gray-200 mb-8 overflow-x-auto">
                    <div class="flex whitespace-nowrap px-2 pb-1 gap-2">
                        <button class="chaplain-tab-btn active" onclick="switchTab('tab-devotion', this)">靈修筆記</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-prayer', this)">禱告日記</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-gratitude', this)">感恩日記</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-emotion', this)">情緒日記</button>
                        <button class="chaplain-tab-btn" onclick="switchTab('tab-letter', this)">時空膠囊</button>
                    </div>
                </div>

                <!-- 1. 靈修筆記 (Devotion) -->
                <div id="tab-devotion" class="chaplain-tab-content fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">聆聽神聲音，回應祂的愛。</p>
                        
                        <label class="form-label">今日經文 / 進度</label>
                        <input type="text" class="form-input bg-gray-100/50" placeholder="例如：詩篇 23" id="dev-ref">

                        <label class="form-label">經文大意 (Summary)</label>
                        <textarea id="dev-summary" class="form-input" rows="3" placeholder="試著用自己的話寫下這段經文在說什麼..."></textarea>

                        <label class="form-label">最有感動的一句經文 (Rhema)</label>
                        <input id="dev-verse" type="text" class="form-input" placeholder="哪一句話抓住了你的心？">

                        <label class="form-label">生活應用 (Application)</label>
                        <textarea id="dev-app" class="form-input" rows="2" placeholder="這段經文如何應用在我今天的生活中？"></textarea>

                        <label class="form-label">天父的心意 (Father's Heart)</label>
                        <textarea id="dev-heart" class="form-input" rows="2" placeholder="透過這段經文，天父想對你說什麼？"></textarea>

                        <label class="form-label">回應禱告 (Response)</label>
                        <textarea id="dev-prayer" class="form-input" rows="3" placeholder="親愛的天父..."></textarea>
                        
                        <div class="text-center mt-4">
                            <button onclick="saveDevotion()" class="nature-btn">儲存筆記</button>
                        </div>
                    </div>
                </div>

                <!-- 2. 禱告日記 (Prayer) -->
                <div id="tab-prayer" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <div class="mb-6 space-y-3">
                            <input id="pray-topic" type="text" class="form-input" placeholder="禱告主題...">
                            <textarea id="pray-content" class="form-input" rows="3" placeholder="具體內容..."></textarea>
                            <div class="flex gap-2">
                                <select id="pray-status" class="form-input w-auto"><option value="praying">禱告中</option><option value="answered">已成就</option></select>
                                <button onclick="savePrayer()" class="nature-btn flex-1 justify-center">紀錄</button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-[#6B8E23]">我的清單</h4>
                            <div class="flex gap-1 text-sm">
                                <button onclick="filterPrayers('all')" class="filter-btn active" id="f-all">全部</button>
                                <button onclick="filterPrayers('praying')" class="filter-btn" id="f-praying">禱告中</button>
                            </div>
                        </div>
                        <div id="prayer-list-display" class="space-y-2"></div>
                    </div>
                </div>

                <!-- 3. 感恩日記 (Gratitude) -->
                <div id="tab-gratitude" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto text-center">
                        <p class="text-sm text-[#8D7B68] mb-4">數算恩典，看見神的手。</p>
                        <textarea id="grat-content" class="form-input" rows="4" placeholder="今天發生了什麼值得感謝的事？"></textarea>
                        <button onclick="saveGratitude()" class="nature-btn mt-2">存入恩典罐</button>
                        <div id="gratitude-list" class="mt-6 text-left space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- 4. 情緒日記 (Emotion) -->
                <div id="tab-emotion" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto">
                        <p class="text-center text-sm text-[#8D7B68] mb-6">誠實面對情緒，帶到神面前。</p>
                        
                        <label class="form-label">事件 (Event)</label>
                        <input id="emo-event" type="text" class="form-input" placeholder="發生了什麼引發情緒的事？">

                        <label class="form-label">情緒標註 (Emotion)</label>
                        <div class="mb-4 bg-white/50 p-4 rounded-lg border border-gray-200" id="emotion-tags">
                            ${emotionHtml}
                        </div>

                        <label class="form-label">我以為 / 我相信 (Belief)</label>
                        <textarea id="emo-belief" class="form-input" rows="2" placeholder="當下我心裡是怎麼想的？"></textarea>

                        <label class="form-label">神如何看 (God's View)</label>
                        <textarea id="emo-god" class="form-input" rows="2" placeholder="神的話語或真理是怎麼說的？"></textarea>

                        <label class="form-label">回應禱告 (Prayer)</label>
                        <textarea id="emo-prayer" class="form-input" rows="3" placeholder="根據新的看見，向神禱告..."></textarea>

                        <div class="text-center mt-4">
                            <button onclick="saveEmotion()" class="nature-btn">完成日記</button>
                        </div>
                    </div>
                </div>

                <!-- 5. 時空膠囊 (Letter) -->
                <div id="tab-letter" class="chaplain-tab-content hidden fade-in">
                    <div class="bg-white/60 p-6 rounded-xl border border-gray-100 shadow-sm max-w-2xl mx-auto text-center">
                        <p class="text-sm text-[#8D7B68] mb-4">寫給未來的自己，信心的宣告。</p>
                        <input type="date" id="letter-date" class="form-input mb-2">
                        <textarea id="letter-content" class="form-input" rows="4" placeholder="親愛的自己..."></textarea>
                        <button onclick="saveLetter()" class="nature-btn mt-2">投遞信件</button>
                        <p class="text-xs text-gray-400 mt-4">信件將在指定日期後開啟。</p>
                    </div>
                </div>
            `;
            document.getElementById('chaplain-content').innerHTML = html;
            renderPrayerList();
            renderGratitudeList();
        }

        function switchTab(id, btn) {
            document.querySelectorAll('.chaplain-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.chaplain-tab-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- 靈修功能 ---
        function saveDevotion() {
            const ref = document.getElementById('dev-ref').value;
            const summary = document.getElementById('dev-summary').value;
            const verse = document.getElementById('dev-verse').value;
            const app = document.getElementById('dev-app').value;
            const heart = document.getElementById('dev-heart').value;
            const prayer = document.getElementById('dev-prayer').value;

            if(!ref && !verse) return alert('請至少填寫經文或感動經句');

            const list = JSON.parse(localStorage.getItem('witty_devotions') || '[]');
            list.unshift({
                id: Date.now(), date: new Date().toLocaleDateString(),
                ref, summary, verse, app, heart, prayer
            });
            localStorage.setItem('witty_devotions', JSON.stringify(list));
            
            // Clear fields
            document.getElementById('dev-summary').value = '';
            document.getElementById('dev-verse').value = '';
            document.getElementById('dev-app').value = '';
            document.getElementById('dev-heart').value = '';
            document.getElementById('dev-prayer').value = '';
            
            alert('靈修筆記已儲存！');
        }

        // --- 禱告功能 ---
        function savePrayer() {
            const topic = document.getElementById('pray-topic').value;
            const content = document.getElementById('pray-content').value;
            const status = document.getElementById('pray-status').value;
            if(!topic) return alert('請填寫主題');

            const prayers = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            prayers.unshift({ id: Date.now(), date: new Date().toLocaleDateString(), topic, content, status });
            localStorage.setItem('witty_prayers', JSON.stringify(prayers));
            
            document.getElementById('pray-topic').value = '';
            document.getElementById('pray-content').value = '';
            renderPrayerList();
        }

        function renderPrayerList() {
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            const filtered = currentPrayerFilter === 'all' ? list : list.filter(p => p.status === currentPrayerFilter);
            
            let html = filtered.length ? '' : '<p class="text-center text-gray-400 text-sm">暫無紀錄</p>';
            filtered.forEach(p => {
                const isDone = p.status === 'answered';
                html += `
                    <div class="prayer-item-card ${isDone ? 'answered' : ''}">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-[#3E3B39]">${p.topic}</h4>
                            <span class="text-xs ${isDone ? 'text-green-600' : 'text-yellow-600'} border px-1 rounded">${isDone ? '已成就' : '禱告中'}</span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${p.content}</p>
                        <div class="mt-2 text-right">
                            <button onclick="deletePrayer(${p.id})" class="text-xs text-red-400 hover:text-red-600">刪除</button>
                        </div>
                    </div>`;
            });
            const el = document.getElementById('prayer-list-display');
            if(el) el.innerHTML = html;
        }

        function deletePrayer(id) {
            if(!confirm('確定刪除？')) return;
            const list = JSON.parse(localStorage.getItem('witty_prayers') || '[]');
            localStorage.setItem('witty_prayers', JSON.stringify(list.filter(p => p.id !== id)));
            renderPrayerList();
        }

        function filterPrayers(type) {
            currentPrayerFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`f-${type}`).classList.add('active');
            renderPrayerList();
        }

        // --- 感恩日記 ---
        function saveGratitude() {
            const content = document.getElementById('grat-content').value;
            if(!content) return;
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            list.unshift({ date: new Date().toLocaleDateString(), content });
            localStorage.setItem('witty_gratitude', JSON.stringify(list));
            document.getElementById('grat-content').value = '';
            renderGratitudeList();
        }

        function renderGratitudeList() {
            const list = JSON.parse(localStorage.getItem('witty_gratitude') || '[]');
            let html = '';
            list.forEach(g => {
                html += `<div class="p-3 bg-white/50 rounded border border-gray-100 text-sm"><span class="text-xs text-gray-400 block">${g.date}</span>${g.content}</div>`;
            });
            const el = document.getElementById('gratitude-list');
            if(el) el.innerHTML = html;
        }

        // --- 情緒日記 ---
        function toggleEmotion(el) {
            el.classList.toggle('selected');
        }

        function saveEmotion() {
            const event = document.getElementById('emo-event').value;
            if(!event) return alert('請填寫事件');
            
            // 收集選中的情緒
            const emotions = Array.from(document.querySelectorAll('.emotion-chip.selected')).map(el => el.innerText);
            const belief = document.getElementById('emo-belief').value;
            const god = document.getElementById('emo-god').value;
            const prayer = document.getElementById('emo-prayer').value;

            const list = JSON.parse(localStorage.getItem('witty_emotions') || '[]');
            list.unshift({
                id: Date.now(), date: new Date().toLocaleDateString(),
                event, emotions, belief, god, prayer
            });
            localStorage.setItem('witty_emotions', JSON.stringify(list));

            // Clear
            document.getElementById('emo-event').value = '';
            document.getElementById('emo-belief').value = '';
            document.getElementById('emo-god').value = '';
            document.getElementById('emo-prayer').value = '';
            document.querySelectorAll('.emotion-chip').forEach(c => c.classList.remove('selected'));
            
            alert('情緒日記已完成！');
        }

        // --- 時空膠囊 ---
        function saveLetter() {
            const date = document.getElementById('letter-date').value;
            const content = document.getElementById('letter-content').value;
            if(!date || !content) return alert('請填寫完整');
            const list = JSON.parse(localStorage.getItem('witty_letters') || '[]');
            list.push({ date, content, read: false });
            localStorage.setItem('witty_letters', JSON.stringify(list));
            alert('信件已投遞！');
            document.getElementById('letter-content').value = '';
        }

        init();
    </script>
</body>
</html>
