<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | åœ–æ›¸é¤¨</title>
    <link rel="icon" href="../assets/images/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../assets/images/favicon.svg">
    <meta name="apple-mobile-web-app-title" content="æ©Ÿæ™ºé–€å¾’">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <style>
        /* ç¶“æ–‡é¸å–æ¨£å¼ */
        .verse-text {
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-left: 4px solid transparent;
            line-height: 1.8;
            scroll-margin-top: 100px; /* é ç•™æ²å‹•ç©ºé–“ï¼Œé¿å…è¢«ç½®é ‚æ¨™é¡Œæ“‹ä½ */
        }
        .verse-text:hover {
            background-color: rgba(0,0,0,0.03);
        }
        /* é¸å–ç‹€æ…‹ (é»æ“Š) */
        .verse-text.selected {
            background-color: rgba(107, 142, 35, 0.15); 
            border-left-color: #6B8E23;
        }
        /* é«˜äº®ç‹€æ…‹ (æœå°‹è·³è½‰) */
        .verse-text.highlighted {
            background-color: #FEF9C3; /* é»ƒè‰²èƒŒæ™¯ */
            border-left-color: #EAB308; /* é»ƒè‰²é‚Šæ¡† */
            font-weight: 500;
        }
        
        /* æ‡¸æµ®è¤‡è£½æŒ‰éˆ• (FAB) */
        #copy-fab {
            position: absolute; 
            bottom: 2rem; 
            right: 2rem;
            background-color: #3E3B39; 
            color: white;
            padding: 0.8rem 1.5rem; 
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none; 
            align-items: center; 
            gap: 0.5rem;
            z-index: 60; 
            cursor: pointer; 
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: bold;
            font-size: 0.95rem;
        }
        #copy-fab:hover { background-color: #6B8E23; transform: translateY(-2px); }
        #copy-fab.show { display: flex; }
        
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* è¤‡è£½æˆåŠŸæç¤º Toast */
        #toast-msg {
            position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px;
            font-size: 0.85rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 70;
        }
        #toast-msg.show { opacity: 1; }
    </style>
</head>
<body class="pb-20">
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-white/60 to-transparent pointer-events-none"></div>
    </div>

    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 hover:scale-110 transition-transform">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="#FDFBF7" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="50" cy="35" r="18" fill="#6B8E23" opacity="0.9"/>
                            <circle cx="35" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <circle cx="65" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <path d="M50 35 L 50 75" stroke="#8D7B68" stroke-width="4" stroke-linecap="round"/>
                            <path d="M35 45 L 65 45" stroke="#8D7B68" stroke-width="3" stroke-linecap="round"/>
                            <path d="M25 72 Q 50 82 75 72" stroke="#8D7B68" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                            <path d="M50 82 L 50 72" stroke="#8D7B68" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´»</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]"><i data-lucide="home" class="w-4 h-4"></i> å›é¦–é </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="../daily/index.html" class="nav-item">é€šè­˜ä¸­å¿ƒ</a>
                    <a href="index.html" class="nav-item active">åœ–æ›¸é¤¨</a>
                    <a href="../chaplain/index.html" class="nav-item">æ ¡ç‰§å®¤</a>
                    <a href="../school/index.html" class="nav-item">å­¸éœ¸é¤Šæˆç­</a>
                    <a href="../games/index.html" class="nav-item">èª²å¤–æ´»å‹•</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <section id="section-verses" class="page-section fade-in">
            <div id="blessing-container" class="mb-12">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-serif text-[#6B8E23]">ä»Šæ—¥é‡‘å¥</h2>
                    <p class="text-xs text-[#8D7B68] tracking-widest mt-1">BLESSING VERSE</p>
                </div>
                <div id="blessing-card-area">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="w-full h-px bg-[rgba(214,210,204,0.6)] my-10"></div>

            <div id="bible-browser" class="bible-browser-container">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-serif text-[#3E3B39]">è–ç¶“è—æ›¸é–£</h2>
                </div>
                <div class="search-box">
                    <input type="text" id="bible-search-input" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: æ„›, å…‰)..." class="search-input" onkeypress="handleSearch(event)">
                    <button onclick="performSearch()" class="search-btn"><i data-lucide="search" class="w-4 h-4"></i></button>
                </div>
                <div id="bible-display-area" class="bg-[rgba(255,255,255,0.4)] backdrop-blur-md p-6 rounded-lg border border-[rgba(255,255,255,0.6)] min-h-[300px]">
                    <div class="text-center text-gray-400 py-10">
                        <i data-lucide="loader-2" class="w-12 h-12 mx-auto mb-2 animate-spin text-[#6B8E23]"></i>
                        <p>æ­£åœ¨æ¬é‹è–ç¶“æ›¸å·...</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal (å«è¤‡è£½æŒ‰éˆ•) -->
    <div id="bible-modal" onclick="closeBibleModal(event)">
        <!-- æµ®å‹•è¤‡è£½æŒ‰éˆ• -->
        <button id="copy-fab" onclick="copyVerses()">
            <i data-lucide="copy" class="w-4 h-4"></i>
            <span id="copy-text">è¤‡è£½</span>
        </button>

        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="closeBibleModal()" class="absolute top-4 right-4 flex items-center justify-center gap-1 text-xs text-[#6B8E23] hover:text-[#556B2F] bg-[#F1F3F2] px-3 py-1.5 rounded-full z-50 border border-[#6B8E23]/20 shadow-sm">
                <i data-lucide="x" class="w-3 h-3"></i> é—œé–‰
            </button>
            <div class="text-center mb-6 mt-2">
                <h3 id="modal-title" class="text-2xl font-serif text-[#3E3B39] font-bold px-12 leading-tight"></h3>
                <div class="w-12 h-px bg-[#8D7B68] mx-auto mt-3"></div>
                <p class="text-xs text-gray-400 mt-2">ğŸ’¡ é»æ“Šç¶“æ–‡å¯é¸å–ä¸¦è¤‡è£½</p>
            </div>
            <div id="modal-body" class="text-lg text-[#4e342e] leading-relaxed"></div>
        </div>
    </div>
    
    <!-- æç¤ºè¨Šæ¯ -->
    <div id="toast-msg">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { if (window.lucide) { lucide.createIcons(); } });

        const BIBLE_DB_URL = 'https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db';
        let db = null;
        let isDbLoading = false;
        let dbCols = {};
        
        let selectedVerses = new Set(); 

        async function initBibleDB() {
            if (db) return db;
            if (isDbLoading) return new Promise(resolve => {
                const check = setInterval(() => { if(db || !isDbLoading) { clearInterval(check); resolve(db); } }, 100);
            });

            isDbLoading = true;
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm` });
                const response = await fetch(BIBLE_DB_URL);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));
                
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'")[0].values;
                let validTable = tables.find(t => /bible|verse|scripture/i.test(t[0]));
                if (!validTable) validTable = tables.find(t => t[0] !== 'sqlite_sequence');
                const tableName = validTable ? validTable[0] : tables[0][0];
                
                const cols = db.exec(`PRAGMA table_info(${tableName})`)[0].values.map(r=>r[1]);
                
                dbCols = {
                    tableName: tableName,
                    book: cols.find(c => /book|b|æ›¸|vol/i.test(c)) || cols[0],
                    chap: cols.find(c => /chapter|chap|c|ç« /i.test(c)) || cols[1],
                    ver: cols.find(c => /verse|v|ç¯€/i.test(c)) || cols[2],
                    text: cols.find(c => /lection|content|text|scripture|ç¶“æ–‡|ç¶“æ–‡/i.test(c)) || cols[cols.length - 1]
                };
                return db;
            } catch (err) { console.error("DB Error", err); return null; } finally { isDbLoading = false; }
        }

        function parseBibleReference(text) {
            if (!text) return null;
            text = text.replace(/[\(\)\uff08\uff09]/g, ' ').replace(/ï¼š/g, ':').trim();
            const bookPat = "([1-3]?\\s?[\\u4e00-\\u9fa5]{1,15}|[1-3]?\\s?[a-zA-Z]+)";
            const chapVersePat = "(\\d+)\\s*:\\s*(\\d+)(?:\\s*[-â€“~]\\s*(\\d+))?";
            const cvRegex = new RegExp(`${bookPat}\\s*${chapVersePat}`, 'g');
            let match = null;
            while ((match = cvRegex.exec(text)) !== null) { let lastMatch = match; return { book: lastMatch[1].trim(), chapter: parseInt(lastMatch[2]), verse: parseInt(lastMatch[3]), endVerse: lastMatch[4] ? parseInt(lastMatch[4]) : parseInt(lastMatch[3]) }; }
            const chapRangePat = "(\\d+)\\s*[-â€“~]\\s*(\\d+)";
            const rangeRegex = new RegExp(`${bookPat}\\s*${chapRangePat}`, 'g');
            while ((match = rangeRegex.exec(text)) !== null) { return { book: match[1].trim(), chapter: parseInt(match[2]), verse: 1, endVerse: null, endChapter: parseInt(match[3]) }; }
            const chapRegex = new RegExp(`${bookPat}\\s*(\\d+)\\s*$`, 'g'); 
            while ((match = chapRegex.exec(text)) !== null) { return { book: match[1].trim(), chapter: parseInt(match[2]), verse: 1, endVerse: null }; }
            return null;
        }

        async function openScripture(reference, highlightVerse = null) {
            reference = reference.replace(/\(.*\)/, '').trim();
            selectedVerses.clear(); 
            updateCopyBtn();

            const modal = document.getElementById('bible-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            modal.classList.add('show');
            modalBody.innerHTML = `<div class="flex justify-center py-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[#8D7B68]"></i></div>`;
            if(window.lucide) lucide.createIcons();

            const database = await initBibleDB();
            if (!database) { modalBody.innerHTML = `<p class="text-center text-red-500">è³‡æ–™åº«è®€å–ä¸­...</p>`; return; }

            try {
                const parsed = parseBibleReference(reference);
                const getSubtitle = () => {
                    if (!parsed) return reference;
                    let s = `${parsed.book} ç¬¬ ${parsed.chapter} ç« `;
                    if (parsed.endChapter) s += `-${parsed.endChapter} ç« `;
                    // å¦‚æœæœ‰é«˜äº®ç¯€æ•¸ (æœå°‹çµæœ)ï¼Œæ¨™é¡Œé¡¯ç¤ºæ•´ç« ï¼Œä½†å…§å®¹æœƒæ¨™è¨»
                    // æ³¨æ„ï¼šä¸å†é¡¯ç¤º "1-3ç¯€"ï¼Œå› ç‚ºæˆ‘å€‘ç¾åœ¨ç¸½æ˜¯é¡¯ç¤ºæ•´ç« 
                    return s;
                };

                // ä¿®æ”¹ï¼šå¦‚æœæŒ‡å®šäº†é«˜äº®ç¯€æ•¸ (highlightVerse)ï¼Œæˆ–æ˜¯åªæœ‰å–®ç¯€/ç¯„åœï¼Œæˆ‘å€‘éƒ½æ”¹ç‚ºæŸ¥è©¢ã€Œæ•´ç« ã€
                // ç„¶å¾Œåœ¨æ¸²æŸ“æ™‚åŠ ä¸Š highlighted class
                if (parsed) {
                    // ç¸½æ˜¯æŸ¥è©¢æ•´ç« ï¼Œä¸¦ä¾ç¯€æ•¸æ’åº (CAST AS INTEGER é‡è¦ï¼)
                    const query = `SELECT ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND ${dbCols.chap} = ${parsed.chapter} ORDER BY CAST(${dbCols.ver} AS INTEGER)`;
                    
                    const res = database.exec(query);
                    if (res.length > 0) {
                        let html = '';
                        res[0].values.forEach(row => {
                            const v = row[0], t = row[1];
                            
                            // åˆ¤æ–·æ˜¯å¦é«˜äº®
                            // 1. æŒ‡å®šå–®ç¯€ (æœå°‹çµæœ)
                            let isHighlight = (highlightVerse && v === highlightVerse);
                            
                            // 2. ç¯„åœå¼•ç”¨ (ä¾‹å¦‚ 3:16-18)ï¼Œå¦‚æœåœ¨ç¯„åœå…§ä¹Ÿé«˜äº®
                            if (!isHighlight && !highlightVerse) {
                                if (parsed.endVerse && v >= parsed.verse && v <= parsed.endVerse) {
                                    isHighlight = true;
                                } else if (!parsed.endVerse && parsed.verse && v === parsed.verse && reference.includes(':')) {
                                    // å–®ç¯€å¼•ç”¨ (ç„¡ç¯„åœ)
                                    isHighlight = true;
                                }
                            }

                            const highlightClass = isHighlight ? 'highlighted' : '';
                            const idAttr = `id="verse-${v}"`; // ç”¨æ–¼æ²å‹•å®šä½
                            
                            const refString = `${parsed.book} ${parsed.chapter}:${v}`;
                            html += `<p ${idAttr} class="verse-text ${highlightClass}" onclick="toggleVerse(this)" data-ref="${refString}" data-text="${t}"><span class="verse-num">${v}</span>${t}</p>`;
                        });
                        
                        modalTitle.innerText = getSubtitle();
                        modalBody.innerHTML = html;
                        
                        // è‡ªå‹•æ²å‹•åˆ°ç›®æ¨™ç¯€æ•¸
                        const targetV = highlightVerse || parsed.verse || 1;
                        setTimeout(() => {
                            const target = document.getElementById(`verse-${targetV}`);
                            if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);

                    } else {
                        modalBody.innerHTML = `<p class="text-center py-6">æ‰¾ä¸åˆ°ç¶“æ–‡è³‡æ–™</p>`;
                    }
                } else {
                    modalTitle.innerText = reference;
                    modalBody.innerHTML = `<p class="text-center py-6">ç„¡æ³•è§£æç¶“æ–‡æ ¼å¼</p>`;
                }
            } catch (e) {
                console.error(e);
                modalBody.innerHTML = `<p class="text-center text-red-500">è®€å–éŒ¯èª¤</p>`;
            }
        }

        function closeBibleModal(event) {
            if (event && event.target.closest('.modal-content') && event.target.id !== 'bible-modal') return;
            document.getElementById('bible-modal').classList.remove('show');
            selectedVerses.clear();
            updateCopyBtn();
        }

        function toggleVerse(el) {
            el.classList.toggle('selected');
            const ref = el.getAttribute('data-ref');
            const text = el.getAttribute('data-text');
            
            if (el.classList.contains('selected')) {
                selectedVerses.add({ ref, text, el }); 
            } else {
                for (let item of selectedVerses) {
                    if (item.ref === ref) {
                        selectedVerses.delete(item);
                        break;
                    }
                }
            }
            updateCopyBtn();
        }

        function updateCopyBtn() {
            const btn = document.getElementById('copy-fab');
            const countSpan = document.getElementById('copy-text');
            if (selectedVerses.size > 0) {
                btn.classList.add('show');
                countSpan.innerText = `è¤‡è£½ (${selectedVerses.size})`;
            } else {
                btn.classList.remove('show');
            }
        }

        function copyVerses() {
            if (selectedVerses.size === 0) return;
            const sortedVerses = Array.from(selectedVerses).sort((a, b) => {
                return (a.el.offsetTop - b.el.offsetTop);
            });
            const textToCopy = sortedVerses.map(v => `${v.ref} ${v.text}`).join('\n');
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast();
                document.querySelectorAll('.verse-text.selected').forEach(el => el.classList.remove('selected'));
                selectedVerses.clear();
                updateCopyBtn();
            }).catch(err => { alert('è¤‡è£½å¤±æ•—'); });
        }

        function showToast() {
            const toast = document.getElementById('toast-msg');
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2000);
        }

        // --- æœ¬é é‚è¼¯ ---
        const BLESSING_VERSES_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/blessing-verses.json';
        
        async function init() {
            if(window.lucide) lucide.createIcons();
            fetchBlessingVerses();
            renderBibleBrowserHome();
        }

        async function fetchBlessingVerses() {
            try {
                const res = await fetch(BLESSING_VERSES_URL);
                const data = await res.json();
                if(data.length > 0) {
                    const item = data[Math.floor(Math.random() * data.length)];
                    let text = item['å®Œæ•´ç¶“æ–‡'] || item['scripture'] || '';
                    let ref = item['ref'] || item['reference'] || item['source'] || item['å‡ºè™•'] || '';
                    
                    if (!ref && text) {
                        const match = text.match(/[ï¼ˆ(](.*?)[\)ï¼‰]$/);
                        if (match) {
                            ref = match[1];
                            text = text.replace(match[0], '').trim();
                        } else {
                            const parsed = parseBibleReference(text);
                            if (parsed) {
                                ref = `${parsed.book} ${parsed.chapter}:${parsed.verse}`;
                                const startRegex = new RegExp(`^${parsed.book}\\s*${parsed.chapter}[:ï¼š]${parsed.verse}`, 'i');
                                text = text.replace(startRegex, '').trim();
                            }
                        }
                    }
                    
                    let chapterRef = '';
                    let btnLabel = 'é–±è®€æ•´ç« ';
                    
                    if (ref) {
                        btnLabel = `${ref} | é–±è®€æ•´ç« `;
                        const p = parseBibleReference(ref);
                        if (p) {
                            chapterRef = `${p.book} ${p.chapter}`;
                        } else {
                            chapterRef = ref.split(/[:ï¼š]/)[0]; 
                        }
                    }

                    document.getElementById('blessing-card-area').innerHTML = `
                        <div class="verse-card-highlight">
                            <p class="text-xl font-serif text-[#3E3B39] leading-relaxed mb-6 text-center font-bold">${text}</p>
                            ${ref ? `
                                <div class="flex justify-center animate-fadeIn">
                                    <button onclick="openScripture('${chapterRef}')" class="nature-btn mt-2 group flex items-center gap-2">
                                        <i data-lucide="book-open" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> 
                                        <span>${btnLabel}</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    if(window.lucide) lucide.createIcons();
                }
            } catch (e) {
                document.getElementById('blessing-card-area').innerHTML = '<p class="text-center text-gray-400">ä»Šæ—¥é‡‘å¥é‹é€ä¸­...</p>';
            }
        }

        async function renderBibleBrowserHome() {
            const container = document.getElementById('bible-display-area');
            const database = await initBibleDB();
            if (!database) {
                container.innerHTML = '<p class="text-center text-red-500">è³‡æ–™åº«è®€å–å¤±æ•—</p>';
                return;
            }

            try {
                const res = database.exec(`SELECT DISTINCT ${dbCols.book} FROM ${dbCols.tableName}`);
                const books = [...new Set(res[0].values.flat())];

                let html = '<div class="bible-book-grid">';
                books.forEach(book => {
                    html += `<div class="bible-book-item" onclick="renderChapters('${book}')">${book}</div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            } catch (e) { console.error(e); }
        }

        async function renderChapters(book) {
            const container = document.getElementById('bible-display-area');
            const database = await initBibleDB();
            const res = database.exec(`SELECT DISTINCT ${dbCols.chap} FROM ${dbCols.tableName} WHERE ${dbCols.book} = '${book}'`);
            const chapters = [...new Set(res[0].values.flat())].sort((a,b) => a - b);

            let html = `
                <div class="mb-4 flex items-center gap-2">
                    <button onclick="renderBibleBrowserHome()" class="text-sm text-[#6B8E23] hover:underline">< è¿”å›æ›¸å·</button>
                    <span class="font-bold text-[#3E3B39]">> ${book}</span>
                </div>
                <div class="chapter-grid">
            `;
            chapters.forEach(c => {
                html += `<div class="chapter-item" onclick="openScripture('${book} ${c}')">${c}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function performSearch() {
            const keyword = document.getElementById('bible-search-input').value.trim();
            if(!keyword) { renderBibleBrowserHome(); return; }
            
            const container = document.getElementById('bible-display-area');
            container.innerHTML = '<div class="text-center py-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto text-[#6B8E23]"></i></div>';
            if(window.lucide) lucide.createIcons();

            const database = await initBibleDB();
            const query = `SELECT ${dbCols.book}, ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.text} LIKE '%${keyword}%' LIMIT 30`;
            const res = database.exec(query);

            if (res.length === 0) {
                container.innerHTML = `<p class="text-center py-10">æ‰¾ä¸åˆ°ã€Œ${keyword}ã€ç›¸é—œç¶“æ–‡</p><button onclick="renderBibleBrowserHome()" class="block mx-auto text-[#6B8E23]">è¿”å›ç›®éŒ„</button>`;
                return;
            }

            let html = `<div class="mb-4 flex justify-between"><span class="text-sm text-gray-500">æœå°‹çµæœ</span><button onclick="renderBibleBrowserHome()" class="text-sm text-[#6B8E23]">è¿”å›ç›®éŒ„</button></div><div class="space-y-2">`;
            res[0].values.forEach(row => {
                const b=row[0], c=row[1], v=row[2], t=row[3];
                // é€™è£¡çš„ onclick æœƒå‚³å…¥ highlightVerse = v
                html += `<div class="search-result-item" onclick="openScripture('${b} ${c}:${v}', ${v})">
                            <div class="text-xs text-[#6B8E23] font-bold mb-1">${b} ${c}:${v}</div>
                            <div class="text-[#3E3B39] text-sm">${t}</div>
                         </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function handleSearch(e) { if(e.key === 'Enter') performSearch(); }
        
        function closeBibleModal(event) {
            if (event && event.target.closest('.modal-content') && event.target.id !== 'bible-modal') return;
            const modal = document.getElementById('bible-modal');
            if(modal) modal.classList.remove('show');
            selectedVerses.clear();
            updateCopyBtn();
        }

        init();
    </script>
</body>
</html>
