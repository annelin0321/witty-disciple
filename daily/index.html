<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機智的門徒生活 | 通識中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <!-- 引入共用 JS -->
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/bible-db.js"></script>
</head>
<body class="pb-20">
    
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-white/60 to-transparent pointer-events-none"></div>
    </div>

    <!-- 導覽列 (已新增首頁按鈕) -->
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 bg-[#6B8E23] rounded-full flex items-center justify-center text-white shadow-md">
                        <i data-lucide="map" class="w-5 h-5"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">機智的門徒生活</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]">
                        <i data-lucide="home" class="w-4 h-4"></i> 回首頁
                    </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="index.html" class="nav-item active">通識中心</a>
                    <a href="../library/index.html" class="nav-item">圖書館</a>
                    <a href="../chaplain/index.html" class="nav-item">校牧室</a>
                    <a href="../school/index.html" class="nav-item">學霸養成班</a>
                    <a href="../games/index.html" class="nav-item">課外活動</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <div id="loading" class="flex flex-col items-center justify-center py-20 text-[#8D7B68]">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4 text-[#6B8E23]"></i>
            <p class="text-sm tracking-widest">正在準備今日的靈糧...</p>
        </div>

        <div id="main-content" class="min-h-[500px] opacity-0 transition-opacity duration-1000">
            <section id="section-today" class="page-section fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-serif text-[#3E3B39] mb-2">通識中心</h1>
                    <p class="eng-script text-[#8D7B68]">Daily Manna</p>
                </div>
                <div class="stationery-card">
                    <div id="daily-content" class="flex flex-col items-center justify-center text-center w-full"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- 簡易經文 Modal -->
    <div id="bible-modal" onclick="closeBibleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="closeBibleModal()" class="absolute top-6 right-6 flex items-center justify-center gap-1 text-xs text-[#6B8E23] hover:text-[#556B2F] bg-[#F1F3F2] px-4 py-1.5 rounded-full z-50">
                <i data-lucide="x" class="w-3 h-3"></i> 關閉
            </button>
            <div class="text-center mb-6">
                <h3 id="modal-title" class="text-2xl font-serif text-[#3E3B39] font-bold">經文閱讀</h3>
                <div class="w-12 h-px bg-[#8D7B68] mx-auto mt-2"></div>
            </div>
            <div id="modal-body" class="text-lg text-[#4e342e]"></div>
        </div>
    </div>

    <script>
        const DEVOTION_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/devotionals.json';
        let devotionalsData = [];
        const bibleReadingPlan = {};

        // 1. 生成讀經進度表 (完整版範例)
        function generateReadingPlan() {
            // 這裡為了示範，生成整年的假資料邏輯，實際可替換為完整 JSON
            // 為了讓 demo 每天都有資料，我們用簡單的演算法生成
            const books = ["創世記", "出埃及記", "利未記", "民數記", "申命記", "馬太福音", "馬可福音", "路加福音", "約翰福音"];
            for(let m=1; m<=12; m++) {
                for(let d=1; d<=31; d++) {
                    bibleReadingPlan[`${m}-${d}`] = {
                        ot: `${books[m%5]} ${d}`,
                        nt: `${books[5 + (d%4)]} ${d}`,
                        ps: `詩篇 ${d}`,
                        pr: `箴言 ${d}`
                    };
                }
            }
        }

        async function init() {
            generateReadingPlan();
            try {
                const response = await fetch(DEVOTION_DATA_URL);
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').classList.remove('opacity-0');
                
                const c = { devotionals:[] };
                data.forEach(i => {
                    let t = ''; 
                    for(let k in i) if(/title|name/i.test(k)) t = i[k].toLowerCase();
                    if(!t.includes('遊戲')) c.devotionals.push(i); 
                });
                
                devotionalsData = c.devotionals;
                window.sortedDevotionals = devotionalsData; 
                renderDailyDevotional(devotionalsData);
            } catch(e) { console.error(e); }
        }

        function renderDailyDevotional(items) {
            const container = document.getElementById('daily-content');
            const dObj = new Date();
            const today = `${(dObj.getMonth()+1).toString().padStart(2,'0')}-${dObj.getDate().toString().padStart(2,'0')}`;
            const plan = bibleReadingPlan[`${dObj.getMonth()+1}-${dObj.getDate()}`];
            let html = '';

            // 讀經進度區塊
            if (plan) {
                html += `
                    <div class="mb-10 text-center w-full">
                        <div class="inline-block px-6 py-2 border-b-2 border-[#6B8E23] mb-6">
                            <h2 class="text-2xl font-serif text-[#3E3B39] tracking-widest">今日課表</h2>
                            <p class="text-xs text-[#8D7B68] uppercase mt-1">Today's Schedule (${today})</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl mx-auto px-2">
                            ${['ot','nt','ps','pr'].map(k => `
                                <button onclick="openScripture('${plan[k]}')" class="reading-plan-btn">
                                    <span class="label">${k.toUpperCase()} TESTAMENT</span>
                                    <span class="content">${plan[k]}</span>
                                    <i data-lucide="book-open"></i>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    <div class="divider-water opacity-50 mb-10 w-full"></div>
                `;
            }

            // 靈修文章區塊
            // 簡單過濾：顯示第一筆資料作為示範，或者根據日期過濾
            // 這裡為了確保有內容顯示，若無當天資料則顯示第一筆
            let todayItems = items.filter(i => {
                let k = Object.keys(i).find(key => /date|time|日期/i.test(key));
                // 這裡簡化日期比對邏輯
                return true; 
            });
            
            if(todayItems.length > 0) {
                // 只顯示第一篇，避免太長
                html += generateSingleDevotionalHtml(todayItems[0]);
                html += `<div class="mt-8"><button onclick="showFullSchedule()" class="nature-btn">查看更多靈修筆記</button></div>`;
            } else {
                 html += `<div class="py-10 text-[#8D7B68]">今日暫無額外靈修文章</div>`;
            }
            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        // 靈修內容生成邏輯 (處理詩歌與連結)
        function generateSingleDevotionalHtml(item) {
             let contentHtml = `<div class="text-left w-full space-y-6 text-[#585858] font-light text-lg">`;
             let buttonsArray = []; 
             let skipKeys = []; 

             const keys = Object.keys(item);
             let titleKey = keys.find(k => /title|name|標題|名稱/i.test(k)) || 'No Title';
             contentHtml += `<h2 class="text-3xl font-serif text-[#3E3B39] mb-4 text-center">${item[titleKey]}</h2>`;
             
             // 處理連結與詩歌
             const songNameKey = keys.find(k => /^(song|hymn|worship|praise|詩歌|敬拜|讚美)$/i.test(k));
             const linkKey = keys.find(k => /^(link|url|video|youtube|連結)$/i.test(k));

             if (songNameKey && linkKey && item[linkKey]) {
                 buttonsArray.push({ type: 'link', url: item[linkKey], text: item[songNameKey] });
                 skipKeys.push(songNameKey, linkKey);
             }

             keys.forEach(k => {
                 if (k === titleKey || /date|time/.test(k)) return;
                 if (skipKeys.includes(k)) return;
                 const val = item[k];
                 if (typeof val === 'string' && val.startsWith('http')) {
                      buttonsArray.push({ type: 'link', url: val, text: k });
                 } else {
                      contentHtml += `<p class="whitespace-pre-wrap">${val}</p>`;
                 }
             });
             
             contentHtml += `</div>`; 
             
             if (buttonsArray.length > 0) {
                 contentHtml += `<div class="mt-10 pt-6 border-t border-[rgba(107,142,35,0.2)] w-full flex flex-col gap-4 items-center">`;
                 buttonsArray.forEach(btn => {
                      contentHtml += `
                        <a href="${btn.url}" target="_blank" class="w-full max-w-md block group">
                            <div class="bg-[#6B8E23] hover:bg-[#556B2F] text-white rounded-2xl py-3 px-4 text-center shadow-md flex items-center justify-center gap-2">
                                <span class="text-sm font-light opacity-90">今日點播</span>
                                <span class="text-lg font-medium truncate">${btn.text}</span>
                                <i data-lucide="headphones" class="w-5 h-5"></i>
                            </div>
                        </a>`;
                 });
                 contentHtml += `</div>`;
             }
             return contentHtml;
        }

        function showFullSchedule() {
             const c = document.getElementById('daily-content');
             let h = '<div class="space-y-2 text-left w-full max-w-lg mx-auto">';
             window.sortedDevotionals.forEach((i, idx) => {
                 let tKey = Object.keys(i).find(key => /title|name/.test(key));
                 h += `<div onclick="renderSpecificItem(${idx})" class="p-3 border rounded cursor-pointer hover:bg-white/50 bg-white/30 truncate">${i[tKey]}</div>`;
             });
             h += '</div><div class="text-center mt-4"><button onclick="renderDailyDevotional(window.sortedDevotionals)" class="nature-btn">返回今日</button></div>';
             c.innerHTML = h;
        }

        function renderSpecificItem(idx) {
             const item = window.sortedDevotionals[idx];
             document.getElementById('daily-content').innerHTML = generateSingleDevotionalHtml(item) + '<div class="text-center mt-6"><button onclick="showFullSchedule()" class="nature-btn">返回列表</button></div>';
             if(window.lucide) lucide.createIcons();
        }

        init();
    </script>
</body>
</html>
