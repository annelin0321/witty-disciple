<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機智的門徒生活 | 通識中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <!-- 注意：這裡需要回到上一層目錄抓 css -->
    <link rel="stylesheet" href="../assets/css/style.css">
    <!-- 引入 SQL.js (為了支援開啟經文 Modal) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body class="pb-20">

    <!-- 背景裝飾 -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <svg class="absolute bottom-0 w-full h-64 text-[#C5C9C7] opacity-60" viewBox="0 0 1200 250" preserveAspectRatio="none" fill="currentColor">
            <path d="M0 250 C 300 100 500 280 800 120 C 1000 60 1100 200 1200 150 L 1200 250 L 0 250 Z" opacity="0.5"/>
            <path d="M0 250 C 150 180 300 240 450 200 C 600 160 750 220 900 190 C 1050 160 1200 220 1200 250 L 0 250 Z" opacity="0.8"/>
        </svg>
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-white/60 to-transparent pointer-events-none"></div>
    </div>

    <!-- 導覽列 -->
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-12 h-12 relative text-[#3E3B39]">
                        <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full">
                            <circle cx="50" cy="50" r="45" stroke="#D6D2CC" />
                            <path d="M20 80 C 20 80 40 85 50 80 C 60 85 80 80 80 80" stroke="#3E3B39" />
                            <path d="M35 75 L 35 55" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="35" cy="50" r="10" fill="#6B8E23" fill-opacity="0.1" stroke="#6B8E23"/>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">機智的門徒生活</span>
                        <span class="text-[0.65rem] text-[#706C66] tracking-[0.2em] uppercase">Life in the Forest</span>
                    </div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-1">
                    <!-- 注意路徑：現在我們在 daily 資料夾內 -->
                    <a href="index.html" class="nav-item active">
                        <i data-lucide="book-open-check" class="w-4 h-4"></i> 通識中心
                    </a>
                    <a href="../library/index.html" class="nav-item">
                        <i data-lucide="library" class="w-4 h-4"></i> 圖書館
                    </a>
                    <a href="../chaplain/index.html" class="nav-item">
                        <i data-lucide="church" class="w-4 h-4"></i> 校牧室
                    </a>
                    <a href="../school/index.html" class="nav-item">
                        <i data-lucide="graduation-cap" class="w-4 h-4"></i> 學霸養成班
                    </a>
                    <a href="../games/index.html" class="nav-item">
                        <i data-lucide="tent" class="w-4 h-4"></i> 課外活動
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容區 -->
    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <div id="loading" class="flex flex-col items-center justify-center py-20 text-[#8D7B68]">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4 text-[#6B8E23]"></i>
            <p class="text-sm tracking-widest">正在準備今日的靈糧...</p>
        </div>

        <div id="main-content" class="min-h-[500px] opacity-0 transition-opacity duration-1000">
            <section id="section-today" class="page-section fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-serif text-[#3E3B39] mb-2">通識中心</h1>
                    <p class="eng-script text-[#8D7B68]">Daily Manna</p>
                </div>
                <div class="stationery-card">
                    <div id="daily-content" class="flex flex-col items-center justify-center text-center"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- 簡易經文 Modal (用於顯示點擊進度時的提示) -->
    <div id="bible-modal" onclick="closeBibleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="closeBibleModal()" class="absolute top-6 right-6 flex items-center justify-center gap-1 text-xs text-[#6B8E23] hover:text-[#556B2F] transition-colors bg-[#F1F3F2] px-4 py-1.5 rounded-full shadow-sm z-50">
                <i data-lucide="x" class="w-3 h-3"></i> <span>關閉</span>
            </button>
            <div class="text-center mb-6">
                <h3 id="modal-title" class="text-2xl font-serif text-[#3E3B39] font-bold">經文閱讀</h3>
                <div class="w-12 h-px bg-[#8D7B68] mx-auto mt-2"></div>
            </div>
            <div id="modal-body" class="text-lg text-[#4e342e]"></div>
        </div>
    </div>

    <script>
        try { if (window.lucide) window.lucide.createIcons(); } catch (e) {}

        const DEVOTION_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/devotionals.json';
        const BIBLE_DB_URL = 'https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db';
        let db = null;
        let devotionalsData = [];
        const bibleReadingPlan = {};

        // 生成讀經計畫 (這裡僅保留部分範例，與原檔案一致)
        function generateReadingPlan() {
            const janData = [
                {d:1, ot:"創世記 1-2", nt:"馬太福音 1", ps:"詩篇 1", pr:"箴言 1:1-6"},
                {d:2, ot:"創世記 3-5", nt:"馬太福音 2", ps:"詩篇 2", pr:"箴言 1:7-9"},
                {d:3, ot:"創世記 6-8", nt:"馬太福音 3", ps:"詩篇 3", pr:"箴言 1:10-19"},
                // ... 省略中間以節省長度，實際使用時可複製完整的 JanData ...
                {d:30, ot:"出埃及記 19-21", nt:"馬太福音 19:1-15", ps:"詩篇 25:1-11", pr:"箴言 8:1-11"},
                {d:31, ot:"出埃及記 22-24", nt:"馬太福音 19:16-30", ps:"詩篇 25:12-22", pr:"箴言 8:12-13"}
            ];
            janData.forEach(day => { bibleReadingPlan[`1-${day.d}`] = day; });
        }

        async function init() {
            generateReadingPlan();
            try {
                const response = await fetch(DEVOTION_DATA_URL);
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').classList.remove('opacity-0');
                
                // 分類資料
                const c = { devotionals:[] };
                data.forEach(i => {
                    let t = ''; 
                    for(let k in i) if(/title|name/i.test(k)) t = i[k].toLowerCase();
                    if(!t.includes('遊戲')) c.devotionals.push(i); 
                });
                
                devotionalsData = c.devotionals;
                // 將資料掛載到 window 以供 showFullSchedule 使用
                window.sortedDevotionals = devotionalsData; 
                renderDailyDevotional(devotionalsData);
            } catch(e) { console.error(e); }
        }

        function getTodayString() {
            const d = new Date();
            return `${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
        }
        
        function extractMonthDay(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('T') && dateStr.includes('Z')) {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const taipeiTime = new Date(date.getTime() + 8 * 60 * 60 * 1000);
                    const mm = (taipeiTime.getUTCMonth() + 1).toString().padStart(2, '0');
                    const dd = taipeiTime.getUTCDate().toString().padStart(2, '0');
                    return `${mm}-${dd}`;
                }
            }
            let s = dateStr.replace(/[^\d\-\/\.]/g,'');
            let p = s.split(/[-/.]/).filter(x=>x);
            if(p.length>=2) return `${parseInt(p[p.length-2]).toString().padStart(2,'0')}-${parseInt(p[p.length-1]).toString().padStart(2,'0')}`;
            return null;
        }

        function renderDailyDevotional(items) {
            const container = document.getElementById('daily-content');
            const today = getTodayString();
            const dObj = new Date();
            const m = dObj.getMonth() + 1;
            const d = dObj.getDate();
            const plan = bibleReadingPlan[`${m}-${d}`];
            let html = '';

            // Render Reading Plan
            if (plan) {
                html += `
                    <div class="mb-10 text-center w-full">
                        <div class="inline-block px-6 py-2 border-b-2 border-[#6B8E23] mb-6">
                            <h2 class="text-2xl font-serif text-[#3E3B39] tracking-widest">今日課表</h2>
                            <p class="text-xs text-[#8D7B68] uppercase mt-1">Today's Schedule (${today})</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl mx-auto px-2">
                            <button onclick="openScripture('${plan.ot}')" class="reading-plan-btn"><span class="label">OLD TESTAMENT</span><span class="content">${plan.ot}</span><i data-lucide="book-open"></i></button>
                            <button onclick="openScripture('${plan.nt}')" class="reading-plan-btn"><span class="label">NEW TESTAMENT</span><span class="content">${plan.nt}</span><i data-lucide="book-open"></i></button>
                            <button onclick="openScripture('${plan.ps}')" class="reading-plan-btn"><span class="label">PSALMS</span><span class="content">${plan.ps}</span><i data-lucide="book-open"></i></button>
                            <button onclick="openScripture('${plan.pr}')" class="reading-plan-btn"><span class="label">PROVERBS</span><span class="content">${plan.pr}</span><i data-lucide="book-open"></i></button>
                        </div>
                    </div>
                    <div class="divider-water opacity-50 mb-10 w-full"></div>
                `;
            }

            // Render Devotionals
            const todayItems = items.filter(i => {
                let k = Object.keys(i).find(key => /date|time|日期/i.test(key));
                return k && extractMonthDay(i[k]) === today;
            });
            
            if(todayItems.length > 0) {
                todayItems.forEach(i => html += generateSingleDevotionalHtml(i));
            } else if (!plan) {
                 html += `<div class="py-10"><p class="text-[#8D7B68]">今日暫無課程 (${today})</p><button onclick="showFullSchedule()" class="nature-btn mt-4">查看課表</button></div>`;
            }
            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }

        // 簡化版內容生成 (複製自原檔案)
        function generateSingleDevotionalHtml(item) {
             let contentHtml = `<div class="text-left w-full space-y-6 text-[#585858] font-light text-lg">`;
             let buttonsArray = []; 
             let skipKeys = []; 

             const keys = Object.keys(item);
             let titleKey = keys.find(k => /title|name|標題|名稱/i.test(k)) || 'No Title';
             const title = item[titleKey];
             contentHtml += `<h2 class="text-3xl font-serif text-[#3E3B39] mb-4 text-center">${title}</h2>`;
             
             // 1. Intelligent Merging (Song & Link)
             const songNameKey = keys.find(k => /^(song|hymn|worship|praise|詩歌|敬拜|讚美|領詩|獨唱)$/i.test(k) && typeof item[k] === 'string' && !/(https?:\/\/|www\.)/.test(item[k]));
             const linkKey = keys.find(k => /^(link|url|video|youtube|連結|網址)$/i.test(k) && typeof item[k] === 'string' && /(https?:\/\/|www\.)/.test(item[k]));

             if (songNameKey && linkKey) {
                 const urlMatch = item[linkKey].match(/(https?:\/\/[^\s]+)|(www\.[^\s]+)/);
                 if (urlMatch) {
                     let url = urlMatch[0];
                     if (url.startsWith('www.')) url = 'https://' + url;
                     url = url.replace(/[\)\]\}\>]+$/, '');
                     buttonsArray.push({ type: 'link', url: url, text: item[songNameKey] });
                     skipKeys.push(songNameKey);
                     skipKeys.push(linkKey);
                 }
             }

             // 2. Process remaining keys
             keys.forEach(k => {
                 if (k === titleKey || /date|time/.test(k)) return;
                 if (skipKeys.includes(k)) return; 
                 const val = item[k];
                 const isBibleKey = /scripture|reading|bible|chapter|ref|經文|讀經/i.test(k);
                 if (isBibleKey) return; // Skip explicit bible keys

                 const hasUrl = typeof val === 'string' && /(https?:\/\/[^\s]+)|(www\.[^\s]+)/.test(val);
                 if (hasUrl) {
                      // URL button logic (simplified)
                      buttonsArray.push({ type: 'link', url: val, text: k });
                 } else {
                      contentHtml += `<p class="whitespace-pre-wrap">${val}</p>`;
                 }
             });
             
             contentHtml += `</div>`; 
             
             if (buttonsArray.length > 0) {
                 contentHtml += `<div class="mt-10 pt-6 border-t border-[rgba(107,142,35,0.2)] w-full flex flex-col gap-4 items-center">`;
                 buttonsArray.forEach(btn => {
                      contentHtml += `
                        <a href="${btn.url}" target="_blank" class="w-full max-w-md block group">
                            <div class="bg-[#6B8E23] hover:bg-[#556B2F] text-white rounded-2xl py-3 px-4 text-center shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 transform group-hover:-translate-y-0.5 overflow-hidden">
                                <span class="text-sm font-light opacity-90 mr-1 whitespace-nowrap flex-shrink-0">今日點播</span>
                                <span class="text-lg font-medium tracking-wide truncate border-b border-white/30 pb-0.5 max-w-[160px] sm:max-w-xs">${btn.text}</span>
                                <i data-lucide="headphones" class="w-5 h-5 flex-shrink-0 ml-1"></i>
                            </div>
                        </a>`;
                 });
                 contentHtml += `</div>`;
             }
             return contentHtml;
        }

        // Show Full Schedule Logic
        function showFullSchedule() {
             const c = document.getElementById('daily-content');
             const sorted = window.sortedDevotionals || [];
             let h = '<div class="space-y-2 text-left w-full max-w-lg mx-auto">';
             sorted.forEach((i, idx) => {
                 let k = Object.keys(i).find(key => /date|time/.test(key)), d = extractMonthDay(i[k]);
                 let tKey = Object.keys(i).find(key => /title|name/.test(key)), t = i[tKey] || 'Untitled';
                 h += `<div onclick="renderSpecificItem(${idx})" class="p-3 border rounded cursor-pointer hover:bg-[rgba(255,255,255,0.4)] flex justify-between bg-[rgba(255,255,255,0.2)]"><span>${d}</span> <span>${t}</span></div>`;
             });
             h += '</div><div class="text-center mt-4"><button onclick="resetDailyView()" class="nature-btn">返回今日</button></div>';
             c.innerHTML = h;
             if(window.lucide) lucide.createIcons();
        }
        
        function renderSpecificItem(idx) {
             const item = (window.sortedDevotionals || [])[idx];
             const container = document.getElementById('daily-content');
             container.innerHTML = generateSingleDevotionalHtml(item) + '<div class="text-center mt-6"><button onclick="showFullSchedule()" class="nature-btn">返回列表</button></div>';
             if(window.lucide) lucide.createIcons();
        }

        function resetDailyView() { renderDailyDevotional(devotionalsData); }

        // Bible Modal Logic (Simplified for Daily Page)
        async function initBibleDB() {
            if (db) return db;
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm` });
                const response = await fetch(BIBLE_DB_URL);
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));
                return db;
            } catch (e) { console.error(e); return null; }
        }

        async function openScripture(reference) {
            const modal = document.getElementById('bible-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            
            modal.classList.add('show');
            modalBody.innerHTML = '<div class="flex justify-center py-4"><i data-lucide="loader-2" class="animate-spin w-6 h-6"></i></div>';
            modalTitle.innerText = reference;
            if(window.lucide) lucide.createIcons();

            // 為了保持輕量，這裡不實作完整的資料庫搜尋，而是引導去圖書館
            // 或是若有 DB，可以做簡單顯示 (但需複製 Library 的 parseBibleReference 邏輯)
            // 這裡採用「引導式」策略，讓通識中心專注於靈修
            
            modalBody.innerHTML = `
                <div class="text-center py-6">
                    <p class="mb-4 text-[#585858]">您正在查看今日的讀經進度：<br><span class="font-bold text-[#6B8E23] text-xl">${reference}</span></p>
                    <p class="text-sm text-gray-500 mb-6">如需閱讀完整經文，請前往圖書館。</p>
                    <a href="../library/index.html" class="nature-btn inline-flex">
                        前往圖書館 <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                    </a>
                </div>
            `;
             if(window.lucide) lucide.createIcons();
        }

        function closeBibleModal(event) {
            if (event && event.target.closest('.modal-content') && event.target.id !== 'bible-modal') return;
            document.getElementById('bible-modal').classList.remove('show');
        }

        init();
    </script>
</body>
</html>