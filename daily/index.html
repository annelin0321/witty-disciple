<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´» | é€šè­˜ä¸­å¿ƒ</title>
    <link rel="icon" href="../assets/images/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="../assets/images/favicon.svg">
    <meta name="apple-mobile-web-app-title" content="æ©Ÿæ™ºé–€å¾’">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>
<body class="pb-20">
    
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-white/60 to-transparent pointer-events-none"></div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="nature-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 max-w-5xl">
            <div class="flex flex-col md:flex-row justify-between items-center py-3">
                 <div class="flex items-center gap-3 mb-4 md:mb-0 group cursor-pointer" onclick="window.location.href='../index.html'">
                    <div class="w-10 h-10 hover:scale-110 transition-transform">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="48" fill="#FDFBF7" stroke="#6B8E23" stroke-width="2"/>
                            <circle cx="50" cy="35" r="18" fill="#6B8E23" opacity="0.9"/>
                            <circle cx="35" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <circle cx="65" cy="45" r="12" fill="#6B8E23" opacity="0.8"/>
                            <path d="M50 35 L 50 75" stroke="#8D7B68" stroke-width="4" stroke-linecap="round"/>
                            <path d="M35 45 L 65 45" stroke="#8D7B68" stroke-width="3" stroke-linecap="round"/>
                            <path d="M25 72 Q 50 82 75 72" stroke="#8D7B68" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                            <path d="M50 82 L 50 72" stroke="#8D7B68" stroke-width="1.5"/>
                        </svg>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-lg font-serif font-bold text-[#3E3B39]">æ©Ÿæ™ºçš„é–€å¾’ç”Ÿæ´»</span>
                    </div>
                </div>
                <div class="flex flex-wrap justify-center gap-1">
                    <a href="../index.html" class="nav-item font-bold text-[#6B8E23]">
                        <i data-lucide="home" class="w-4 h-4"></i> å›é¦–é 
                    </a>
                    <div class="w-px h-6 bg-gray-300 mx-2 self-center"></div>
                    <a href="index.html" class="nav-item active">é€šè­˜ä¸­å¿ƒ</a>
                    <a href="../library/index.html" class="nav-item">åœ–æ›¸é¤¨</a>
                    <a href="../chaplain/index.html" class="nav-item">æ ¡ç‰§å®¤</a>
                    <a href="../school/index.html" class="nav-item">å­¸éœ¸é¤Šæˆç­</a>
                    <a href="../games/index.html" class="nav-item">èª²å¤–æ´»å‹•</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-4xl">
        <div id="loading" class="flex flex-col items-center justify-center py-20 text-[#8D7B68]">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-4 text-[#6B8E23]"></i>
            <p class="text-sm tracking-widest">æ­£åœ¨æº–å‚™ä»Šæ—¥çš„éˆç³§...</p>
        </div>

        <div id="main-content" class="min-h-[500px] opacity-0 transition-opacity duration-1000">
            <section id="section-today" class="page-section fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-serif text-[#3E3B39] mb-2">é€šè­˜ä¸­å¿ƒ</h1>
                    <p class="eng-script text-[#8D7B68]">Daily Manna</p>
                </div>
                <div class="stationery-card">
                    <div id="daily-content" class="flex flex-col items-center justify-center text-center w-full"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal (ä¿®æ­£ç‰ˆ) -->
    <div id="bible-modal" onclick="closeBibleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <!-- ä¿®æ­£ï¼šèª¿æ•´æŒ‰éˆ•ä½ç½® (top-4 right-4) -->
            <button onclick="closeBibleModal()" class="absolute top-4 right-4 flex items-center justify-center gap-1 text-xs text-[#6B8E23] hover:text-[#556B2F] bg-[#F1F3F2] px-3 py-1.5 rounded-full z-50 border border-[#6B8E23]/20 shadow-sm">
                <i data-lucide="x" class="w-3 h-3"></i> é—œé–‰
            </button>
            <div class="text-center mb-6 mt-2">
                <!-- ä¿®æ­£ï¼šåŠ å…¥ px-12 é˜²æ­¢æ–‡å­—è¢«æŒ‰éˆ•é®æ“‹ -->
                <h3 id="modal-title" class="text-2xl font-serif text-[#3E3B39] font-bold px-12 leading-tight"></h3>
                <div class="w-12 h-px bg-[#8D7B68] mx-auto mt-3"></div>
            </div>
            <div id="modal-body" class="text-lg text-[#4e342e] leading-relaxed"></div>
        </div>
    </div>

    <script>
        const DEVOTION_DATA_URL = 'https://raw.githubusercontent.com/annelin0321/witty-bible-data/main/devotionals.json';
        const READING_PLAN_URL = '../assets/data/reading-plan.json'; 
        const BIBLE_DB_URL = 'https://raw.githubusercontent.com/annelin0321/bible-zh/main/bible_complete.db';
        
        let devotionalsData = [];
        let bibleReadingPlan = {}; 
        let isPlanLoadedFromFile = false; 
        
        let db = null;
        let isDbLoading = false;
        let dbCols = {};

        async function initBibleDB() {
            if (db) return db;
            if (isDbLoading) return new Promise(resolve => {
                const check = setInterval(() => { if(db || !isDbLoading) { clearInterval(check); resolve(db); } }, 100);
            });
            isDbLoading = true;
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm` });
                const response = await fetch(BIBLE_DB_URL);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const buffer = await response.arrayBuffer();
                db = new SQL.Database(new Uint8Array(buffer));
                
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'")[0].values;
                let validTable = tables.find(t => /bible|verse|scripture/i.test(t[0]));
                if (!validTable) validTable = tables.find(t => t[0] !== 'sqlite_sequence');
                const tableName = validTable ? validTable[0] : tables[0][0];
                
                const cols = db.exec(`PRAGMA table_info(${tableName})`)[0].values.map(r=>r[1]);
                dbCols = {
                    tableName: tableName,
                    book: cols.find(c => /book|b|æ›¸|vol/i.test(c)) || cols[0],
                    chap: cols.find(c => /chapter|chap|c|ç« /i.test(c)) || cols[1],
                    ver: cols.find(c => /verse|v|ç¯€/i.test(c)) || cols[2],
                    text: cols.find(c => /lection|content|text|scripture|ç¶“æ–‡|ç¶“æ–‡/i.test(c)) || cols[cols.length - 1]
                };
                return db;
            } catch (err) { console.error("DB Error", err); return null; } finally { isDbLoading = false; }
        }

        // æ›¸å·åç¨±ä¿®æ­£è¡¨
        function normalizeBookName(bookName) {
            const map = {
                "å‰µä¸–ç´€": "å‰µä¸–è¨˜", "å•“ç¤ºéŒ„": "å•Ÿç¤ºéŒ„", "ä½¿å¾’è¡Œå‚…": "ä½¿å¾’è¡Œå‚³",
                "ç¾…é¦¬æ›¸æ›¸": "ç¾…é¦¬æ›¸", "ç´„ç¿°è¤”éŸ³": "ç´„ç¿°ç¦éŸ³", "å½ŒåŠ æ›¸": "å½Œè¿¦æ›¸"
            };
            return map[bookName] || bookName;
        }

        function parseBibleReference(text) {
            if (!text) return null;
            text = text.replace(/[\(\)\uff08\uff09]/g, ' ').replace(/ï¼š/g, ':').trim();
            const bookPat = "([1-3]?\\s?[\\u4e00-\\u9fa5]{1,15}|[1-3]?\\s?[a-zA-Z]+)";
            const chapVersePat = "(\\d+)\\s*:\\s*(\\d+)(?:\\s*[-â€“~]\\s*(\\d+))?";
            
            // ä¿®æ­£æ›¸å·å
            let matchBook = text.match(new RegExp(bookPat));
            if (matchBook) {
                const originalBook = matchBook[0].trim();
                const fixedBook = normalizeBookName(originalBook);
                if (originalBook !== fixedBook) text = text.replace(originalBook, fixedBook);
            }

            const cvRegex = new RegExp(`${bookPat}\\s*${chapVersePat}`, 'g');
            let match = null;
            while ((match = cvRegex.exec(text)) !== null) { 
                let lastMatch = match; 
                return { 
                    book: normalizeBookName(lastMatch[1].trim()), 
                    chapter: parseInt(lastMatch[2]), 
                    verse: parseInt(lastMatch[3]), 
                    endVerse: lastMatch[4] ? parseInt(lastMatch[4]) : parseInt(lastMatch[3]) 
                }; 
            }
            
            const chapRangePat = "(\\d+)\\s*[-â€“~]\\s*(\\d+)";
            const rangeRegex = new RegExp(`${bookPat}\\s*${chapRangePat}`, 'g');
            while ((match = rangeRegex.exec(text)) !== null) { 
                return { 
                    book: normalizeBookName(match[1].trim()), 
                    chapter: parseInt(match[2]), 
                    verse: 1, 
                    endVerse: null, 
                    endChapter: parseInt(match[3]) 
                }; 
            }

            const chapRegex = new RegExp(`${bookPat}\\s*(\\d+)\\s*$`, 'g'); 
            while ((match = chapRegex.exec(text)) !== null) { 
                return { 
                    book: normalizeBookName(match[1].trim()), 
                    chapter: parseInt(match[2]), 
                    verse: 1, 
                    endVerse: null 
                }; 
            }
            return null;
        }

        async function openScripture(reference) {
            reference = reference.replace(/\(.*\)/, '').trim();

            const modal = document.getElementById('bible-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            modal.classList.add('show');
            modalBody.innerHTML = `<div class="flex justify-center py-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-[#8D7B68]"></i></div>`;
            if(window.lucide) lucide.createIcons();

            const database = await initBibleDB();
            if (!database) { modalBody.innerHTML = `<p class="text-center text-red-500">è³‡æ–™åº«è®€å–ä¸­...</p>`; return; }

            try {
                const parsed = parseBibleReference(reference);
                const getSubtitle = () => {
                    if (!parsed) return reference;
                    let s = `${parsed.book} ç¬¬ ${parsed.chapter} ç« `;
                    if (parsed.endChapter) s += `-${parsed.endChapter} ç« `;
                    else if (parsed.endVerse && parsed.endVerse > parsed.verse) s += ` ${parsed.verse}-${parsed.endVerse} ç¯€`;
                    else if (parsed.verse && reference.includes(':')) s += ` ${parsed.verse} ç¯€`; 
                    return s;
                };

                const executeQuery = (query, subtitle) => {
                    try {
                        const res = database.exec(query);
                        if (res.length > 0) {
                            let html = '';
                            let currentChap = -1;
                            res[0].values.forEach(row => {
                                if (row.length === 3) { 
                                    const c = row[0], v = row[1], t = row[2];
                                    if (c !== currentChap && parsed?.endChapter) {
                                        html += `<div class="text-center my-4"><span class="bg-gray-200 px-3 py-1 rounded-full text-sm text-gray-600">ç¬¬ ${c} ç« </span></div>`;
                                        currentChap = c;
                                    }
                                    html += `<p class="verse-text"><span class="verse-num">${v}</span>${t}</p>`;
                                } else {
                                    const v = row[0], t = row[1];
                                    html += `<p class="verse-text"><span class="verse-num">${v}</span>${t}</p>`;
                                }
                            });
                            modalTitle.innerText = subtitle;
                            modalBody.innerHTML = html;
                            return true;
                        }
                        return false;
                    } catch(e) { console.error(e); return false; }
                };

                if (parsed) {
                    let query;
                    // ä½¿ç”¨ CAST AS INTEGER ç¢ºä¿æ•¸å­—æ¯”å°æ­£ç¢º
                    if (parsed.endChapter && parsed.endChapter > parsed.chapter) {
                         query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND CAST(${dbCols.chap} AS INTEGER) >= ${parsed.chapter} AND CAST(${dbCols.chap} AS INTEGER) <= ${parsed.endChapter} ORDER BY CAST(${dbCols.chap} AS INTEGER), CAST(${dbCols.ver} AS INTEGER)`;
                    } else if (parsed.endVerse && parsed.endVerse > parsed.verse) {
                        query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND ${dbCols.chap} = ${parsed.chapter} AND CAST(${dbCols.ver} AS INTEGER) >= ${parsed.verse} AND CAST(${dbCols.ver} AS INTEGER) <= ${parsed.endVerse} ORDER BY CAST(${dbCols.ver} AS INTEGER)`;
                    } else if (parsed.endVerse === null) {
                        if (!reference.includes(':')) {
                             query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND ${dbCols.chap} = ${parsed.chapter} ORDER BY CAST(${dbCols.ver} AS INTEGER)`;
                        } else {
                            query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND ${dbCols.chap} = ${parsed.chapter} AND ${dbCols.ver} = ${parsed.verse}`;
                        }
                    } else {
                        query = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND ${dbCols.chap} = ${parsed.chapter} AND ${dbCols.ver} = ${parsed.verse}`;
                    }

                    if (!executeQuery(query, getSubtitle())) {
                        const fallbackQuery = `SELECT ${dbCols.chap}, ${dbCols.ver}, ${dbCols.text} FROM ${dbCols.tableName} WHERE ${dbCols.book} LIKE '%${parsed.book}%' AND ${dbCols.chap} = ${parsed.chapter} ORDER BY CAST(${dbCols.ver} AS INTEGER)`;
                        if (!executeQuery(fallbackQuery, `${parsed.book} ç¬¬ ${parsed.chapter} ç«  (å®Œæ•´ç« ç¯€)`)) {
                             modalBody.innerHTML = `<p class="text-center py-6">æ‰¾ä¸åˆ°ç¶“æ–‡ï¼š${reference}<br><span class="text-sm text-gray-400">è«‹ç¢ºèªæ›¸å·åç¨±æ˜¯å¦æ­£ç¢º (è§£æ: ${parsed.book})</span></p>`;
                        }
                    }
                } else {
                    modalTitle.innerText = reference;
                    modalBody.innerHTML = `<p class="text-center py-6">ç„¡æ³•è§£æç¶“æ–‡æ ¼å¼</p>`;
                }
            } catch (e) { console.error(e); modalBody.innerHTML = `<p class="text-center text-red-500">è®€å–éŒ¯èª¤</p>`; }
        }

        function closeBibleModal(event) {
            if (event && event.target.closest('.modal-content') && event.target.id !== 'bible-modal') return;
            document.getElementById('bible-modal').classList.remove('show');
        }

        async function generateReadingPlan() {
            // å…§å»ºè³‡æ–™ (1/1~1/12)
            const hardcodedData = [
                { "date": "1-1", "old_testament": "å‰µä¸–è¨˜ 1-2", "new_testament": "é¦¬å¤ªç¦éŸ³ 1:1-25", "psalms": "è©©ç¯‡ 1:1-6", "proverbs": "ç®´è¨€ 1:1-6" },
                { "date": "1-2", "old_testament": "å‰µä¸–è¨˜ 3-4", "new_testament": "é¦¬å¤ªç¦éŸ³ 2:1-23", "psalms": "è©©ç¯‡ 2:1-6", "proverbs": "ç®´è¨€ 1:7-9" },
                { "date": "1-3", "old_testament": "å‰µä¸–è¨˜ 5-6", "new_testament": "é¦¬å¤ªç¦éŸ³ 3:1-17", "psalms": "è©©ç¯‡ 2:7-12", "proverbs": "ç®´è¨€ 1:10-19" },
                { "date": "1-4", "old_testament": "å‰µä¸–è¨˜ 7-8", "new_testament": "é¦¬å¤ªç¦éŸ³ 4:1-25", "psalms": "è©©ç¯‡ 3:1-8", "proverbs": "ç®´è¨€ 1:20-23" },
                { "date": "1-5", "old_testament": "å‰µä¸–è¨˜ 9-10", "new_testament": "é¦¬å¤ªç¦éŸ³ 5:1-26", "psalms": "è©©ç¯‡ 4:1-8", "proverbs": "ç®´è¨€ 1:24-28" },
                { "date": "1-6", "old_testament": "å‰µä¸–è¨˜ 11-12", "new_testament": "é¦¬å¤ªç¦éŸ³ 5:27-48", "psalms": "è©©ç¯‡ 5:1-6", "proverbs": "ç®´è¨€ 1:29-33" },
                { "date": "1-7", "old_testament": "å‰µä¸–è¨˜ 13-14", "new_testament": "é¦¬å¤ªç¦éŸ³ 6:1-34", "psalms": "è©©ç¯‡ 5:7-12", "proverbs": "ç®´è¨€ 2:1-5" },
                { "date": "1-8", "old_testament": "å‰µä¸–è¨˜ 15-16", "new_testament": "é¦¬å¤ªç¦éŸ³ 7:1-29", "psalms": "è©©ç¯‡ 6:1-5", "proverbs": "ç®´è¨€ 2:6-15" },
                { "date": "1-9", "old_testament": "å‰µä¸–è¨˜ 17-18", "new_testament": "é¦¬å¤ªç¦éŸ³ 8:1-34", "psalms": "è©©ç¯‡ 6:6-10", "proverbs": "ç®´è¨€ 2:16-22" },
                { "date": "1-10", "old_testament": "å‰µä¸–è¨˜ 19-20", "new_testament": "é¦¬å¤ªç¦éŸ³ 9:1-38", "psalms": "è©©ç¯‡ 7:1-5", "proverbs": "ç®´è¨€ 3:1-6" },
                { "date": "1-11", "old_testament": "å‰µä¸–è¨˜ 21-22", "new_testament": "é¦¬å¤ªç¦éŸ³ 10:1-25", "psalms": "è©©ç¯‡ 7:6-12", "proverbs": "ç®´è¨€ 3:7-8" },
                { "date": "1-12", "old_testament": "å‰µä¸–è¨˜ 23-24", "new_testament": "é¦¬å¤ªç¦éŸ³ 10:26-42", "psalms": "è©©ç¯‡ 7:13-17", "proverbs": "ç®´è¨€ 3:9-10" }
            ];
            
            hardcodedData.forEach(day => { bibleReadingPlan[day.date] = day; });

            try {
                const res = await fetch(`${READING_PLAN_URL}?t=${Date.now()}`);
                if (res.ok) {
                    const data = await res.json();
                    data.forEach(day => { bibleReadingPlan[day.date] = day; });
                    isPlanLoadedFromFile = true;
                }
            } catch (e) { }
        }

        async function init() {
            if(window.lucide) lucide.createIcons();
            window.openScripture = openScripture;
            await generateReadingPlan(); 
            
            try {
                const response = await fetch(DEVOTION_DATA_URL);
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').classList.remove('opacity-0');
                
                const c = { devotionals:[] };
                data.forEach(i => {
                    let t = ''; 
                    for(let k in i) if(/title|name/i.test(k)) t = i[k].toLowerCase();
                    if(!t.includes('éŠæˆ²')) c.devotionals.push(i); 
                });
                
                devotionalsData = c.devotionals;
                renderDailyDevotional(devotionalsData);
            } catch(e) { console.error(e); }
        }

        function renderDailyDevotional(items) {
            const container = document.getElementById('daily-content');
            const dObj = new Date();
            const m = dObj.getMonth() + 1;
            const d = dObj.getDate();
            const keySimple = `${m}-${d}`;
            const keyPadded = `${m.toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            
            let plan = bibleReadingPlan[keySimple] || bibleReadingPlan[keyPadded];
            const start = new Date(dObj.getFullYear(), 0, 0);
            const diff = dObj - start;
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            
            let html = '';

            // è®€ç¶“é€²åº¦
            if (plan) {
                html += `
                    <div class="mb-10 text-center w-full">
                        <div class="inline-block px-6 py-2 border-b-2 border-[#6B8E23] mb-6">
                            <h2 class="text-2xl font-serif text-[#3E3B39] tracking-widest">ä»Šæ—¥è®€ç¶“</h2>
                            <p class="text-xs text-[#8D7B68] uppercase mt-1">Date: ${plan.date} (Day ${dayOfYear})</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-3xl mx-auto px-2">
                            ${['old_testament', 'new_testament', 'psalms', 'proverbs'].map(k => plan[k] ? `
                                <button onclick="window.openScripture('${plan[k]}')" class="reading-plan-btn">
                                    <span class="label">${getLabel(k)}</span>
                                    <span class="content">${plan[k]}</span>
                                    <i data-lucide="book-open"></i>
                                </button>
                            ` : '').join('')}
                        </div>
                        <div class="text-[10px] text-gray-300 mt-4 text-center">
                            è³‡æ–™ä¾†æºï¼š${isPlanLoadedFromFile ? 'å¤–éƒ¨æª”æ¡ˆ' : 'å…§å»ºè³‡æ–™'}
                        </div>
                    </div>
                    <div class="divider-water opacity-50 mb-10 w-full"></div>
                `;
            } else {
                html += `
                    <div class="mb-10 text-center w-full">
                        <div class="p-6 bg-white/50 rounded-xl border border-dashed border-gray-300 inline-block">
                             <p class="text-gray-600 mb-2 font-bold">ğŸ“… ä»Šæ—¥ (${keySimple}) å°šç„¡è®€ç¶“é€²åº¦</p>
                             <p class="text-xs text-gray-400 text-left mt-2">è«‹ç¢ºèª assets/data/reading-plan.json å·²åŒ…å«æ­¤æ—¥æœŸã€‚</p>
                        </div>
                    </div>
                `;
            }

            // éˆä¿®æ–‡ç« 
            if(items.length > 0) {
                const index = dayOfYear % items.length;
                const todayItem = items[index];
                html += generateSingleDevotionalHtml(todayItem);
            } else {
                 html += `<div class="py-10 text-[#8D7B68]">ä»Šæ—¥æš«ç„¡é¡å¤–éˆä¿®æ–‡ç« </div>`;
            }
            container.innerHTML = html;
            if(window.lucide) lucide.createIcons();
        }
        
        function getLabel(key) {
            const map = {
                'old_testament': 'OLD TESTAMENT',
                'new_testament': 'NEW TESTAMENT',
                'psalms': 'PSALMS',
                'proverbs': 'PROVERBS'
            };
            return map[key] || key;
        }

        function generateSingleDevotionalHtml(item) {
             let contentHtml = `<div class="text-left w-full space-y-6 text-[#585858] font-light text-lg">`;
             let buttonsArray = []; 
             let skipKeys = []; 

             const keys = Object.keys(item);
             let titleKey = keys.find(k => /title|name|æ¨™é¡Œ|åç¨±/i.test(k)) || 'No Title';
             contentHtml += `<h2 class="text-2xl font-serif text-[#3E3B39] mb-4 text-center font-bold">${item[titleKey]}</h2>`;
             
             const songNameKey = keys.find(k => /^(song|hymn|worship|praise|è©©æ­Œ|æ•¬æ‹œ|è®šç¾)$/i.test(k));
             const linkKey = keys.find(k => /^(link|url|video|youtube|é€£çµ)$/i.test(k));

             if (songNameKey && linkKey && item[linkKey]) {
                 buttonsArray.push({ type: 'link', url: item[linkKey], text: item[songNameKey] });
                 skipKeys.push(songNameKey, linkKey);
             }

             keys.forEach(k => {
                 if (k === titleKey || /date|time/.test(k)) return;
                 if (skipKeys.includes(k)) return;
                 if (/scripture|reading|bible|chapter|ref|ç¶“æ–‡|è®€ç¶“|é€²åº¦/i.test(k)) return;

                 const val = item[k];
                 if (typeof val === 'string' && val.startsWith('http')) {
                      buttonsArray.push({ type: 'link', url: val, text: k });
                 } else {
                      contentHtml += `<p class="whitespace-pre-wrap">${val}</p>`;
                 }
             });
             
             contentHtml += `</div>`; 
             
             if (buttonsArray.length > 0) {
                 contentHtml += `<div class="mt-10 pt-6 border-t border-[rgba(107,142,35,0.2)] w-full flex flex-col gap-4 items-center">`;
                 buttonsArray.forEach(btn => {
                      contentHtml += `
                        <a href="${btn.url}" target="_blank" class="w-full max-w-md block group">
                            <div class="bg-[#6B8E23] hover:bg-[#556B2F] text-white rounded-2xl py-3 px-4 text-center shadow-md flex items-center justify-center gap-2">
                                <span class="text-sm font-light opacity-90">ä»Šæ—¥é»æ’­</span>
                                <span class="text-lg font-medium truncate max-w-[160px] sm:max-w-xs">${btn.text}</span>
                                <i data-lucide="headphones" class="w-5 h-5"></i>
                            </div>
                        </a>`;
                 });
                 contentHtml += `</div>`;
             }
             return contentHtml;
        }

        init();
    </script>
</body>
</html>
